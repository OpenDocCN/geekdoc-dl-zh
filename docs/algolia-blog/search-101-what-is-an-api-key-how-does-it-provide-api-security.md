# 了解什么是 API 密钥，如何使用它，以及它如何提供安全性

> 原文：<https://www.algolia.com/blog/engineering/search-101-what-is-an-api-key-how-does-it-provide-api-security/>

我们从标准定义开始:

> *T3【API key】API key 是用来标识和认证请求 API(应用编程接口)服务的应用或用户的字符串。*

在本文中，我们为好奇的人们(技术或非技术)分解了这个定义，他们想知道 API 密匙是什么和做什么的内幕，以及它是如何工作的。

## [](#an-api-key-is-the-secret-code-that-gets-you-inside)API 密匙是进入内部的秘密代码

### [](#identification-and-authentication)识别和认证

API 密钥是为其他应用程序提供服务的任何应用程序的标准安全机制。

虽然它们不是唯一的方法(API 可以使用 JWT，我们在这里写道: [API 密钥 vs JWT auth](https://www.algolia.com/blog/engineering/api-keys-vs-json-web-tokens/) ) *，* API 密钥是保护 API 最常用的方法。

[**谷歌地图 API**](https://developers.google.com/maps) 就是一个需要 API 密钥的 API 服务(“端点”)的例子。如果您给 Google 的 API 一个物理地址(比如说“纽约州纽约市主街 1001 号”)，API 将返回最有可能的位置的经纬度(40.73612474992504，-73.447321075)。但是，如果没有有效的 API 密钥，Google 不会回答您的请求。你需要特别许可。API 密钥让谷歌知道你是谁，你是否有权访问他们的地图服务。这称为身份验证(与授权相反，我们将在本文后面讨论授权。)

顺便说一下，为了理解这个机制是如何工作的，当我们写下 *“我们给 Google 的 API 一个地址”* ，或者 *“我们给 Google 发送一个 API 密钥”，* 我们指的是向 Google 服务器发送信息(通过类似 Post 和 Get 的 HTTP 请求方法 发出请求)并接收信息返回(得到响应)

总之:

> 如果开发者想要使用谷歌几乎详尽的世界地址列表来创建一个地图应用程序，他们需要首先与谷歌签约，并获得一个 API 密钥，以便有权使用他们的谷歌地图 API 服务。

### [](#not-all-apis-require-or-use-api-keys)不是所有的 API 都需要或者使用 API 键

一些 API 不需要 API 键。比如你用来看视频的 **Youtube URL** 其实就是一个不需要 API key 的 API 请求。所有人(不仅仅是开发者)都可以在世界任何地方、任何设备上免费使用它。也就是说， [Youtube 的 API](https://en.wikipedia.org/wiki/YouTube_API)还提供其他需要 API 密钥的服务，例如提供(私人或通常付费的)频道播放列表、评论历史、使用统计和数百个其他 Youtube 拥有的数据的信息。

### [](#ease-of-use-api-first-thinking)易用性:API 优先思维

任何 API 的一个核心问题是它的易用性。正如我们将在下面的安全上下文中重复的: **易用性对于 API 的使用是至关重要的。所有 API 优先的公司都希望在使用他们的 API 产品时将所有的摩擦最小化。** 这包括使访问他们的 API 变得容易和安全，这正是 API 密匙被设计来提供的。T50

## [](#api-keys-%e2%80%93-how-they-work%c2%a0)API 键——它们是如何工作的

如上所述，API 密钥使服务器能够识别试图访问其服务的任何开发者或应用程序(请求者 或用户)。一个 API 键还定义了一组 **访问权限** 。访问权限授权请求者采取特定的操作，并禁止其采取其他操作。

让我们进入细节。

### [](#your-api-key-is-a-unique-identifier-usually-a-long-string-of-characters)你的 API 键是一个唯一的标识符，通常是一长串字符

您的 API 密钥是由数字和字母组合而成的 **唯一标识符** 。有些还包含非字母数字字符。唯一标识符本身并不代表什么；它唯一的意义就是它的独特性。 **它类似于密码或秘密代码。**

API 密匙通常包含 64 个以上的字符，由创建 *通用唯一标识符* (通常称为[GUID](https://en.wikipedia.org/wiki/Universally_unique_identifier)s)的系统随机发生器生成。

### [](#getting-access-authentication-or-failure)接入:认证或失败

把 API 键想象成通过 API 访问应用程序的数据和功能的一种方式。每个 API 请求者向服务器发送一个唯一的标识符，服务器使用该标识符来确定( *认证* )请求服务的个人或应用程序是否有权这样做。

如果服务器不能验证 API 调用(请求)的请求者，它会发回一个失败响应。这是创建 API 密匙背后的基本思想:如果您使用的是服务器无法识别的密匙，那么您将无法使用该服务。

然而，如果服务器识别 API 密钥并认证密钥的持有者，则该用户有权使用该服务。

下一步是服务器向 *授权* 请求者做一件或多件事情。

### [](#authorization)授权

授权过程决定了请求者的 **权限** 和 **范围** 。授权定义了经过身份验证的请求者使用 API 的确切方式。它涉及到定义你的 *权限* (可以访问哪些功能和数据)和 *范围* (有多少数据，可以使用 API 多久等等)。

### [](#rights)权利

权利是关于你能做什么。如果请求者的 API 键包含搜索数据的权限，那么请求者可以 *读取* 数据来执行搜索。如果请求者有权 *写* 数据，那么请求者可以执行部分或全部写操作。写访问通常会有更多的细节。例如，请求者可能有权 *更新* 一个索引但无权 *删除* 记录。

也可以组合权限。例如，请求者可能既有读写能力，或者只是只读。通常，请求者有几个 API 来执行不同的操作。例如:

*   只读用于搜索
*   浏览和索引(添加、更新、删除)的读&写权限
*   **管理员权限** ，包含一切，包括创建其他 API

### [](#admin-rights)管理权限

每个 API 系统都有一个全局 API 键，它不仅允许读&写操作，还允许完全访问 API 可以做的任何事情。例如，管理 API 允许应用程序和用户采取元操作，如添加、删除或修改用户、标识符、权限和范围。

鉴于管理 API 密匙的强大功能，您会希望这个 API 密匙是完全安全的——也就是说，对公众是隐藏和锁定的。这同样适用于任何写级别的 API 键。根据使用情况，只读键可能更灵活。阅读商业敏感数据显然比在网站上搜索产品和电影需要更高的安全性。

### [](#scope)范围

一旦请求者有权做某事，API 就可以在该权限内限制或扩展请求者的能力。例如，如果请求者拥有更新索引的一般权限，API 键可以限制请求者只能访问某些索引。或者，API 键可以限定只读访问的范围，只允许请求者访问少量记录。

通过过滤掉某些 IP 地址，您可以使用 scope 来进一步提高安全性。您还可以设置一个有效时间，也许是每天一个请求，或者在 30 天内每天少量的请求。

最后，API 键可以提供基于过滤器的限制。例如，API 键可以允许用户只更新“衣服”或“食物”项目。或者它可以限制只读请求者执行预定义的搜索或过滤。

关于限制性 API 使用的最后一点，一个很好的例子是授予只读访问权限，但使用忽略敏感数据的过滤器对其进行限制。这增加了额外的安全性，允许请求者查看仅为公共查看而设计的数据。

但是安全性需要更多的讨论。

## [](#securing-the-api-key)获取 API 密钥

就安全性而言，一个 API 密钥只能到此为止。本质上，如果一个密钥被盗或泄露，就不再安全了。

### [](#a-stolen-or-leaked-api-key)一个被盗或泄露的 API 密钥

有人可以通过许多方式获得 API 密钥。黑客可以拦截请求，窃取密钥，然后将请求更改为更具破坏性的内容。或者，更常见的情况是，开发人员可能会通过将 API 密钥发送到互联网上而意外泄露该密钥，这样任何人都可以很容易地找到它。或者不小心推到了 Git 回购。或者写在餐巾纸上，放在餐厅的桌子上。

### [](#security-safeguards)安全保障

一些安全措施依赖于额外的安全检查。其中一些方法需要请求者做额外的工作，这降低了 API 的受欢迎程度。值得记住的是 API 101:

> *易用性对 API 的使用至关重要，所以你要尽量减少所有的摩擦。*

这里有一些安全保障措施，要求 *没有额外的开销* 或 API 用户的负担:

*   创建速率限制，控制 API 被调用的次数
*   创建其他限制或应用程序限制以最大限度地减少攻击
*   使用攻击检测方法发出意外行为、推荐人或已知攻击行为的信号
*   拒绝不合常规或损害隐私或数据的请求
*   如上所述，移除对非敏感数据的访问
*   定期手动创建或自动生成新的 API 密钥

技术说明:许多安全措施可以作为 API 请求中的参数添加到标题中。

以下是最流行的 API 安全技术，它们要求开发者做的不仅仅是提供一个 API 密钥:

*   使用一种特殊的 API 密钥，称为安全 API 密钥。
*   登录并使用用户 id 和密码。
*   使用认证令牌(例如，JWT 令牌)进行认证和授权。
*   加密。为此，用户必须拥有与 API 服务器相同的加密软件。加密软件将 API 密钥转换为不可读的数据，只有 API 服务器能够理解这些数据。

### [](#the%c2%a0-secured-api-key-providing-server-based-security-with-a-temporary-api-key)安全 API 密钥:用临时 API 密钥提供基于服务器的安全性

一个 [**安全的 API 密钥**](https://www.algolia.com/doc/guides/security/api-keys/#secured-api-keys) 包含了对标准 API 密钥的额外安全保护:(A)它是短暂的(即时创建的和临时的)；因此，不能在仪表板上看到以任何方式对其进行修改或管理。更重要的是，(b)它包含用户的 id——因此，只有一个用户可以使用这个密钥。

通常情况下，API 密匙都是生成一次，对于 *任何* 用户，都是终身不变的。然而，永久键有两个缺点:

*   一旦有人偷了钥匙，他们将能够使用它，直到盗窃被发现，钥匙被取走
*   如果您需要 10，000 个用户拥有唯一的密钥，您将需要创建并维护所有的用户。虽然您可以自动生成新的 API 键，但您几乎总是需要手动更改代码。

大多数生产级应用程序需要更安全、更易于管理的东西，而不需要任何额外的工作。

工作原理:安全 API 密钥通过将会话和/或用户 id 信息作为密钥生成的一部分来利用这些信息。本质上，密钥是通过将用户标识符与密钥的范围(例如，超时限制、安全过滤器)相结合而动态生成的。一旦生成了密钥，请求者必须总是发送生成的 API 密钥 *和* 其用户 id 和范围。然后，API 服务器将使用用户 id 和范围重新生成密钥，然后将其与用户发送的密钥进行比较。如果它们不同，那么这显然是一个黑客。

这种双重检查逻辑只是迈向更好安全性的一步。下一步是要求 API 用户登录。

### [](#logging-in-%e2%80%93-creating-api-keys-with-user-ids-passwords-jwt-tokens-oauth-and-openid)登录–使用用户 ID、密码、JWT 令牌、OAuth 和 OpenID 创建 API 密钥

我们在这里提到的最后一种安全方法需要 API 用户登录。在这种情况下，如果登录成功，API 服务器发出一个唯一的、不可读的 *令牌* ，API 用户在保持登录时必须使用该令牌。此外，令牌包括用户凭证，使得除用户之外的任何人都难以发送令牌。

因此，我们在两个重要方面改进了临时安全 API 密钥方法:

*   JWT 需要登录。
*   JWT 生成一个令牌，其值包含用户登录凭证的加密版本。这些用户凭证使得 API 服务器能够在每个 连续的 API 请求中使用 *对用户进行认证。*

了解更多关于 [JWT 令牌](https://www.algolia.com/blog/engineering/api-keys-vs-json-web-tokens/) 以及它与 API 密钥的不同之处。

## [](#designing-and-implementing-the-best-api-%e2%80%93-tracking-usage)设计和实现最佳 API——跟踪使用情况

我们已经讨论了 API 密匙的用途，它看起来像什么，它如何操作，以及使用 API 密匙能做什么和不能做什么。我们还讨论了一些关于安全性的细节。我们将结束另一个方面:跟踪 API 的使用和改进 API。

API 依靠用户体验来改进其设计和功能。一个想要在竞争日益激烈的 API 市场中提供绝对最好的 API 的公司，必须知道它的客户如何使用他们的 API。通过记录每个请求——哪些请求、请求的数量、每个请求的成功和失败，API 提供者将报告、调试和分析添加到 API 的设计和实现中。