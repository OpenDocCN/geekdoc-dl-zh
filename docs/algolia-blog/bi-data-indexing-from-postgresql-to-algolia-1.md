# 第 1 部分:使用 Algolia 从 PostgreSQL 进行商业智能数据索引——用例及建议的解决方案—

> 原文：<https://www.algolia.com/blog/engineering/bi-data-indexing-from-postgresql-to-algolia-1/>

我们邀请 Starschema 的朋友写一个结合使用 Algolia 和 PostgreSQL 的例子。请欣赏软件开发人员 Mátyás Budavári 的这一两部分系列！

如果您想直接跳到第二部分，在第二部分中介绍了实现，[点击这里](https://algolia.com/blog/engineering/bi-data-indexing-from-postgresql-to-algolia-2)。

* * *

大家好，我是 Mátyás，Starschema 的软件开发人员。这篇文章是关于我们的一个产品的审计，以及我们如何利用 [Algolia](https://www.algolia.com/) 的速度和分布式特性，让我们的版主在不访问底层 [PostgreSQL](https://www.postgresql.org/) 数据库的情况下搜索审计数据。

## [](#use-case)用例

我们的工具让企业合作伙伴的用户可以从不同的商业智能(BI)软件和其他资源中集中访问他们的所有报告。我们使用的最流行的 BI 工具是 [Tableau](https://www.tableau.com/) 和 [PowerBI](https://powerbi.microsoft.com/en-au/) 。BI 工具通过强大的交互式可视化来帮助交流、呈现和分析数据，甚至可以处理实时数据。管理多个数据源和控制面板通常是一种令人沮丧且耗时的体验，充斥着各种噪音，损害了获得洞察力的能力，并导致错误的决策。

我们开发了一项服务，通过让个人或团队能够管理定制的共享工作区并与之协作，来改进数据分析和演示流程。用户可以专注于分析数据和交流见解，而不必在应用程序之间来回切换和多次验证。这些报告的内容仍然由原始工具提供，我们在它们之上提供统一的体验。此外，我们的用户可以修改这些报告的可见名称，并添加额外的标签和其他元数据，使他们的团队更容易组织这些报告。

![Indexing Business Intelligence Data](img/7423164e5dedf5925f1daca6dfb9355e.png)

我们定期收集使用数据，这使我们能够根据用户的实际使用情况对应用程序进行微调。除了收集这些指标，我们还必须遵守安全要求。我们需要能够告诉谁可以在给定的时间访问特定的报告，以及在特定的时间范围内由谁在应用程序中进行了哪些更改。我们收集所谓的审计日志，以便能够提取这些信息。必须小心处理这些数据，只有拥有更高权限的人才能访问原始数据。

在最近的一个项目中，我们需要开发一个可选的扩展，将匿名化的审计日志信息提取到 PostgreSQL 数据库之外的一个外部位置，以便让内容经理团队快速访问这些数据。这些审计日志可能包含 JSON 元数据，很难用 PostgreSQL 设置高级搜索特性。最好将数据编入索引，这样可以加快查询速度。

## [](#what-we-need)**我们需要什么**

我们需要关于使用分布的数据，以呈现给 BI 报告的创建者。Tableau 和 PowerBI 都在它们的报告中提供了使用指标，但是我们希望以统一的方式显示使用信息。我们可以向他们展示如何通过我们的应用程序访问他们的内容的详细信息。

由于报告所有者经常想知道他们洞察力的高峰期，我们需要审计信息来查看谁通过我们的应用程序访问了哪些报告。

请注意，外部 BI 源以其特定的方式管理权限。因此，创建者需要在他们用来发布报告的工具中设置受众访问权限，我们同步这些信息，并且只有那些 BI 报告才会向给定用户显示他们可以访问的内容。

## [](#how-we-can-achieve-it)**我们怎样才能实现它**

我们主要在内部和受保护的网络中使用我们的应用程序。大多数时候，由于严格的政策，不可能连接专用的分析服务，所以我们将分析数据保存到我们的数据库中。然而，大多数时候，我们的分析团队无法访问数据库。我们不发送实际的用户数据和报告元数据。有时，我们可以发送匿名数据，并告诉他们在不同的介质中代表什么特定的标识符，如果它是相关的，并且我们被允许共享。

总之，我们需要一种方法来快速查询使用日志，而无需访问原始数据库。

我们决定使用 Algolia 作为搜索索引。我们不希望每次安装都托管、管理和维护我们的搜索索引服务，最好有一个管理集中的地方，我们可以在那里发送我们的数据。我们的焦点小组可以使用它根据发送到那里的数据编写他们需要的报告。

出于安全和对客户的尊重，这是一个选择加入的功能。

## [](#architecture)**架构**

我们应用程序的后端服务是用 [Golang](https://go.dev/) 编写的。我们将 BI 工具的连接信息和报告元数据以及使用信息存储在 PostgreSQL 数据库中。

我们的目标是找到尽可能接近数据库的解决方案。我们希望利用 PostgreSQL 提供的语言特性，而不需要任何扩展。虽然我们对运行与 Algolia 通信的小型微服务持开放态度，但我们不想过多修改我们的代码来支持这种数据收集。

要将我们的数据发送到 Algolia，我们需要在 PostgreSQL 之外编写某种代码。

我们希望将数据加载组件创建为一个单独的服务，其唯一目的是向索引发送数据。由于我们的用户和报告的隐私，我们不能暴露我们的数据库给上述外部审计师。我们只能给他们发送一组精选的信息。

## [](#proposed-solution)**拟定方案**

[![Indexing Business Intelligence data](img/b84624d2dfaf8783b0b4a3f96920c451.png)](https://blog-api.algolia.com/wp-content/uploads/2022/10/indexing-bi-data-3.png)

随着时间的推移，审计日志表会随着使用量的增加而变大。我们不想每次需要发送数据时都要查询整个日志表。拥有一个小的*队列*，处理数据负载会更好。每个日志行都是必要的，但是我们不能依赖这些小服务在任何时间点都可用。我们必须保存需要处理的行。

我们计划在 PostgreSQL 中创建一个**新表**,用于存储将要发送到 Algolia 的过滤数据。该表将充当后进先出队列，将新数据优先于旧数据。

在创建这个新的队列表时，我们可以将已经收集的数据发送到 Algolia。

我们的目标是**将触发器**指向源表，在每个 insert 语句中，PostgreSQL 过程将必要的字段复制到这个新表中。

我们计划**编写一个新的服务**,它定期读取新表，获取最后几项，并将它们发送给 Algolia。如果多个这样的迷你服务可以同时运行而不互相中断，并且独立地在队列上工作，那就更好了。

【T2![](img/7665551c18b687f25dcadc15cb213b7d.png)

在本系列文章的下一部分[中，我们将通过设置所需的触发器，播种一些随机测试数据，并最终设置生产者和消费者代码来处理从 PostgreSQL 到我们的 Algolia 索引的同步数据，从而将计划付诸实施。](https://algolia.com/blog/engineering/bi-data-indexing-from-postgresql-to-algolia-2)