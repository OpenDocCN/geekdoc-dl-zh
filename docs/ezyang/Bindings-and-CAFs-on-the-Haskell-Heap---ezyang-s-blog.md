<!--yml

category: 未分类

date: 2024-07-01 18:17:47

-->

# Haskell 堆上的绑定和 CAF：ezyang's 博客

> 来源：[`blog.ezyang.com/2011/05/bindings-and-cafs-on-the-haskell-heap/`](http://blog.ezyang.com/2011/05/bindings-and-cafs-on-the-haskell-heap/)

今天，我们讨论 Haskell 堆上的礼物如何*命名*，无论是通过顶层绑定、let 绑定还是参数。我们介绍了表达式现有等效交换，这突显了表达式在 Haskell 堆上也是延迟绑定。最后，我们解释了这种函数内的 let 绑定如何导致创建更多礼物，而不是常量应用形式（CAF），后者从执行的开始就存在于 Haskell 堆上。

当我们描绘 Haskell 堆上的礼物时，它们通常有名称。

我们一直对这些名称的来源有些保密。部分原因是因为大多数这些名称的来源很简单：它们只是 Haskell 程序中的顶层绑定：

```
y = 1
maxDiameter = 100

```

我们还有一些名称作为函数参数绑定的绑定名称。我们在讨论函数时也已经讨论过这些内容。您将一个标签插入到机器中，该标签是幽灵知道 `x` 的“真实”位置的方式：

```
f x = x + 3
pred = \x -> x == 2

```

所以如果我写 `f maxDiameter`，幽灵就知道无论在哪里看到 `x`，它都应该寻找 `maxDiameter`。但这个解释还有些漏洞。如果我写 `f (x + 2)`，`x + 2`的标签是什么？

一种看待这个问题的方式是用不同的方式重写这个函数：`let z = x + 2 in f z`，其中`z`是一个新的变量：在表达式中没有其他地方出现过的变量。所以，只要我们理解了`let`的作用，我们就理解了紧凑的`f (x + 2)`的作用。我称之为表达式现有等效交换。

但 `let` 究竟是做什么呢？

有时，完全与顶层绑定的工作相同。这些是常量应用形式（CAF）。

因此，我们只需将变量提升到全局堆中，为其赋予一些唯一名称，然后它就像原始情况一样。我们甚至不需要在对函数的后续调用中重新评估它。再次强调，关键区别在于自由变量（请参见帖子底部的术语表）：常量应用形式没有自由变量，而我们编写的大多数 `let` 绑定都有自由变量。

> *术语表*。即使您从未学过λ演算，*自由变量*的定义也非常有用。一个表达式的自由变量是指通过查看表达式无法得知其值的变量。在表达式 `x + y` 中，`x` 和 `y` 是自由变量。它们被称为*自由*变量，因为λ“捕获”它们：`\x -> x` 中的 `x` 不是自由的，因为它是由λ `\x ->` 定义的。形式上：
> 
> ```
> fv(x) = {x}
> fv(e1 e2) = fv(e1) `union` fv(e2)
> fv(\x -> e1) = fv(e1) - {x}
> 
> ```

如果我们有自由变量，事情就会变得有些棘手。所以这里有一个扩展漫画，解释了当你强制执行一个延迟绑定时会发生什么。

注意幽灵如何传递自由变量。当一个 thunk 保留未评估时，看重的是它的自由变量，因为这些是其他也保留未评估的 thunk。还值得重申的是，函数始终使用礼物的标签，而不是实际未打开的礼物本身。

规则非常简单，但交互可能会很复杂！

上次：[Grinch 是如何窃取 Haskell 堆的](http://blog.ezyang.com/2011/04/how-the-grinch-stole-the-haskell-heap/)

*技术注释。* 在编写严格的迷你语言时，一个常见的技巧是，在实现`let`时认识到它实际上是 lambda 应用的语法糖：`let x = y in z`与`(\x -> z) y`相同。但这在惰性语言中不起作用：如果`y`引用`x`怎么办？在这种情况下，我们有一个递归的 let 绑定，通常需要使用特殊的`let-rec`构造，需要一些变异。但在惰性语言中很容易：进行绑定永远不会评估等式的右侧，所以我可以随意设置每个变量。我还选择以相反的方式进行演示，因为我希望人们始终考虑名称。CAFs 没有名称，但从所有目的来看，它们是会被共享的全局数据，因此给它们命名是有用的，特别是在尝试调试与 CAF 相关的空间泄漏时。

或许`f (x + 2)`的更精确的翻译是`f (let y = x + 2 in y)`，但我觉得那看起来有点奇怪。抱歉。

此作品根据[知识共享署名-相同方式共享 3.0 未本地化许可协议](http://creativecommons.org/licenses/by-sa/3.0/)许可。
