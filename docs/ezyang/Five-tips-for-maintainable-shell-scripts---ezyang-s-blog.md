<!--yml

category: 未分类

date: 2024-07-01 18:18:25

-->

# 五个保持可维护 Shell 脚本的技巧 : ezyang’s 博客

> 来源：[`blog.ezyang.com/2010/03/five-tips-for-maintainable-shell-scripts/`](http://blog.ezyang.com/2010/03/five-tips-for-maintainable-shell-scripts/)

## 五个保持可维护 Shell 脚本的技巧

当我十七岁时，我写了我的[第一个 Shell 脚本](http://repo.or.cz/w/htmlpurifier-web.git/blob/136caa2d941e51e5a742df3b05fb3e596f778636:/releases/build.bat)。那是一个 Windows 批处理文件，小心地从网络上各种代码示例中摘录的片段。我已经体验过与 `pear.bat` 交互的 *绝妙* 乐趣，脚本编写并不是我喜欢的事情；“为什么不用一个*真正的*编程语言来写这个该死的东西！”（额外美味的是，“真正的编程语言”是 PHP。嘻。）

最终我转向了完全的 Unix 环境，随之开始广泛使用 bash。突然间，Shell 脚本变得更加有意义：你一直在日复一日地输入命令，不如把它们写成脚本！然而，Shell 脚本有个讨厌的小问题：它们是永远的；不管你喜不喜欢，它们已经成为维护代码的一部分。整个构建基础设施都建立在 Shell 脚本之上。它们像兔子一样繁殖；你必须小心这些小家伙。

这里有五个提示和技巧，当你将命令写入一个 Shell 脚本时，请记住，这些将使得长期维护变得更加愉快！

1.  学会并喜欢使用 `set`。几乎没有理由不使用 `-e` 标志，这会导致如果任何命令返回非零退出码，你的脚本会报错，并且 `-x` 可以通过在执行命令前打印出脚本正在执行的确切命令，帮你节省数小时的调试时间。启用这两个选项后，你在 Shell 脚本中得到了非常简单的“断言”：

    ```
    check_some_condition
    ! [ -s "$1" ]

    ```

    尽管如此，如果可能的话，你应该编写错误消息来陪伴它们。

1.  就因为你在终端时不定义子过程（或者你有吗？看看 `alias` 和朋友们）并使用 `C-r` 进行反向命令历史搜索，这并不意味着在你的 Shell 脚本中重复命令是可以接受的。特别是，如果你有一组可能单独放入脚本中的命令，但又觉得单独建立文件有点奇怪，可以像这样将它们放在子过程中：

    ```
    subcommand() {
      do_something_with "$1" "$2"
    }

    ```

    特别是，参数传递的行为与真实的 Shell 脚本完全一样，通常你可以把子命令当作它自己的脚本来处理；标准输入和输出的工作方式也符合你的预期。唯一的区别是 `exit` 会退出整个脚本，所以如果你想中断一个命令，应该使用 `return` 代替。

1.  Shell 脚本中的参数引用是一个奇怪而深奥的领域（虽然它不必如此；[查看沃尔德曼关于 shell 引用的笔记](http://www.mpi-inf.mpg.de/~uwe/lehre/unixffb/quoting-guide.html)）。简而言之，*总是*要用引号包裹将被插值的变量，除非你确实想要多个参数的语义。关于是否应该引用字面值，我的感觉参差不齐，最近我已经养成了不引用它们的恶习。

1.  信不信由你，shell 脚本具有函数式编程的倾向。例如，`xargs` 就是典型的“map”功能。然而，如果你将参数传递给的命令不接受多个参数，你可以使用这个技巧：

    ```
    pgrep bash | while read name; do
      echo "PID: $name"
    done

    ```

1.  Shell 脚本在命令式编程时感觉非常自然，并且在控制流程时大多保持这种方式。然而，对于任何数据处理来说，它绝对是一个*糟糕*的语言（例如：sed 和 perl 管道），你应该避免在其中进行过多的数据处理。在更合理的语言中创建实用脚本可以有效地使你的 shell 脚本更加优雅。
