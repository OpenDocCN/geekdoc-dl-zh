<!--yml

分类：未分类

日期：2024-07-01 18:18:06

-->

# HTML 净化宣言：ezyang’s blog

> 来源：[`blog.ezyang.com/2010/10/the-html-purification-manifesto/`](http://blog.ezyang.com/2010/10/the-html-purification-manifesto/)

最近我给 Greg Weber 发了一封电子邮件，关于他的[xss-sanitize](http://github.com/gregwebs/haskell-xss-sanitize)包，警告他在他自己的包中重用 pandoc 净化算法。他做出了回应（有很好的理由），指出仅仅警告并不是很有建设性！因此，这是我的回应，即“HTML 净化宣言”，HTML Purifier 遵循的准则，我认为这是任何工业级 HTML 净化库的先决条件。我承认这是一个难以遵循的宣言，并且我会讨论您何时可以不完全遵循它。

*宣言。*

使用语义化数据结构。

白名单和验证*一切*。

仅输出*所有*浏览器理解的内容。

* * *

*使用语义化数据结构。* 许多过滤器在处理阶段试图永远不建立 DOM 或标记化的 HTML 表示，出于性能原因。结果证明，这使得保护您的过滤器变得非常困难。考虑[XSS cheatsheet](http://ha.ckers.org/xss.html)：看看多少漏洞涉及非格式良好的 HTML。如果您要求将 HTML 转换为 DOM，然后再序列化输出，您几乎可以保证结果是格式良好的，并消除所有这些漏洞。

这必须应用于 HTML 中的所有子语言，而不仅仅是 HTML 本身。您还必须小心，确保您的序列化程序生成符合标准的输出。例如，HTML Purifier 本身的一个[漏洞](http://htmlpurifier.org/security/2008/http-protocol-removal)是由于对标准的松散遵守而引起的。正如其所述：

> HTML Purifier 的修复还会对 URI 的每个段落中的任何其他保留字符进行百分比编码。这实际上是一个先前确定的放宽标准遵从部分，严格执行规则消除了漏洞。

语义化数据结构还有助于实现额外功能，例如从文档中提取内容或将所有 URI 转换为绝对形式，并且极大地简化了验证和操作。这对于下一步也将至关重要。

* * *

*白名单和验证一切。* 白名单是一种被广泛接受的做法，在这里我不会多加强调。但是，其应用中存在微妙之处。为了理解宣言的第一部分，您需要理解*一切*的含义。乍一看，您可能需要白名单的明显内容是元素和属性。但是，如果您决定允许`href`属性，则需要确保白名单 URI 方案——要白名单的三件事情。而且最好您决定允许`style`属性！

更好的方法是采取不同的白名单方法：每次遇到属性时，找出其合理的值，并将其验证为白名单。认为不需要验证`height`？考虑到可以通过将图像的宽度和高度设置为 999999 来使不知情的 Windows 用户蓝屏的图像崩溃攻击。复杂的属性？它可能具有进一步的结构，因此将其扩展为适当的语义数据结构！（最明显的候选者是 URI 和 CSS 字符串。）您不一定需要在内存中创建这些结构（事实上，优化的实现会尽量避免这样做），但这确实使编写算法变得更加容易。此外，操作结果的语义结构比操作一堆字符串要容易得多。

这是一个相当庞大的问题，因为 HTML 中有如此多的元素和属性，而且这些元素中嵌入了许多子语言。但是，通过创建一个特定领域语言来帮助您声明性地指定语义，您可以显著简化问题：尽管当时我并不知道，但这正是 HTML Purifier 在其`HTMLModule`系统中采用的方法。

* * *

*只输出所有浏览器都能理解的内容。* 我曾经认为，符合标准就足以确保所有浏览器理解您的语法（大多数攻击的主要目标）。然而，有时浏览器根本不按标准解析。通常，模糊行为的荒野领域在标准的规定之外，但有时标准说应该发生 X，而 Internet Explorer 却做 Y。很诱人的是，只是把手举在空中，然后处理漏洞。

但由于这与标准不兼容，许多网页开发人员发现应该工作的东西却不起作用！对于 CSS，即使是 Internet Explorer 中最隐蔽的解析错误也已被一些网页开发人员碰到，并被记录在维基或编码为 CSS hack 中。尽管这些知识看似与安全问题无关，但对于编写 HTML 过滤器的人来说至关重要！它告诉您，特别是所有浏览器都理解的符合标准的 HTML 子集是什么。

* * *

*更实际的注意事项。* 每当我看到网络上出现一个新的 HTML 过滤器时，我都会对源代码应用以下三个检验标准（我甚至都不会尝试演示）：

1.  它是否使用 HTML 解析器或尝试进行一堆字符串转换？

1.  它有多少白名单？仅元素和属性？它如何处理属性的内容？

1.  过滤器是否显得有处理实际世界中问题的经验？

根据过滤器声称支持的内容，我对第二和第三标准的应用不那么严格：例如，一个不支持 CSS 的过滤器无需担心其相关的困难。在极端情况下，如果你只是为`<b>`和`<i>`编写过滤器，你可以不遵循这些建议而且没问题。但我怀疑用户总是希望拥有更多功能，你也将不可避免地开始添加新的元素和属性。因此，我也要判断源代码是否考虑过在这些方向上进行扩展。

*更多语言学上的注意。* 我使用“净化”一词，而不是“消毒”，因为“消毒”意味着病原体仅仅被使无害，而“净化”则意味着它们实际上已被完全去除。我认为后者的理念更为安全！

*结论。* 早些时候，我曾对其他 HTML 过滤器写下高度激烈的评论，试图过分推广我自己的产品。现在我避免直接比较；相反，我希望这份宣言能帮助那些对编写或改进自己过滤器感兴趣的人。
