<!--yml

category: 未分类

date: 2024-07-01 18:17:53

-->

# Grinch 如何窃取 Haskell 堆：ezyang’s 博客

> 来源：[`blog.ezyang.com/2011/04/how-the-grinch-stole-the-haskell-heap/`](http://blog.ezyang.com/2011/04/how-the-grinch-stole-the-haskell-heap/)

今天，我们来介绍一下 Grinch。

曾经是个糟糕而令人讨厌的角色，Grinch 已经改过自新。他仍然喜欢偷礼物，但现在他是道德的：只有当没有人再关心一个礼物时，他才会拿走。他是 Haskell 堆的*垃圾收集器*，在保持 Haskell 堆小（从而使我们的内存使用低）方面扮演着非常重要的角色——特别是因为函数式程序会生成*大量*垃圾。我们不是特别环保的一群人。

Grinch 在传统的命令式语言中也收集垃圾，因为这一过程基本上是相同的。（我们在此描述了使用 Cheney's 算法的复制收集。）Grinch 首先询问我们在堆中关心哪些对象（根）。他将这些对象移到新堆（疏散），其中将包含要保存的对象。然后，他逐个检查新堆中的对象，确保它们不指向旧堆中的其他对象。如果有的话，他也将这些礼物搬到新堆中（搜刮）。最终，他检查了新堆中的所有礼物，这意味着剩下的一切都是垃圾，他会把它拖走。

但 Haskell 堆和传统堆之间存在差异。

传统堆是所有礼物都已经打开的堆：只有未拆封的盒子和礼品卡，所以 Grinch 只需检查礼品卡引用的礼物，以决定还能搜刮什么其他东西。

然而，Haskell 堆中有未打开的礼物，并且困扰这些礼物的幽灵在关于它们知道的礼物时也非常敏感。所以 Grinch 必须与它们协商，并清除它们指向的任何礼物。

怎么会有礼物变成垃圾呢？在 Haskell 堆和传统堆中，如果我们告诉 Grinch 我们不再关心一个礼物（根集发生变化），那么这个礼物显然就成了垃圾。此外，如果编辑礼品卡使其指向不同的礼物，它曾指向的礼物也可能变得多余（突变）。但 Haskell 堆的独特之处在于：我们打开一个礼物（评估一个 thunk）后，幽灵就消失在虚空中，它的使命完成了。现在 Grinch 可能可以垃圾回收幽灵之前关心的那些礼物。

让我们回顾一下 Haskell 堆上一个礼物的生命周期，特别强调这个礼物与堆上其他礼物的关系。（这些阶段名称实际上是 GHC 堆分析中使用的。）

假设我们想通过保持堆中的礼物数量低来最小化内存使用。有两种方法可以做到这一点：我们可以减少我们关心的礼物数量，或者我们可以减少我们创建的礼物数量。前者对应于使礼物变得死掉，通常是通过打开礼物并释放任何现在不存在的幽灵关心的礼物来完成。后者对应于避免函数应用，通常是在不必要时不打开礼物。

那么，哪一种方法会导致较小的堆？这取决于情况！

并不是只有惰性导致堆上的空间泄漏。过度严格性也可能导致空间泄漏。修复已识别的空间泄漏的关键在于弄清楚情况是哪种情况。请注意：我已经说了很多关于堆上的空间泄漏，但我还没有触及一个困扰许多人的常见堆上的空间泄漏：堆栈上的空间泄漏。敬请关注。

上次：[函数生成 Haskell 堆](http://blog.ezyang.com/2011/04/functions-produce-the-haskell-heap/)

下次：[绑定和 Haskell 堆上的 CAFs](http://blog.ezyang.com/2011/05/bindings-and-cafs-on-the-haskell-heap/)

*技术注释.* 格林奇从一个堆到另一个堆移动礼物的比喻只有在我们假设有复制垃圾收集（GHC 也有紧凑型垃圾收集器，其运行方式不同）时才准确，还有一些细节被省略了（尤其是格林奇如何知道礼物已经移动到新堆中，以及格林奇如何跟踪他在新堆中的位置）。此外，“格林奇拖走垃圾礼物”的形象有些误导：我们只是覆盖旧的内存！此外，GHC 并不只有一个堆：我们有分代垃圾收集器，这实际上意味着有多个堆（格林奇频繁访问年轻堆而不是老堆）。

对于真正的垃圾收集器来说，礼品和礼品卡看起来完全相同：礼品卡只是指向构造信息表和一些指针字段的指针，而礼品（thunk）只是指向可执行代码信息表和其闭包变量字段的指针。对于将数据视为代码的 Haskell 来说，它们是一样的。在没有内置匿名函数的语言中，对于匿名函数的实现可能手动将其表示为指向静态函数代码和其参数附加空间的数据结构。毕竟，惰性值的评估只是一种受控的变异形式！

本作品根据 [知识共享署名-相同方式共享 3.0 未本地化版本许可协议](http://creativecommons.org/licenses/by-sa/3.0/) 授权。
