<!--yml

分类：未分类

日期：2024-07-01 18:17:27

-->

# 关于安全 Haskell 的不直观事实：ezyang's 博客

> 来源：[`blog.ezyang.com/2012/09/common-misconceptions-about-safe-haskell/`](http://blog.ezyang.com/2012/09/common-misconceptions-about-safe-haskell/)

## 关于安全 Haskell 的不直观事实

[安全 Haskell](http://www.haskell.org/ghc/docs/7.4.2/html/users_guide/safe-haskell.html) 是 GHC 的一种新的语言扩展，允许你在受信任的代码库之上运行不受信任的代码。关于安全 Haskell 的工作方式，有一些常见的误解。在这篇文章中，我希望帮助纠正其中的一些误解。

### [`system 'rm -Rf /' :: IO ExitCode`] 被安全 Haskell 所接受

虽然这里的 IO 动作肯定是不安全的，但 Safe Haskell 并不会因为这个表达式的类型明确表达了操作可能具有任意的副作用而拒绝它，你在受信任的代码库中的义务是不在 IO Monad 中运行不受信任的代码！如果你需要允许有限的输入/输出，你必须定义一个受限制的 IO Monad，这在手册中有描述。

### 安全 Haskell 程序可能会挂起

即使使用 `killThread`，也很容易通过创建一个 [非分配无限循环](http://hackage.haskell.org/trac/ghc/ticket/367) 来永久占用一个能力。这个 bug 已经开放了七年了，但我们认为这是 Safe Haskell 的一个主要缺陷，并正在寻找防止这种情况发生的方法。但目前的情况是，安全 Haskell 程序需要通过操作系统级别的措施来控制，而不仅仅是 Haskell 的线程管理协议。

### 用户可能不信任 `Trustworthy` 模块

`Trustworthy` 关键字用于标记那些使用不安全语言特性和/或以“安全”方式使用的模块。这种安全性由维护者保证，其会将此语言扩展插入到模块文件的顶部。购买者请注意！毕竟，并没有理由相信一个维护者一定会这样宣称。因此，你可以通过 `ghc-pkg` 数据库或 `-trust` 标志信任一个包。但 GHC 也允许你相信包的维护者的说法，事实上，默认情况下就是这样；要使其不可信，你必须传递 `-fpackage-trust`。总之：

| 模块是否受信任？ | （无标志） | `-fpackage-trust` |
| --- | --- | --- |
| 包是否不受信任 | 是 | 否 |
| 包是否受信任 | 是 | 是 |

如果你认真使用安全 Haskell 来运行不受信任的代码，你应该始终使用 `-fpackage-trust`，并仔细将你的数据库中的包标记为受信任的状态。如果你只是把安全 Haskell 当作一种强制代码风格的方式，那么默认设置是相当不错的。

### 显式不信任对于维护封装性是重要的

Safe Haskell 提供了安全推断，通过检查模块是否可以使用 `-XSafe` 标志进行编译来自动确定模块是否安全。推断为安全的模块可以自由地被不受信任的代码使用。现在，假设这个模块（推断为安全）实际上是 `Data.HTML.Internal`，它导出了内部数据类型的构造器，允许用户违反数据结构的内部不变性（例如转义）。这看起来并不是很安全！

这种安全性的含义是微妙的：受信任代码库的正确性不能依赖于不受信任代码提供的任何不变量。例如，如果不受信任的代码定义了其自己有缺陷的二叉树实现，那么捕捉不受信任代码的错误不在 Safe Haskell 使命的范围内。但是，如果我们的 TCB（Trusted Computing Base）期望一个经过适当转义的 `HTML` 值，且没有嵌入的 JavaScript，那么违反此类型的封装性可能意味着不受信任的代码可以注入 XSS 攻击。

David Terei 和我对于在包边界方面使信任表达更加灵活有一些想法，但是我们对于正确的设计尚未达成一致意见。（希望我们能尽快做出决定！）

### 结论

Safe Haskell 本质上是一个非常简单的想法，但是有一些尖锐的边缘，特别是当 Safe Haskell 要求你进行 Haskell 程序中通常不会做的区分时。不过，Safe Haskell 相当独特：虽然确实存在广泛使用的沙盒编程语言（比如 Java 和 JavaScript），但 Safe Haskell 更进一步，允许你指定自己的自定义安全策略。结合一个与此功能良好兼容的大规模库生态系统，你将拥有一个在编程语言领域中真正独一无二的系统。
