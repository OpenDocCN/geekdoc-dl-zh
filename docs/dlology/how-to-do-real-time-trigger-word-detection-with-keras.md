# 如何使用 Keras 进行实时触发词检测

> 原文：<https://www.dlology.com/blog/how-to-do-real-time-trigger-word-detection-with-keras/>

###### 发帖人:[程维](/blog/author/Chengwei/) 4 年 10 个月前

([评论](/blog/how-to-do-real-time-trigger-word-detection-with-keras/#disqus_thread))

![on air](img/cd463a19e8142a01756f214604c7fb53.png)

这周刚完成 [Coursera 深度学习在线课程](https://www.coursera.org/specializations/deep-learning)。最后一个编程作业是关于触发字检测，又名。唤醒/热词检测。就像你对着亚马逊 Alexa 或者 Google Home 大喊大叫把他们吵醒一样。

![sparta alexa](img/739f8ae8c50600d54732efb9da3c0b90.png)

自己造一个然后在**实时**运行会不会很酷？

在这篇文章中，我将向您展示如何构建一个 Keras 模型来从头开始做同样的事情。不需要第三方语音 API 或网络连接来使其正常工作。

Coursera 课程中展示了大量的背景信息。如果你是新手，不要担心，我将有一个足够的概述，让你明白接下来会发生什么。

## 准备训练数据集

为了简单起见，我们把单词“**激活**作为我们的触发词。

训练数据集需要尽可能与真实的测试环境相似。例如，在训练期间，模型需要暴露于语音中的非触发单词和背景噪声，因此当我们说其他单词或只有背景噪声时，它不会生成触发信号。

如你所料，训练一个好的语音模型需要大量的带标签的训练样本。我们是否只需记录每段音频并标记触发词的位置？这里有一个简单的窍门来解决这个问题。

我们创造了它们！

首先，我们有三种录音，

1.不同背景的录音。它们可能只是简单的两个背景噪音片段，每个 10 秒钟，咖啡店和起居室。

2.触发词“激活”的录音。他们可能只是你用不同的语调把这个词说了 10 遍，每次 1 秒钟。

3.负面词汇的录音。他们可能是你在说其他的词，比如“宝贝”，“咖啡”，每段录音一秒钟。

这是生成训练输入音频剪辑的步骤，

*   随机选取一个 10 秒钟的背景音频剪辑
*   随机**叠加** 0-4 个“激活”的音频片段到这个 10 秒的片段中
*   随机**叠加** 0-2 个负面词汇的音频片段到这个 10 秒的片段中

我们选择**叠加**,因为我们想把口语和背景噪音混合起来，听起来更真实。

对于输出标签，我们希望它表示某人是否刚刚说完“激活”。

我们首先将输出标签的所有时间步长初始化为“0”。然后，对于我们覆盖的每个“激活”,我们还通过将后续的 50 个时间步长分配为“1”来更新目标标签。

为什么我们有 50 个时间步长“1”？

因为如果我们只在“激活”之后设置 1 个时间步长为“1”，那么目标标签中会有太多的 0。它创建了一个非常不平衡的训练集。

拥有 50 个“1”有点麻烦，但可以让他们更容易训练模型。这里有一幅插图向你展示这个想法。

![target label diagram](img/1612c7fee5b90a86ecd26ddd0ecce5d4.png)

*学分:Coursera - deeplearning.ai*

对于我们插入了“激活”、“无辜”、“激活”、“宝贝”的片段。请注意，阳性标签“1”仅与阳性单词相关联。

绿色/蓝色图是声谱图，是声波随时间变化的频率表示。x 轴是时间，y 轴是频率。颜色越黄/亮，特定频率越活跃(响亮)。

我们的输入数据将是每个生成音频的声谱图数据。目标将是我们之前创建的标签。

## 建立模型

没有进一步的预定，让我们来看看模型结构。

![trigger word model](img/10a794e8acf29e964c3ca6bb410e46de.png)

1D 卷积步长输入频谱图的 5511 时间步长(10 秒)，输出 1375 步长输出。它提取低级音频特征，类似于 2D 卷积提取图像特征的方式。还通过减少时间步长的数量来帮助加速模型。

两个 GRU 层从左到右读取输入序列，最终使用密集的+乙状结肠层进行预测。乙状结肠使每个标签的范围在 0~1 之间。为 1，对应刚才用户说“激活”。

这里是 Keras 的 functional API 中用写的代码。

触发词检测需要很长时间的训练。为了节省时间，Coursera 已经使用上面显示的架构和大约 4000 个例子的大型训练集，在 GPU 上训练了一个模型大约 3 个小时。让我们加载模型。

## 实时演示

到目前为止，我们的模型只能拍摄 10 秒钟的静态音频片段，并预测触发词的位置。

有趣的部分来了，我们换成现场音频流吧！

我们建立的模型期望 10 秒钟的音频剪辑作为输入。而训练另一个需要较短音频剪辑的模型是可能的，但需要我们在 GPU 上重新训练模型几个小时。

我们也不想等待 10 秒钟，因为模型会告诉我们触发词已被检测到。因此，一种解决方案是设置一个移动的 10 秒音频流窗口，步长为 0.5 秒。这意味着我们要求模型每 0.5 秒预测一次，这样可以减少延迟并提高响应速度。

我们还添加了静音检测机制，以便在响度低于阈值时跳过预测，这可以节省一些计算能力。

**让我们看看如何构建它，**

输入的 10 秒音频每 0.5 秒更新一次。这意味着每 0.5 秒，最老的 0.5 秒音频块将被丢弃，新的 0.5 秒音频将被移入。该模型的工作是判断在新的 0.5 秒音频块中是否检测到新的触发字。

这是实现它的代码。

为了获得音频流，我们使用了 **pyaudio** 库。其具有异步读取音频流的选项。这意味着音频流记录发生在另一个线程中，当新的固定长度的音频数据可用时，它通知我们的模型在主线程中处理它。

你可能会问为什么不直接读取固定长度的音频，然后在一个函数中进行处理呢？

由于模型生成预测需要相当长的时间，有时需要几十毫秒。这样做的话，我们在进行计算时，可能会在音频流中产生间隙。

下面是 **pyaudio** 库的回调代码，在回调函数中我们发送一个队列通知模型在主线程中处理数据。

当你运行它时，它每 0.5 秒输出 3 个字符中的一个。

“-”表示沉默，

"."意味着不是沉默和没有触发词，

“1”表示检测到新的触发字。

```py
--.--......-1----.-..--...-1---..-------..1---------..-1---------.----.--------.----.---.--.-.------------.
```

当检测到触发字时，您可以随意将打印“1”字符替换为您希望发生的任何事情。启动应用程序，播放声音等。

## 总结和进一步阅读

本文演示了如何使用 Keras 深度学习框架从头开始构建一个实时触发词检测器。

**以下是你应该记住的:**

*   数据合成是为语音问题创建大型训练集的有效方法，特别是触发单词检测。
*   在将音频数据传送到 RNN、GRU 或 LSTM 之前，使用声谱图和可选的 1D conv 层是常见的预处理步骤。
*   可以使用端到端深度学习方法来构建非常有效的触发词检测系统。
*   深度学习模型预测需要时间。它异步处理来自输入音频流的音频数据,以避免中断音频流。
*   滑动/移动输入窗口是减少延迟的有效方法。

**延伸阅读**

[嘿 Siri:苹果个人助理的 DNN 语音触发装置](https://machinelearning.apple.com/2017/10/01/hey-siri.html)

[触发词检测讲座- Coursera](https://www.coursera.org/learn/nlp-sequence-models/lecture/Li4ts/trigger-word-detection)

现在，从 [my GitHub repo](https://github.com/Tony607/Keras-Trigger-Word) 获取完整的源代码，构建一个令人敬畏的触发字应用程序。

*   标签:
*   [深度学习](/blog/tag/deep-learning/)，
*   [keras](/blog/tag/keras/) ,
*   [教程](/blog/tag/tutorial/)

[Share on Twitter](https://twitter.com/intent/tweet?url=https%3A//www.dlology.com/blog/how-to-do-real-time-trigger-word-detection-with-keras/&text=How%20to%20do%20Real%20Time%20Trigger%20Word%20Detection%20with%20Keras) [Share on Facebook](https://www.facebook.com/sharer/sharer.php?u=https://www.dlology.com/blog/how-to-do-real-time-trigger-word-detection-with-keras/)

*   [←如何使用 Keras 生成真实的 yelp 餐厅评论](/blog/how-to-generate-realistic-yelp-restaurant-reviews-with-keras/)
*   [如何利用深度学习诊断电机的健康状况→](/blog/try-this-model-to-quickly-tell-if-it-is-a-faulty-motor-by-listening/)