# å¥–åŠ±æ¨¡å‹

å¥–åŠ±æ¨¡å‹åœ¨ç°ä»£å¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆå¼ºåŒ–ï¼ˆRLHFï¼‰æ–¹æ³•ä¸­å¤„äºæ ¸å¿ƒåœ°ä½ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å­¦ä¹ å¤æ‚äººç±»åå¥½çš„åœ°æ–¹ã€‚å®ƒä»¬ä½¿å¾—æˆ‘ä»¬çš„æ¨¡å‹èƒ½å¤Ÿä»éš¾ä»¥æŒ‡å®šçš„ä¿¡å·ä¸­å­¦ä¹ ã€‚å®ƒä»¬å°†æ•°æ®ä¸­çš„å¤æ‚ç‰¹å¾å‹ç¼©æˆå¯ä»¥åœ¨ä¸‹æ¸¸è®­ç»ƒä¸­ä½¿ç”¨çš„è¡¨ç¤ºâ€”â€”è¿™æ˜¯ä¸€ç§å†æ¬¡å±•ç¤ºç°ä»£æ·±åº¦å­¦ä¹ å¤æ‚å®¹é‡çš„é­”æ³•ã€‚è¿™äº›æ¨¡å‹ä½œä¸ºä»£ç†ç›®æ ‡ï¼Œé€šè¿‡ä»¥ä¸‹ç« èŠ‚ç ”ç©¶çš„æ ¸å¿ƒä¼˜åŒ–è¿‡ç¨‹ã€‚

å¥–åŠ±æ¨¡å‹åœ¨å†å²ä¸Šè¢«å¹¿æ³›ç”¨äºå¼ºåŒ–å­¦ä¹ ç ”ç©¶ï¼Œä½œä¸ºç¯å¢ƒå¥–åŠ±çš„ä»£ç† [[55]](ch021.xhtml#ref-sutton2018reinforcement)ã€‚åœ¨ç°ä»£å½¢å¼ä¸­ï¼Œå¥–åŠ±æ¨¡å‹è¢«æå‡ºä½œä¸ºä¸€ç§ç ”ç©¶ä»·å€¼å¯¹é½é—®é¢˜çš„å·¥å…· [[33]](ch021.xhtml#ref-leike2018scalable)ã€‚è¿™äº›æ¨¡å‹é€šå¸¸æ¥å—æŸç§å½¢å¼çš„è¾“å…¥ï¼Œå¹¶è¾“å‡ºä¸€ä¸ªå•ä¸€çš„å¥–åŠ±æ ‡é‡å€¼ã€‚è¿™ç§å¥–åŠ±å¯ä»¥æœ‰å¤šç§å½¢å¼â€”â€”åœ¨ä¼ ç»Ÿçš„å¼ºåŒ–å­¦ä¹ é—®é¢˜ä¸­ï¼Œå®ƒè¯•å›¾è¿‘ä¼¼é—®é¢˜çš„ç¡®åˆ‡ç¯å¢ƒå¥–åŠ±ï¼Œä½†åœ¨ RLHF ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¥–åŠ±æ¨¡å‹å®é™…ä¸Šè¾“å‡ºçš„æ˜¯æŸä¸ªè¾“å…¥â€œé«˜è´¨é‡â€çš„æ¦‚ç‡ï¼ˆå³åœ¨ä¸€å¯¹åå¥½å…³ç³»ä¸­é€‰æ‹©çš„ç­”æ¡ˆï¼‰ã€‚RLHF çš„å¥–åŠ±å»ºæ¨¡å®è·µä¸é€†å¼ºåŒ–å­¦ä¹ å¯†åˆ‡ç›¸å…³ï¼Œå…¶ä¸­é—®é¢˜æ˜¯åœ¨ç»™å®šè¡Œä¸ºè½¨è¿¹çš„æƒ…å†µä¸‹è¿‘ä¼¼ä»£ç†çš„å¥–åŠ±å‡½æ•° [[96]](ch021.xhtml#ref-ng2000algorithms)ï¼Œä»¥åŠå…¶ä»–æ·±åº¦å¼ºåŒ–å­¦ä¹ çš„é¢†åŸŸã€‚é«˜å±‚é—®é¢˜é™ˆè¿°æ˜¯ç›¸åŒçš„ï¼Œä½†å®ç°å’Œå…³æ³¨é¢†åŸŸå®Œå…¨ä¸åŒï¼Œå› æ­¤å®ƒä»¬é€šå¸¸è¢«è§†ä¸ºå®Œå…¨ä¸åŒçš„ç ”ç©¶é¢†åŸŸã€‚

æœ€å¸¸è§çš„å¥–åŠ±æ¨¡å‹ï¼Œé€šå¸¸ç§°ä¸ºå¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œå¥–åŠ±æ¨¡å‹ï¼Œä¹Ÿæ˜¯æœ¬ç« çš„ä¸»è¦ç„¦ç‚¹ï¼Œå®ƒé¢„æµ‹ä¸€æ®µæ–‡æœ¬æ¥è¿‘â€œé¦–é€‰â€æ–‡æœ¬çš„æ¦‚ç‡ï¼Œè¿™æ˜¯åŸºäºè®­ç»ƒæ¯”è¾ƒçš„ã€‚åœ¨æœ¬èŠ‚ç¨åï¼Œæˆ‘ä»¬è¿˜å°†å°†è¿™äº›æ¨¡å‹ä¸ç»“æœå¥–åŠ±æ¨¡å‹ï¼ˆORMsï¼‰ã€è¿‡ç¨‹å¥–åŠ±æ¨¡å‹ï¼ˆPRMï¼‰å’Œå…¶ä»–ç±»å‹çš„å¥–åŠ±æ¨¡å‹è¿›è¡Œæ¯”è¾ƒã€‚

*åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics>æ¥è¡¨ç¤ºæç¤ºï¼Œä½¿ç”¨<semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics>æ¥è¡¨ç¤ºå®Œæˆã€‚è¿™ç§ç¬¦å·åœ¨è¯­è¨€æ¨¡å‹æ–‡çŒ®ä¸­å¾ˆå¸¸è§ï¼Œå…¶ä¸­æ–¹æ³•æ“ä½œçš„æ˜¯å®Œæ•´çš„æç¤º-å®Œæˆå¯¹ï¼Œè€Œä¸æ˜¯å•ä¸ªæ ‡è®°ã€‚*

## è®­ç»ƒå¥–åŠ±æ¨¡å‹

å¥–åŠ±æ¨¡å‹çš„ç»å…¸å®ç°æºè‡ªäºå¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œåå¥½æ¨¡å‹ [[125]](ch021.xhtml#ref-BradleyTerry)ã€‚å¯¹äºå¦‚ä½•è®­ç»ƒæ ‡å‡†å¥–åŠ±æ¨¡å‹ï¼ŒRLHF æœ‰ä¸¤ç§æµè¡Œçš„è¡¨è¾¾æ–¹å¼â€”â€”å®ƒä»¬åœ¨æ•°å­¦ä¸Šæ˜¯ç­‰ä»·çš„ã€‚é¦–å…ˆï¼Œå¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œåå¥½æ¨¡å‹å®šä¹‰äº†åœ¨ä¸¤ä¸ªç‰©å“ <semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics> å’Œ <semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics> ä¹‹é—´çš„æˆå¯¹æ¯”è¾ƒä¸­ï¼Œä¸€ä¸ªè¯„åˆ¤è€…æ›´å–œæ¬¢ <semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics> è€Œä¸æ˜¯ <semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics> çš„æ¦‚ç‡ï¼š

<semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo>></mo><mi>j</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><msub><mi>p</mi><mi>i</mi></msub><mrow><msub><mi>p</mi><mi>i</mi></msub><mo>+</mo><msub><mi>p</mi><mi>j</mi></msub></mrow></mfrac><mi>.</mi><mrow><mo stretchy="false" form="prefix">(</mo><mn>11</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(i > j) = \frac{p_i}{p_i + p_j}.\qquad{(11)}</annotation></semantics>

å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œæ¨¡å‹å‡è®¾æ¯ä¸ªç‰©å“éƒ½æœ‰ä¸€ä¸ªæ½œåœ¨çš„å¼ºåº¦ <semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mo>></mo><mn>0</mn></mrow><annotation encoding="application/x-tex">p_i > 0</annotation></semantics>ï¼Œå¹¶ä¸”è§‚å¯Ÿåˆ°çš„åå¥½æ˜¯è¿™äº›æ½œåœ¨å¼ºåº¦çš„æœ‰å™ªå£°çš„åæ˜ ã€‚é€šå¸¸ä½¿ç”¨æ— ç•Œåˆ†æ•°é‡æ–°å‚æ•°åŒ–å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œæ¨¡å‹ï¼Œå…¶ä¸­ <semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><msup><mi>e</mi><msub><mi>r</mi><mi>i</mi></msub></msup></mrow><annotation encoding="application/x-tex">p_i = e^{r_i}</annotation></semantics>ï¼Œè¿™å¯¼è‡´ä»¥ä¸‹å½¢å¼ï¼š

<semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo>></mo><mi>j</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>r</mi><mi>i</mi></msub></msup><mrow><msup><mi>e</mi><msub><mi>r</mi><mi>i</mi></msub></msup><mo>+</mo><msup><mi>e</mi><msub><mi>r</mi><mi>j</mi></msub></msup></mrow></mfrac><mo>=</mo><mi>Ïƒ</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>r</mi><mi>i</mi></msub><mo>âˆ’</mo><msub><mi>r</mi><mi>j</mi></msub><mo stretchy="false" form="postfix">)</mo><mi>.</mi><mrow><mo stretchy="false" form="prefix">(</mo><mn>12</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(i > j) = \frac{e^{r_i}}{e^{r_i} + e^{r_j}} = \sigma(r_i-r_j).\qquad{(12)}</annotation></semantics>

åªæœ‰åˆ†æ•°çš„å·®å¼‚æ‰æ˜¯é‡è¦çš„ï¼šå¯¹æ‰€æœ‰<semantics><msub><mi>r</mi><mi>i</mi></msub><annotation encoding="application/x-tex">r_i</annotation></semantics>æ·»åŠ ç›¸åŒçš„å¸¸æ•°ä¸ä¼šæ”¹å˜<semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo>></mo><mi>j</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P(i > j)</annotation></semantics>ã€‚è¿™äº›å½¢å¼ä¸æ˜¯è‡ªç„¶æ³•åˆ™ï¼Œä½†å®ƒä»¬æ˜¯å¯¹äººç±»åå¥½çš„æœ‰ç”¨è¿‘ä¼¼ï¼Œåœ¨ RLHF ä¸­é€šå¸¸å·¥ä½œå¾—å¾ˆå¥½ã€‚

ä¸ºäº†è®­ç»ƒå¥–åŠ±æ¨¡å‹ï¼Œæˆ‘ä»¬å¿…é¡»åˆ¶å®šä¸€ä¸ªæ»¡è¶³ä¸Šè¿°å…³ç³»çš„æŸå¤±å‡½æ•°ã€‚åœ¨å®è·µä¸­ï¼Œè¿™æ˜¯é€šè¿‡å°†è¯­è¨€æ¨¡å‹è½¬æ¢ä¸ºè¾“å‡ºæ ‡é‡åˆ†æ•°çš„æ¨¡å‹æ¥å®Œæˆçš„ï¼Œé€šå¸¸æ˜¯é€šè¿‡ä¸€ä¸ªå°çš„çº¿æ€§å¤´éƒ¨æ¥äº§ç”Ÿå•ä¸ª logitã€‚ç»™å®šæç¤º<semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics>å’Œä¸¤ä¸ªé‡‡æ ·çš„å®Œæˆ<semantics><msub><mi>y</mi><mn>1</mn></msub><annotation encoding="application/x-tex">y_1</annotation></semantics>å’Œ<semantics><msub><mi>y</mi><mn>2</mn></msub><annotation encoding="application/x-tex">y_2</annotation></semantics>ï¼Œæˆ‘ä»¬ä½¿ç”¨å¥–åŠ±æ¨¡å‹<semantics><msub><mi>r</mi><mi>Î¸</mi></msub><annotation encoding="application/x-tex">r_\theta</annotation></semantics>å¯¹å®ƒä»¬è¿›è¡Œè¯„åˆ†ï¼Œå¹¶å°†æ¡ä»¶åˆ†æ•°å†™æˆ<semantics><mrow><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">r_\theta(y_i \mid x)</annotation></semantics>.

åœ¨æˆå¯¹æ¯”è¾ƒä¸­ï¼Œç»™å®šå¥–åŠ±æ¨¡å‹çš„æˆåŠŸæ¦‚ç‡å˜ä¸ºï¼š

<semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>></mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mi>.</mi><mrow><mo stretchy="false" form="prefix">(</mo><mn>13</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(y_1 > y_2 \mid x) = \frac{\exp\left(r_\theta(y_1 \mid x)\right)}{\exp\left(r_\theta(y_1 \mid x)\right) + \exp\left(r_\theta(y_2 \mid x)\right)}.\qquad{(13)}</annotation></semantics>

æˆ‘ä»¬å°†é¦–é€‰çš„å®Œæˆé¡¹è¡¨ç¤ºä¸º <semantics><msub><mi>y</mi><mi>c</mi></msub><annotation encoding="application/x-tex">y_c</annotation></semantics>ï¼ˆé€‰æ‹©ï¼‰å’Œè¢«æ‹’ç»çš„å®Œæˆé¡¹è¡¨ç¤ºä¸º <semantics><msub><mi>y</mi><mi>r</mi></msub><annotation encoding="application/x-tex">y_r</annotation></semantics>ã€‚

ç„¶åï¼Œé€šè¿‡æœ€å¤§åŒ–ä¸Šè¿°å‡½æ•°çš„å¯¹æ•°ä¼¼ç„¶ï¼ˆæˆ–è€…ç­‰ä»·åœ°ï¼Œæœ€å°åŒ–è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç”¨äºè®­ç»ƒå¥–åŠ±æ¨¡å‹çš„æŸå¤±å‡½æ•°ï¼š

ç¬¬ä¸€ç§å½¢å¼ï¼Œæ­£å¦‚[[3]](ch021.xhtml#ref-ouyang2022training)å’Œå…¶ä»–ä½œå“æ‰€è¿°ï¼š<semantics><mrow><mi>â„’</mi><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>Ïƒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="postfix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>15</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(\theta) = - \log \left( \sigma \left( r_{\theta}(y_c \mid x) - r_{\theta}(y_r \mid x) \right) \right)\qquad{(15)}</annotation></semantics>

å…¶æ¬¡ï¼Œæ­£å¦‚[[18]](ch021.xhtml#ref-askell2021general)å’Œå…¶ä»–ä½œå“æ‰€è¿°ï¼š<semantics><mrow><mi>â„’</mi><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mi><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>16</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(\theta) = \log \left( 1 + e^{r_{\theta}(y_r \mid x) - r_{\theta}(y_c \mid x)} \right)\qquad{(16)}</annotation></semantics>

è¿™äº›é€šè¿‡è®© <semantics><mrow><mi mathvariant="normal">Î”</mi><mo>=</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\Delta = r_{\theta}(y_c \mid x) - r_{\theta}(y_r \mid x)</annotation></semantics> å’Œä½¿ç”¨ <semantics><mrow><mi>Ïƒ</mi><mo stretchy="false" form="prefix">(</mo><mi mathvariant="normal">Î”</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mi>âˆ’</mi><mi mathvariant="normal">Î”</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\sigma(\Delta) = \frac{1}{1 + e^{-\Delta}}</annotation></semantics> æ¥å®ç°ï¼Œè¿™æš—ç¤ºäº† <semantics><mrow><mi>âˆ’</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Ïƒ</mi><mo stretchy="false" form="prefix">(</mo><mi mathvariant="normal">Î”</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mi>âˆ’</mi><mi mathvariant="normal">Î”</mi></mrow></msup><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="postfix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">-\log\sigma(\Delta) = \log(1 + e^{-\Delta}) = \log\left(1 + e^{r_{\theta}(y_r \mid x) - r_{\theta}(y_c \mid x)}\right)</annotation></semantics>ã€‚å®ƒä»¬éƒ½å‡ºç°åœ¨å¼ºåŒ–å­¦ä¹ ä¸äººç±»åé¦ˆï¼ˆRLHFï¼‰æ–‡çŒ®ä¸­ã€‚

## æ¶æ„

æœ€å¸¸è§çš„å¥–åŠ±æ¨¡å‹å®ç°æ–¹å¼æ˜¯é€šè¿‡ç±»ä¼¼äº Transformer çš„ `AutoModelForSequenceClassification` çš„æŠ½è±¡ï¼Œå®ƒå°†ä¸€ä¸ªå°å‹çº¿æ€§å¤´éƒ¨é™„åŠ åˆ°æ‰§è¡Œä¸¤ä¸ªç»“æœä¹‹é—´åˆ†ç±»çš„è¯­è¨€æ¨¡å‹ä¸Šâ€”â€”é€‰æ‹©å’Œæ‹’ç»ã€‚åœ¨æ¨ç†æ—¶é—´ï¼Œæ¨¡å‹ä»æ¨¡å‹ä¸­è¾“å‡ºä½œä¸ºå•ä¸ª logit çš„ *æ–‡æœ¬ç‰‡æ®µè¢«é€‰æ‹©çš„æ¦‚ç‡*ã€‚

å…¶ä»–å®ç°é€‰é¡¹ä¹Ÿå­˜åœ¨ï¼Œä¾‹å¦‚ç›´æ¥ä»æœ€ç»ˆåµŒå…¥ä¸­å–ä¸€ä¸ªçº¿æ€§å±‚ï¼Œä½†åœ¨å¼€æºå·¥å…·ä¸­å®ƒä»¬è¾ƒå°‘è§ã€‚

## å®ç°ç¤ºä¾‹

å®ç°å¥–åŠ±å»ºæ¨¡æŸå¤±ç›¸å½“ç®€å•ã€‚æ›´å¤šçš„å®ç°æŒ‘æˆ˜åœ¨äºè®¾ç½®å•ç‹¬çš„æ•°æ®åŠ è½½å™¨å’Œæ¨ç†ç®¡é“ã€‚ç»™å®šæ­£ç¡®çš„æ•°æ®åŠ è½½å™¨ï¼Œå…¶ä¸­åŒ…å«æ ‡è®°åŒ–ã€é€‰æ‹©å’Œæ‹’ç»çš„æç¤ºä»¥åŠå®Œæˆé¡¹ï¼ŒæŸå¤±å®ç°å¦‚ä¸‹ï¼š

```py
[](#cb1-1)import torch.nn as nn
[](#cb1-2)# inputs_chosen / inputs_rejected include the prompt tokens x and the respective
[](#cb1-3)# completion tokens (y_c or y_r) that the reward model scores jointly.
[](#cb1-4)rewards_chosen = model(**inputs_chosen)
[](#cb1-5)rewards_rejected = model(**inputs_rejected)
[](#cb1-6)
[](#cb1-7)loss = -nn.functional.logsigmoid(rewards_chosen - rewards_rejected).mean()
```

å¯¹äºæ›´å¤§çš„å›¾æ™¯ï¼Œè¿™é€šå¸¸æ˜¯åœ¨ä¸€ä¸ªå› æœè¯­è¨€æ¨¡å‹ä¸­ï¼Œé¢å¤–æ·»åŠ äº†ä¸€ä¸ªå¤´éƒ¨ï¼ˆå¹¶ä¸”ä¸ä¸Šè¿°æŸå¤±ä¸€èµ·å­¦ä¹ ï¼‰ï¼Œå®ƒä»æœ€ç»ˆçš„éšè—çŠ¶æ€è½¬æ¢åˆ°è¾“å…¥çš„åˆ†æ•°ã€‚æ­¤æ¨¡å‹çš„ç»“æ„å¦‚ä¸‹ï¼š

```py
[](#cb2-1)import torch
[](#cb2-2)import torch.nn as nn
[](#cb2-3)import torch.nn.functional as F
[](#cb2-4)
[](#cb2-5)class BradleyTerryRewardModel(nn.Module):
[](#cb2-6)    """
[](#cb2-7) Standard scalar reward model for Bradley-Terry preference learning.
[](#cb2-8)
[](#cb2-9) Usage (pairwise BT loss):
[](#cb2-10) rewards_chosen = model(**inputs_chosen)    # (batch,)
[](#cb2-11) rewards_rejected = model(**inputs_rejected)  # (batch,)
[](#cb2-12) loss = -F.logsigmoid(rewards_chosen - rewards_rejected).mean()
[](#cb2-13) """
[](#cb2-14)    def __init__(self, base_lm):
[](#cb2-15)        super().__init__()
[](#cb2-16)        self.lm = base_lm  # e.g., AutoModelForCausalLM
[](#cb2-17)        self.head = nn.Linear(self.lm.config.hidden_size, 1)
[](#cb2-18)
[](#cb2-19)    def _sequence_rep(self, hidden, attention_mask):
[](#cb2-20)        """
[](#cb2-21) Get a single vector per sequence to score.
[](#cb2-22) Default: last non-padding token (EOS token); if no mask, last token.
[](#cb2-23) hidden: (batch, seq_len, hidden_size)
[](#cb2-24) attention_mask: (batch, seq_len)
[](#cb2-25) """
[](#cb2-26)
[](#cb2-27)        # Index of last non-pad token in each sequence
[](#cb2-28)        # attention_mask is 1 for real tokens, 0 for padding
[](#cb2-29)        lengths = attention_mask.sum(dim=1) - 1  # (batch,)
[](#cb2-30)        batch_idx = torch.arange(hidden.size(0), device=hidden.device)
[](#cb2-31)        return hidden[batch_idx, lengths]  # (batch, hidden_size)
[](#cb2-32)
[](#cb2-33)    def forward(self, input_ids, attention_mask):
[](#cb2-34)        """
[](#cb2-35) A forward pass designed to show inference structure of a standard reward model.
[](#cb2-36) To train one, this function will need to be modified to compute rewards from both
[](#cb2-37) chosen and rejected inputs, applying the loss above.
[](#cb2-38) """
[](#cb2-39)        outputs = self.lm(
[](#cb2-40)            input_ids=input_ids,
[](#cb2-41)            attention_mask=attention_mask,
[](#cb2-42)            output_hidden_states=True,
[](#cb2-43)            return_dict=True,
[](#cb2-44)        )
[](#cb2-45)        # Final hidden states: (batch, seq_len, hidden_size)
[](#cb2-46)        hidden = outputs.hidden_states[-1]
[](#cb2-47)
[](#cb2-48)        # One scalar reward per sequence: (batch,)
[](#cb2-49)        seq_repr = self._sequence_rep(hidden, attention_mask)
[](#cb2-50)        rewards = self.head(seq_repr).squeeze(-1)
[](#cb2-51)
[](#cb2-52)        return rewards
```

åœ¨æœ¬èŠ‚åŠä»¥ä¸‹å†…å®¹ä¸­ï¼Œå¥–åŠ±æ¨¡å‹çš„å¤§éƒ¨åˆ†å®ç°å¤æ‚æ€§ï¼ˆä»¥åŠå¤§é‡è®­ç»ƒåï¼‰éƒ½å›´ç»•ç€æ­£ç¡®æ„å»ºæ•°æ®åŠ è½½å™¨å’Œåˆ†å¸ƒå¼å­¦ä¹ ç³»ç»Ÿã€‚è¯·æ³¨æ„ï¼Œåœ¨è®­ç»ƒå¥–åŠ±æ¨¡å‹æ—¶ï¼Œæœ€å¸¸è§çš„æ–¹æ³•æ˜¯ä»…è®­ç»ƒ 1 ä¸ª epoch ä»¥é¿å…è¿‡æ‹Ÿåˆã€‚

## å˜ä½“

å¥–åŠ±å»ºæ¨¡æ˜¯ RLHF ä¸­ç›¸å¯¹æœªè¢«å……åˆ†æ¢ç´¢çš„é¢†åŸŸã€‚ä¼ ç»Ÿçš„å¥–åŠ±å»ºæ¨¡æŸå¤±åœ¨è®¸å¤šæµè¡Œçš„å·¥ä½œä¸­å·²ç»è¢«ä¿®æ”¹ï¼Œä½†è¿™äº›ä¿®æ”¹å°šæœªå½¢æˆå•ä¸€çš„æœ€ä½³å®è·µã€‚

### åå¥½é—´éš”æŸå¤±

åœ¨æ³¨é‡Šè€…æä¾›æå…‹ç‰¹é‡è¡¨ä¸Šçš„åˆ†æ•°æˆ–æ’åçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨å…³ç³»é‡çš„å¹…åº¦è¿›è¡Œè®­ç»ƒã€‚æœ€å¸¸è§çš„æ–¹æ³•æ˜¯å°†æ•°æ®æ²¿åå¥½æ–¹å‘äºŒå€¼åŒ–ï¼Œå°†ç›¸å¯¹è¯„åˆ†æˆ–æ’åçš„æ··åˆä¿¡æ¯æˆ–å¼ºåº¦ç®€åŒ–ä¸ºä»…é€‰æ‹©å’Œæ‹’ç»çš„å®Œæˆé¡¹ã€‚åå¥½å¹…åº¦çš„é™„åŠ ä¿¡æ¯å·²è¢«ç”¨äºæ”¹è¿›æ¨¡å‹è®­ç»ƒï¼Œä½†å°šæœªä½œä¸ºæ ‡å‡†å®è·µæ”¶æ•›ã€‚Llama 2 æå‡ºä½¿ç”¨ä¸¤ä¸ªæ•°æ®ç‚¹ä¹‹é—´çš„é—´éš”ï¼Œ<semantics><mrow><mi>m</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">m(y_c, y_r)</annotation></semantics>ï¼Œæ¥åŒºåˆ†åå¥½çš„å¹…åº¦ï¼š

<semantics><mrow><mi>â„’</mi><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>Ïƒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mi>m</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mi>m</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>17</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(\theta) = - \log \left( \sigma \left( r_{\theta}(y_c \mid x) - r_{\theta}(y_r \mid x) - m(y_c, y_r) \right) \right)\qquad{(17)}</annotation></semantics>

ä¾‹å¦‚ï¼Œæ¯ä¸ªå®Œæˆé¡¹é€šå¸¸æ ¹æ®è´¨é‡ä» 1 åˆ° 5 è¿›è¡Œæ’åã€‚åœ¨æ‰€é€‰æ ·æœ¬è¢«åˆ†é… 5 åˆ†è€Œæ‹’ç» 2 åˆ†çš„æƒ…å†µä¸‹ï¼Œè¾¹ç¼˜ <semantics><mrow><mi>m</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mn>5</mn><mo>âˆ’</mo><mn>2</mn><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">m(y_c, y_r)= 5 - 2 = 3</annotation></semantics>ã€‚å¯ä»¥æ¢ç´¢å…¶ä»–è®¡ç®—è¾¹ç¼˜çš„å‡½æ•°ã€‚

æ³¨æ„ï¼Œåœ¨ Llama 3 ä¸­ï¼Œç”±äºå›¢é˜Ÿè§‚å¯Ÿåˆ°åœ¨æ‰©å±•åæ”¹è¿›æ•ˆæœé€æ¸å‡å°‘ï¼Œå› æ­¤ç§»é™¤äº†è¾¹ç¼˜é¡¹ã€‚

### æ¯ä¸ªæç¤ºä¸‹çš„å¤šé‡æ¯”è¾ƒå¹³è¡¡

InstructGPT ç ”ç©¶äº†åœ¨æ¯ä¸ªæç¤ºä¸­ä½¿ç”¨ä¸åŒæ•°é‡çš„å®Œæˆé¡¹å¯¹çš„å½±å“ï¼Œä½†åœ¨å¥–åŠ±æ¨¡å‹è®­ç»ƒä¸­ä¿æŒå®ƒä»¬çš„å¹³è¡¡ [[3]](ch021.xhtml#ref-ouyang2022training)ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œä»–ä»¬ä¸ºæ¯ä¸ªæç¤ºçš„æ¯ä¸ªæ¯”è¾ƒåŠ æƒæ›´æ–°æŸå¤±ã€‚åœ¨å®ç°å±‚é¢ï¼Œè¿™å¯ä»¥é€šè¿‡å°†å…·æœ‰ç›¸åŒæç¤ºçš„æ‰€æœ‰ç¤ºä¾‹åŒ…å«åœ¨åŒä¸€ä¸ªè®­ç»ƒæ‰¹æ¬¡ä¸­è‡ªåŠ¨å®Œæˆï¼Œä»è€Œè‡ªç„¶åœ°åŠ æƒä¸åŒçš„å¯¹â€”â€”ä¸è¿™æ ·åšä¼šå¯¼è‡´å¯¹æç¤ºçš„è¿‡åº¦æ‹Ÿåˆã€‚æŸå¤±å‡½æ•°å˜ä¸ºï¼š

<semantics><mrow><mi>â„’</mi><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><mfrac><mn>1</mn><mrow><mo stretchy="true" form="prefix">(</mo><mfrac linethickness="0"><mi>K</mi><mn>2</mn></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mfrac><msub><mi>ğ”¼</mi><mrow><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>D</mi></mrow></msub><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>Ïƒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>18</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(\theta) = - \frac{1}{\binom{K}{2}} \mathbb{E}_{(x, y_c, y_r)\sim D} \log \left( \sigma \left( r_{\theta}(y_c \mid x) - r_{\theta}(y_r \mid x) \right) \right)\qquad{(18)}</annotation></semantics>

### K-wise æŸå¤±å‡½æ•°

å¯¹äº RLHFï¼Œæœ‰è®¸å¤šå…¶ä»–å…¬å¼å¯ä»¥åˆ›å»ºé€‚åˆäººç±»åå¥½çš„æ¨¡å‹ã€‚å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼Œåœ¨æµè¡Œçš„æ—©æœŸ RLHF æ¨¡å‹ Starling 7B å’Œ 34B ä¸­ä½¿ç”¨ï¼Œæ˜¯åŸºäº Plackett-Luce æ¨¡å‹çš„ K-wise æŸå¤±å‡½æ•° [[126]](ch021.xhtml#ref-zhu2024starling)ï¼Œ[[127]](ch021.xhtml#ref-liu2019learning)ã€‚

Zhu ç­‰äººäº 2023 å¹´[[128]](ch021.xhtml#ref-zhu2023principled)å°†è®¾ç½®å½¢å¼åŒ–ä¸ºå¦‚ä¸‹ã€‚åœ¨æç¤ºæˆ–çŠ¶æ€<semantics><msup><mi>s</mi><mi>i</mi></msup><annotation encoding="application/x-tex">s^i</annotation></semantics>ä¸‹ï¼Œ<semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics>åŠ¨ä½œ<semantics><mrow><mo stretchy="false" form="prefix">(</mo><msubsup><mi>a</mi><mn>0</mn><mi>i</mi></msubsup><mo>,</mo><msubsup><mi>a</mi><mn>1</mn><mi>i</mi></msubsup><mo>,</mo><mi>â‹¯</mi><mo>,</mo><msubsup><mi>a</mi><mrow><mi>K</mi><mo>âˆ’</mo><mn>1</mn></mrow><mi>i</mi></msubsup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a_0^i, a_1^i, \cdots, a_{K-1}^i)</annotation></semantics>æ˜¯ä»<semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><mi>â‹¯</mi><mo>,</mo><msub><mi>a</mi><mrow><mi>K</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo stretchy="false" form="prefix">|</mo><msup><mi>s</mi><mi>i</mi></msup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P(a_0,\cdots,a_{K-1}|s^i)</annotation></semantics>ä¸­é‡‡æ ·çš„ã€‚ç„¶åï¼Œä½¿ç”¨æ ‡ç­¾å™¨é€šè¿‡<semantics><mrow><msup><mi>Ïƒ</mi><mi>i</mi></msup><mo>:</mo><mo stretchy="false" form="prefix">[</mo><mi>K</mi><mo stretchy="false" form="postfix">]</mo><mo>â†¦</mo><mo stretchy="false" form="prefix">[</mo><mi>K</mi><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">\sigma^i: [K] \mapsto [K]</annotation></semantics>å¯¹åå¥½è¿›è¡Œæ’åºï¼Œå…¶ä¸­<semantics><mrow><msup><mi>Ïƒ</mi><mi>i</mi></msup><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sigma^i(0)</annotation></semantics>æ˜¯æœ€å—åå¥½çš„åŠ¨ä½œã€‚è¿™äº§ç”Ÿäº†ä¸€ä¸ªåå¥½æ¨¡å‹ï¼Œå®ƒæ•æ‰ä»¥ä¸‹å†…å®¹ï¼š

<semantics><mrow><mi>P</mi><mo stretchy="false" form="prefix">(</mo><msup><mi>Ïƒ</mi><mi>i</mi></msup><mo stretchy="false" form="prefix">|</mo><msup><mi>s</mi><mi>i</mi></msup><mo>,</mo><msubsup><mi>a</mi><mn>0</mn><mi>i</mi></msubsup><mo>,</mo><msubsup><mi>a</mi><mn>1</mn><mi>i</mi></msubsup><mo>,</mo><mi>â€¦</mi><mo>,</mo><msubsup><mi>a</mi><mrow><mi>K</mi><mo>âˆ’</mo><mn>1</mn></mrow><mi>i</mi></msubsup><mo stretchy="false" form="postfix">)</mo><mo>=</mo><munderover><mo>âˆ</mo><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>K</mi><mo>âˆ’</mo><mn>1</mn></mrow></munderover><mfrac><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>r</mi><mrow><mi>Î¸</mi><mo>â‹†</mo></mrow></msub><mo stretchy="false" form="prefix">(</mo><msup><mi>s</mi><mi>i</mi></msup><mo>,</mo><msubsup><mi>a</mi><mrow><msup><mi>Ïƒ</mi><mi>i</mi></msup><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><mi>i</mi></msubsup><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow><mrow><munderover><mo>âˆ‘</mo><mrow><mi>j</mi><mo>=</mo><mi>k</mi></mrow><mrow><mi>K</mi><mo>âˆ’</mo><mn>1</mn></mrow></munderover><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>r</mi><mrow><mi>Î¸</mi><mo>â‹†</mo></mrow></msub><mo stretchy="false" form="prefix">(</mo><msup><mi>s</mi><mi>i</mi></msup><mo>,</mo><msubsup><mi>a</mi><mrow><msup><mi>Ïƒ</mi><mi>i</mi></msup><mo stretchy="false" form="prefix">(</mo><mi>j</mi><mo stretchy="false" form="postfix">)</mo></mrow><mi>i</mi></msubsup><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mrow><mo stretchy="false" form="prefix">(</mo><mn>19</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\sigma^i|s^i,a_0^i,a_1^i,\ldots,a_{K-1}^i) = \prod_{k=0}^{K-1} \frac{\exp(r_{\theta\star}(s^i,a_{\sigma^i(k)}^i))}{\sum_{j=k}^{K-1}\exp(r_{\theta\star}(s^i,a_{\sigma^i(j)}^i))}\qquad{(19)}</annotation></semantics>

å½“ <semantics><mrow><mi>K</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">K = 2</annotation></semantics> æ—¶ï¼Œè¿™ç®€åŒ–ä¸ºå¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œï¼ˆBTï¼‰æ¨¡å‹ç”¨äºæˆå¯¹æ¯”è¾ƒã€‚æ— è®ºå¦‚ä½•ï¼Œä¸€æ—¦è®­ç»ƒå®Œæˆï¼Œè¿™äº›æ¨¡å‹åœ¨ RLHF è®­ç»ƒæœŸé—´ä¸å…¶ä»–å¥–åŠ±æ¨¡å‹çš„ä½¿ç”¨æ–¹å¼ç›¸ä¼¼ã€‚

## ç»“æœå¥–åŠ±æ¨¡å‹

å¯¹äºè¯­è¨€æ¨¡å‹å’Œå…¶ä»– AI ç³»ç»Ÿçš„*åå¥½è°ƒæ•´*ï¼Œå¤§å¤šæ•°éƒ½æ˜¯ä½¿ç”¨ä¸Šé¢è®¨è®ºçš„ Bradley Terry æ¨¡å‹è¿›è¡Œçš„ã€‚å¯¹äºæ¨ç†å¯†é›†å‹ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ç»“æœå¥–åŠ±æ¨¡å‹ï¼ˆORMï¼‰ã€‚ORM çš„è®­ç»ƒæ•°æ®æ„å»ºæ–¹å¼ä¸æ ‡å‡†åå¥½è°ƒæ•´ç±»ä¼¼ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé—®é¢˜é™ˆè¿°æˆ–æç¤ºï¼Œ<semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics>å’Œä¸¤ä¸ªè¡¥å…¨<semantics><msub><mi>y</mi><mn>1</mn></msub><annotation encoding="application/x-tex">y_1</annotation></semantics>å’Œ<semantics><msub><mi>y</mi><mn>2</mn></msub><annotation encoding="application/x-tex">y_2</annotation></semantics>ã€‚è¿™é‡Œä½¿ç”¨çš„å½’çº³åå·®æ˜¯ï¼Œä¸€ä¸ªè¡¥å…¨åº”è¯¥æ˜¯é—®é¢˜çš„æ­£ç¡®è§£å†³æ–¹æ¡ˆï¼Œå¦ä¸€ä¸ªæ˜¯é”™è¯¯çš„ï¼Œä»è€Œå¾—åˆ°<semantics><mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>c</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(y_c,y_{ic})</annotation></semantics>ã€‚

ä½¿ç”¨çš„æ¨¡å‹å½¢çŠ¶ä¸æ ‡å‡†å¥–åŠ±æ¨¡å‹éå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯é™„åŠ äº†ä¸€ä¸ªçº¿æ€§å±‚åˆ°å¯ä»¥è¾“å‡ºå•ä¸ª logit çš„æ¨¡å‹ï¼ˆåœ¨ RM çš„æƒ…å†µä¸‹ï¼‰â€”â€”å¯¹äº ORMï¼Œæ¥ä¸‹æ¥çš„è®­ç»ƒç›®æ ‡ç•¥æœ‰ä¸åŒ[[129]](ch021.xhtml#ref-cobbe2021gsm8k)ï¼š

> [æˆ‘ä»¬]ä½¿ç”¨è”åˆç›®æ ‡æ¥è®­ç»ƒéªŒè¯å™¨ï¼Œæ¨¡å‹é™¤äº†å­¦ä¹ å¯¹æ¨¡å‹è¡¥å…¨è¿›è¡Œæ­£ç¡®æˆ–é”™è¯¯æ ‡è®°ä¹‹å¤–ï¼Œè¿˜è¦å­¦ä¹ åŸå§‹çš„è¯­è¨€æ¨¡å‹ç›®æ ‡ã€‚åœ¨æ¶æ„ä¸Šï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„éªŒè¯å™¨æ˜¯è¯­è¨€æ¨¡å‹ï¼Œå…·æœ‰ä¸€ä¸ªå°çš„æ ‡é‡å¤´ï¼Œè¯¥å¤´åœ¨æ¯ä¸ªæ ‡è®°çš„åŸºç¡€ä¸Šè¾“å‡ºé¢„æµ‹ã€‚æˆ‘ä»¬å°†è¿™ä¸ªæ ‡é‡å¤´å®ç°ä¸ºä¸€ä¸ªå•åç½®å‚æ•°å’Œä¸€ä¸ªå•å¢ç›Šå‚æ•°ï¼Œå®ƒä»¬ä½œç”¨äºè¯­è¨€æ¨¡å‹æœ€ç»ˆååµŒå…¥å±‚è¾“å‡ºçš„ logitsã€‚

ä¸ºäº†ç¿»è¯‘ï¼Œè¿™è¢«å®ç°ä¸ºä¸€ä¸ªè¯­è¨€æ¨¡å‹å¤´ï¼Œå®ƒå¯ä»¥å¯¹æ¯ä¸ªæ ‡è®°é¢„æµ‹ä¸¤ä¸ªç±»åˆ«ï¼ˆ1 è¡¨ç¤ºæ­£ç¡®ï¼Œ0 è¡¨ç¤ºé”™è¯¯ï¼‰ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿ RM çš„åˆ†ç±»å¤´ï¼Œè¯¥å¤´è¾“å‡ºæ•´ä¸ªåºåˆ—çš„ä¸€ä¸ª logitã€‚æ­£å¼æ¥è¯´ï¼Œæ ¹æ®[[130]](ch021.xhtml#ref-lyu2025exploring)ï¼Œè¿™å¯ä»¥è¡¨ç¤ºä¸ºï¼š

<semantics><mrow><msub><mi>â„’</mi><mtext mathvariant="normal">CE</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mo stretchy="false" form="prefix">(</mo><mi>s</mi><mo>,</mo><mi>r</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mo stretchy="false" form="prefix">[</mo><mi>r</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msub><mi>p</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>s</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><mi>r</mi><mo stretchy="false" form="postfix">)</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><msub><mi>p</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>s</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>20</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text{CE}}(\theta) = -\mathbb{E}_{(s,r)\sim \mathcal{D}}[r\log p_\theta(s) + (1-r)\log(1-p_\theta(s))]\qquad{(20)}</annotation></semantics>

å…¶ä¸­ï¼Œ<semantics><mrow><mi>r</mi><mo>âˆˆ</mo><mrow><mn>0</mn><mo>,</mo><mn>1</mn></mrow></mrow><annotation encoding="application/x-tex">r \in {0,1}</annotation></semantics>æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ ‡ç­¾ï¼Œå…¶ä¸­ 1 è¡¨ç¤ºå¯¹ç»™å®šæç¤ºçš„æ­£ç¡®ç­”æ¡ˆï¼Œ0 è¡¨ç¤ºé”™è¯¯ç­”æ¡ˆï¼Œè€Œ<semantics><mrow><msub><mi>p</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>s</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">p_\theta(s)</annotation></semantics>æ˜¯æ¨¡å‹è®­ç»ƒä¸­é¢„æµ‹æ­£ç¡®æ€§æ¦‚ç‡çš„æ ‡é‡ã€‚

å®ç°ç»“æœå¥–åŠ±æ¨¡å‹ï¼ˆä»¥åŠå…¶ä»–ç±»å‹ï¼Œå¦‚æˆ‘ä»¬å°†é€šè¿‡è¿‡ç¨‹å¥–åŠ±æ¨¡å‹çœ‹åˆ°çš„ï¼‰æ¶‰åŠæ ¹æ®å®Œæˆæ˜¯å¦ä¸ºæ­£ç¡®æ ·æœ¬åº”ç”¨åŸºäºæ ‡è®°çš„äº¤å‰ç†µæŸå¤±ã€‚è¿™æ¯”æ ‡å‡†å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œå¥–åŠ±æ¨¡å‹çš„æœ‰åºé€‰æ‹©-æ‹’ç»æ€§è´¨æ›´æ¥è¿‘è¯­è¨€æ¨¡å‹æŸå¤±ï¼Œå› ä¸ºå®ƒä¸éœ€è¦è¿™ç§ç»“æ„ã€‚

æ¨¡å‹ç»“æ„å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

```py
[](#cb3-1)import torch.nn as nn
[](#cb3-2)import torch.nn.functional as F
[](#cb3-3)
[](#cb3-4)class OutcomeRewardModel(nn.Module):
[](#cb3-5)    def __init__(self, base_lm):
[](#cb3-6)        super().__init__()
[](#cb3-7)        self.lm = base_lm  # e.g., AutoModelForCausalLM
[](#cb3-8)        self.head = nn.Linear(self.lm.config.hidden_size, 1)
[](#cb3-9)
[](#cb3-10)    def forward(self, input_ids, attention_mask=None, labels=None):
[](#cb3-11)        """
[](#cb3-12) The input data here will be tokenized prompts and completions along with labels
[](#cb3-13) per prompt for correctness.
[](#cb3-14) """
[](#cb3-15)        outputs = self.lm(
[](#cb3-16)            input_ids=input_ids,
[](#cb3-17)            attention_mask=attention_mask,
[](#cb3-18)            output_hidden_states=True,
[](#cb3-19)            return_dict=True,
[](#cb3-20)        )
[](#cb3-21)        # Final hidden states: (batch, seq_len, hidden_size)
[](#cb3-22)        hidden = outputs.hidden_states[-1]
[](#cb3-23)        # One scalar logit per token: (batch, seq_len)
[](#cb3-24)        logits = self.head(hidden).squeeze(-1)
[](#cb3-25)
[](#cb3-26)        # Only compute loss on completion tokens (labels 0 or 1)
[](#cb3-27)        # Prompt tokens have labels = -100
[](#cb3-28)        mask = labels != -100
[](#cb3-29)        if mask.any():
[](#cb3-30)            loss = F.binary_cross_entropy_with_logits(
[](#cb3-31)                logits[mask], labels[mask].float()
[](#cb3-32)            )
[](#cb3-33)        return loss, logits
```

æŸå¤±å‡½æ•°çš„ç®€åŒ–ç‰ˆæœ¬å¦‚ä¸‹ï¼š

```py
[](#cb4-1)# Assume model already has: model.lm (backbone) + model.head
[](#cb4-2)hidden = model.lm(**inputs, output_hidden_states=True).hidden_states[-1]
[](#cb4-3)logits_per_token = model.head(hidden).squeeze(-1)  # (batch, seq_len)
[](#cb4-4)# This will sometimes be compressed as model.forward() in other implementations
[](#cb4-5)
[](#cb4-6)# Binary labels: 1=correct, 0=incorrect (prompt tokens masked as -100)
[](#cb4-7)mask = labels != -100
[](#cb4-8)loss = F.binary_cross_entropy_with_logits(
[](#cb4-9)    logits_per_token[mask], labels[mask].float()
[](#cb4-10))
```

è¿™é‡Œçš„é‡è¦ç›´è§‰æ˜¯ï¼ŒORM ä¼šåœ¨åºåˆ—ä¸­çš„æ¯ä¸ªæ ‡è®°å¤„è¾“å‡ºä¸€ä¸ªæ­£ç¡®æ€§çš„æ¦‚ç‡ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½æ˜¯æœ‰å™ªå£°çš„ï¼Œå› ä¸ºæ›´æ–°å’ŒæŸå¤±ä¼ æ’­æ˜¯æŒ‰æ ‡è®°è¿›è¡Œçš„ï¼Œè¿™å–å†³äºç»“æœå’Œæ³¨æ„åŠ›æ˜ å°„ã€‚

è¿™äº›æ¨¡å‹ä»åœ¨ä½¿ç”¨ä¸­ï¼Œä½†åœ¨å¼€æº RLHF å·¥å…·ä¸­æ”¯æŒè¾ƒå°‘ã€‚ä¾‹å¦‚ï¼Œåœ¨å¼€åˆ›æ€§å·¥ä½œ *Letâ€™s Verify Step by Step* [[45]](ch021.xhtml#ref-lightman2023let) ä¸­ä½¿ç”¨äº†ç›¸åŒç±»å‹çš„ ORMï¼Œä½†æ²¡æœ‰ä½¿ç”¨æŸå¤±ä¸­çš„è¯­è¨€å»ºæ¨¡é¢„æµ‹éƒ¨åˆ†ã€‚ç„¶åï¼Œæœ€ç»ˆçš„æŸå¤±æ˜¯æ¯ä¸ªæ ‡è®°é¢„æµ‹æœ€ç»ˆç­”æ¡ˆæ˜¯å¦æ­£ç¡®çš„äº¤å‰ç†µæŸå¤±ã€‚

ç”±äºç¼ºä¹æ”¯æŒï¼Œç»“æœå¥–åŠ±æ¨¡å‹ï¼ˆORMï¼‰è¢«ä»¥å¤šç§æ–¹å¼ä½¿ç”¨ã€‚ä¸€äº›æ–‡çŒ®ï¼Œä¾‹å¦‚ [[130]](ch021.xhtml#ref-lyu2025exploring)ï¼Œç»§ç»­ä½¿ç”¨ Cobbe ç­‰äººäº 2021 å¹´æå‡ºçš„åŸå§‹å®šä¹‰ã€‚è€Œå¦ä¸€äº›åˆ™ä¸è¿™æ ·åšã€‚

## æµç¨‹å¥–åŠ±æ¨¡å‹

æµç¨‹å¥–åŠ±æ¨¡å‹ï¼ˆPRMsï¼‰ï¼Œæœ€åˆè¢«ç§°ä¸ºæµç¨‹ç›‘ç£å¥–åŠ±æ¨¡å‹ï¼Œæ˜¯è®­ç»ƒç”¨äºåœ¨æ¯ä¸ªæ€ç»´æ¨ç†è¿‡ç¨‹çš„é“¾ä¸­æ¯ä¸€æ­¥è¾“å‡ºåˆ†æ•°çš„å¥–åŠ±æ¨¡å‹ã€‚è¿™äº›æ¨¡å‹ä¸ä»…åœ¨ EOS æ ‡è®°å¤„è¾“å‡ºåˆ†æ•°çš„æ ‡å‡† RM æˆ–åœ¨æ¯ä¸ªæ ‡è®°å¤„è¾“å‡ºåˆ†æ•°çš„ ORM ä¸åŒã€‚æµç¨‹å¥–åŠ±æ¨¡å‹éœ€è¦åœ¨æ¯ä¸ªæ¨ç†æ­¥éª¤çš„æœ«å°¾è¿›è¡Œç›‘ç£ï¼Œç„¶åä»¥ç±»ä¼¼çš„æ–¹å¼è¿›è¡Œè®­ç»ƒï¼Œå…¶ä¸­æ­¥éª¤ä¸­çš„æ ‡è®°è¢«è®­ç»ƒåˆ°å®ƒä»¬çš„ç›¸å…³ç›®æ ‡â€”â€”åœ¨ PRMs ä¸­ç›®æ ‡æ˜¯æ­¥éª¤ï¼Œè€Œåœ¨ ORMs ä¸­æ˜¯æ•´ä¸ªå“åº”ã€‚

æ ¹æ® [[45]](ch021.xhtml#ref-lightman2023let)ï¼ŒäºŒåˆ†ç±»æ ‡ç­¾çš„æµç¨‹å¥–åŠ±æ¨¡å‹ï¼ˆPRMï¼‰é€šå¸¸ä½¿ç”¨æ¯æ­¥äº¤å‰ç†µæŸå¤±è¿›è¡Œä¼˜åŒ–ï¼š

<semantics><mrow><msub><mi>â„’</mi><mtext mathvariant="normal">PRM</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>Î¸</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>s</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">[</mo><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mi>y</mi><msub><mi>s</mi><mi>i</mi></msub></msub><mi mathvariant="normal">log</mi><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><msub><mi>y</mi><msub><mi>s</mi><mi>i</mi></msub></msub><mo stretchy="false" form="postfix">)</mo><mi mathvariant="normal">log</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>21</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text{PRM}}(\theta) = - \mathbb{E}_{(x, s) \sim \mathcal{D}} \left[ \sum_{i=1}^{K} y_{s_i} \log r_\theta(s_i \mid x) + (1 - y_{s_i}) \log \left(1 - r_\theta(s_i \mid x)\right) \right] \qquad{(21)}</annotation></semantics>

å…¶ä¸­ <semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics> æ˜¯ä¸€ä¸ªå¸¦æœ‰ <semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics> ä¸ªæ ‡è®°æ­¥éª¤çš„é‡‡æ ·æ€ç»´é“¾ï¼Œ<semantics><mrow><msub><mi>y</mi><msub><mi>s</mi><mi>i</mi></msub></msub><mo>âˆˆ</mo><mo stretchy="false" form="prefix">{</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">y_{s_i} \in \{0,1\}</annotation></semantics> è¡¨ç¤ºç¬¬ <semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics> ä¸ªæ­¥éª¤æ˜¯å¦æ­£ç¡®ï¼Œè€Œ <semantics><mrow><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>s</mi><mi>i</mi></msub><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">r_\theta(s_i \mid x)</annotation></semantics> æ˜¯ PRM é¢„æµ‹çš„ç¬¬ <semantics><msub><mi>s</mi><mi>i</mi></msub><annotation encoding="application/x-tex">s_i</annotation></semantics> æ­¥éª¤åœ¨ç»™å®šåŸå§‹æç¤º <semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics> ä¸‹æœ‰æ•ˆçš„æ¦‚ç‡ã€‚

è¿™é‡Œæ˜¯ä¸€ä¸ªå¦‚ä½•å°†æ¯æ­¥æ ‡ç­¾æ‰“åŒ…åˆ°è®­ç»ƒå™¨ä¸­çš„ç¤ºä¾‹ï¼Œæ¥è‡ª HuggingFace çš„ TRLï¼ˆTransformer Reinforcement Learningï¼‰[[42]](ch021.xhtml#ref-vonwerra2022trl)ï¼š

```py
# Get the ID of the separator token and add it to the completions
separator_ids = tokenizer.encode(step_separator, add_special_tokens=False)
completions_ids = [completion + separator_ids for completion in completions_ids]

# Create the label 
labels = [[-100] * (len(completion) - 1) + [label] for completion, label in zip(completions_ids, labels)]
```

ä¼ ç»Ÿä¸Šï¼ŒPRMs ä½¿ç”¨è¯­è¨€æ¨¡å‹å¤´éƒ¨è¿›è¡Œè®­ç»ƒï¼Œä»…åœ¨æ¨ç†æ­¥éª¤çš„æœ«å°¾è¾“å‡ºä¸€ä¸ªæ ‡è®°ï¼Œä¾‹å¦‚åœ¨å¯¹åº”äºåŒæ¢è¡Œç¬¦æˆ–å…¶ä»–ç‰¹æ®Šæ ‡è®°çš„æ ‡è®°å¤„ã€‚è¿™äº›é¢„æµ‹é€šå¸¸ä¸º-1 è¡¨ç¤ºé”™è¯¯ï¼Œ0 è¡¨ç¤ºä¸­æ€§ï¼Œ1 è¡¨ç¤ºæ­£ç¡®ã€‚è¿™äº›æ ‡ç­¾ä¸ä¸€å®šä¸æ¨¡å‹æ˜¯å¦åœ¨æ­£ç¡®è·¯å¾„ä¸Šç›¸å…³ï¼Œä½†å¦‚æœæ˜¯æ­£ç¡®æ­¥éª¤ã€‚

ä¸‹é¢å±•ç¤ºäº† PRM çš„ä¸€ä¸ªç¤ºä¾‹æ„å»ºã€‚

```py
[](#cb6-1)import torch.nn as nn
[](#cb6-2)import torch.nn.functional as F
[](#cb6-3)
[](#cb6-4)class ProcessRewardModel(nn.Module):
[](#cb6-5)    def __init__(self, base_lm, num_classes=3):
[](#cb6-6)        super().__init__()
[](#cb6-7)        self.lm = base_lm  # e.g., AutoModelForCausalLM
[](#cb6-8)        self.head = nn.Linear(self.lm.config.hidden_size, num_classes)
[](#cb6-9)
[](#cb6-10)    def forward(self, input_ids, attention_mask=None, labels=None):
[](#cb6-11)        """
[](#cb6-12) The inputs are tokenizer prompts and completions, where the the end of a 
[](#cb6-13) "reasoning step" is denoted by another non-padding token. 
[](#cb6-14) labels will be a list of labels, True, False, and Neutral (3 labels) which
[](#cb6-15) will be predicted by the model.
[](#cb6-16) """
[](#cb6-17)        outputs = self.lm(
[](#cb6-18)            input_ids=input_ids,
[](#cb6-19)            attention_mask=attention_mask,
[](#cb6-20)            output_hidden_states=True,
[](#cb6-21)            return_dict=True,
[](#cb6-22)        )
[](#cb6-23)        # Final hidden states: (batch, seq_len, hidden_size)
[](#cb6-24)        hidden = outputs.hidden_states[-1]
[](#cb6-25)        # One logit vector per token: (batch, seq_len, num_classes)
[](#cb6-26)        logits = self.head(hidden)
[](#cb6-27)
[](#cb6-28)        # Only compute loss at step boundaries (where labels != -100)
[](#cb6-29)        # Labels map: -1 -> 0, 0 -> 1, 1 -> 2 (class indices)
[](#cb6-30)        mask = labels != -100
[](#cb6-31)        if mask.any():
[](#cb6-32)            loss = F.cross_entropy(
[](#cb6-33)                logits[mask], labels[mask]
[](#cb6-34)            )
[](#cb6-35)        return loss, logits
```

æ ¸å¿ƒæŸå¤±å‡½æ•°çœ‹èµ·æ¥ä¸ç»“æœå¥–åŠ±æ¨¡å‹éå¸¸ç›¸ä¼¼ï¼Œæ ‡ç­¾åº”ç”¨åœ¨ä¸åŒçš„é—´éš”ã€‚

```py
[](#cb7-1)# Assume model outputs 3-class logits per token
[](#cb7-2)hidden = model.lm(**inputs, output_hidden_states=True).hidden_states[-1]
[](#cb7-3)logits = model.head(hidden)  # (batch, seq_len, 3)
[](#cb7-4)
[](#cb7-5)# 3-class labels at step boundaries only: 0=-1, 1=0, 2=1 (others masked as -100)
[](#cb7-6)mask = labels != -100
[](#cb7-7)loss = F.cross_entropy(logits[mask], labels[mask])
```

## å¥–åŠ±æ¨¡å‹ vs. ç»“æœ RM vs. è¿‡ç¨‹ RM vs. ä»·å€¼å‡½æ•°

æ¶µç›–çš„å„ç§å¥–åŠ±æ¨¡å‹ç±»å‹è¡¨æ˜äº†åœ¨ RLHF å’Œå…¶ä»–åè®­ç»ƒæ–¹æ³•ä¸­â€œè´¨é‡â€å¯ä»¥è¡¡é‡çš„èŒƒå›´ã€‚ä»¥ä¸‹æ˜¯å¯¹æ¨¡å‹é¢„æµ‹å†…å®¹å’Œè®­ç»ƒæ–¹å¼çš„æ€»ç»“ã€‚

è¡¨ 4ï¼šæ¯”è¾ƒå¥–åŠ±æ¨¡å‹ç±»å‹ã€‚

| æ¨¡å‹ç±»åˆ« | é¢„æµ‹çš„å†…å®¹ | è®­ç»ƒæ–¹å¼ | LM ç»“æ„ |
| --- | --- | --- | --- |
| **å¥–åŠ±æ¨¡å‹** | é€šè¿‡ EOS æ ‡è®°é€‰æ‹©çš„å“åº”çš„æ¦‚ç‡æ¥è¡¡é‡æ–‡æœ¬è´¨é‡ | åœ¨å®Œæˆä¹‹é—´çš„æˆå¯¹ï¼ˆæˆ– N-wiseï¼‰æ¯”è¾ƒçš„å¯¹æ¯”æŸå¤± | åœ¨ LM ç‰¹å¾ä¹‹ä¸Šçš„å›å½’æˆ–åˆ†ç±»å¤´éƒ¨ |
| **ç»“æœå¥–åŠ±æ¨¡å‹** | æ¯ä¸ªæ ‡è®°çš„æ­£ç¡®ç­”æ¡ˆæ¦‚ç‡ | æ ‡è®°çš„ç»“æœå¯¹ï¼ˆä¾‹å¦‚ï¼Œåœ¨å¯éªŒè¯é¢†åŸŸä¸Šçš„æˆåŠŸ/å¤±è´¥ï¼‰ | æ¯ä¸ªæ ‡è®°çš„è¯­è¨€æ¨¡å‹äº¤å‰ç†µï¼Œå…¶ä¸­æ¯ä¸ªæ ‡ç­¾éƒ½æ˜¯ç»“æœçº§åˆ«æ ‡ç­¾ |
| **è¿‡ç¨‹å¥–åŠ±æ¨¡å‹** | æ¨ç†æ­¥éª¤ç»“æŸæ—¶çš„ä¸­é—´æ­¥éª¤çš„å¥–åŠ±æˆ–åˆ†æ•° | ä½¿ç”¨ä¸­é—´åé¦ˆæˆ–é€æ­¥æ³¨é‡Šï¼ˆæ¨ç†æ­¥éª¤ä¸­æ¯ token è®­ç»ƒï¼‰è¿›è¡Œè®­ç»ƒ | æ¯ä¸ªæ¨ç†æ­¥éª¤åªè¿è¡Œä¸€æ¬¡æ¨ç†çš„è¯­è¨€æ¨¡å‹å¤´éƒ¨ï¼Œé¢„æµ‹ä¸‰ä¸ªç±»åˆ« -1, 0, 1 |
| **ä»·å€¼å‡½æ•°** | ç»™å®šå½“å‰çŠ¶æ€ä¸‹çš„é¢„æœŸå›æŠ¥ | é€šè¿‡å›å½’åˆ°åºåˆ—ä¸­çš„æ¯ä¸ªç‚¹è¿›è¡Œè®­ç»ƒ | æ¯ token è¾“å‡ºä¸€ä¸ªåˆ†ç±» |

ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œé‰´äºä¸Šè¿°è¡¨æ ¼æœ‰è®¸å¤šè¾¹ç¼˜æƒ…å†µã€‚

+   åœ¨åå¥½è°ƒæ•´å’Œæ¨ç†è®­ç»ƒä¸­ï¼Œä»·å€¼å‡½æ•°é€šå¸¸æœ‰ä¸€ä¸ªæŠ˜æ‰£å› å­ä¸º 1ï¼Œè¿™ä½¿å¾—ä»·å€¼å‡½æ•°æ›´æ¥è¿‘ç»“æœå¥–åŠ±æ¨¡å‹ï¼Œä½†å…·æœ‰ä¸åŒçš„è®­ç»ƒæŸå¤±ã€‚

+   é€šè¿‡ä»ä¸­é—´çŠ¶æ€è¿›è¡Œå›æ»šå¹¶æ”¶é›†ç»“æœæ•°æ®æ¥ç›‘ç£è¿‡ç¨‹å¥–åŠ±æ¨¡å‹ã€‚è¿™èåˆäº†å¤šä¸ªæƒ³æ³•ï¼Œä½†å¦‚æœæŸå¤±æ˜¯æŒ‰æ¨ç†æ­¥éª¤æ ‡ç­¾è®¡ç®—çš„ï¼Œåˆ™æœ€å¥½å°†å…¶ç§°ä¸º PRMã€‚

## ç”Ÿæˆå¥–åŠ±å»ºæ¨¡

ç”±äºåå¥½æ•°æ®çš„æˆæœ¬ï¼Œå‡ºç°äº†ä¸€ä¸ªå¤§å‹ç ”ç©¶é¢†åŸŸï¼Œå³ä½¿ç”¨ç°æœ‰çš„è¯­è¨€æ¨¡å‹ä½œä¸ºäººç±»åå¥½çš„è¯„åˆ¤è€…æˆ–åœ¨å…¶ä»–è¯„ä¼°ç¯å¢ƒä¸­ [[131]](ch021.xhtml#ref-zheng2023judging)ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å‘è¯­è¨€æ¨¡å‹æä¾›å¦‚ä½•è¯„åˆ¤çš„æŒ‡ä»¤ï¼Œä¸€ä¸ªæç¤ºï¼Œä»¥åŠä¸¤ä¸ªå®Œæˆï¼ˆå°±åƒå¯¹äººç±»æ ‡æ³¨è€…æ‰€åšçš„é‚£æ ·ï¼‰ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹æç¤ºï¼Œæ¥è‡ªè¿™é‡Œçš„ä¸€ä¸ªå¼€åˆ›æ€§å·¥ä½œï¼Œç”¨äºèŠå¤©è¯„ä¼° MT-Bench [[131]](ch021.xhtml#ref-zheng2023judging)ï¼š

```py
[System]
Please act as an impartial judge and evaluate the quality of the responses provided by two AI assistants to the user question displayed below.
You should choose the assistant that follows the user's instructions and answers the user's question better.
Your evaluation should consider factors such as the helpfulness, relevance, accuracy, depth, creativity, and level of detail of their responses.
Begin your evaluation by comparing the two responses and provide a short explanation.
Avoid any position biases and ensure that the order in which the responses were presented does not influence your decision.
Do not allow the length of the responses to influence your evaluation.
Do not favor certain names of the assistants.
Be as objective as possible.
After providing your explanation, output your final verdict by strictly following this format: "[[A]]" if assistant A is better, "[[B]]" if assistant B is better, and "[[C]]" for a tie.
[User Question]
{question}
[The Start of Assistant A's Answer]
{answer_a}
[The End of Assistant A's Answer]
[The Start of Assistant B's Answer]
{answer_b}
[The End of Assistant B's Answer]
```

ç”±äº LLM-as-a-judge åœ¨è¯„ä¼°ä¸­çš„æœ‰æ•ˆæ€§ï¼Œå‚¬ç”Ÿäº†è®¸å¤šå…¶ä»–è¯„ä¼°ï¼Œå¦‚ AlpacaEval [[132]](ch021.xhtml#ref-dubois2024length)ã€Arena-Hard [[133]](ch021.xhtml#ref-li2024crowdsourced)å’Œ WildBench [[134]](ch021.xhtml#ref-lin2024wildbench)ï¼Œè®¸å¤šäººå¼€å§‹ä½¿ç”¨ LLM-as-a-judge è€Œä¸æ˜¯å¥–åŠ±æ¨¡å‹æ¥åˆ›å»ºå’Œä½¿ç”¨åå¥½æ•°æ®ã€‚

å‡ºç°äº†ä¸€ä¸ªç ”ç©¶é¢†åŸŸï¼Œä¸“é—¨ç ”ç©¶å¦‚ä½•ä½¿ç”¨æ‰€è°“çš„â€œç”Ÿæˆå¥–åŠ±æ¨¡å‹â€ [[135]](ch021.xhtml#ref-mahan2024generative) [[136]](ch021.xhtml#ref-zhang2024generative) [[137]](ch021.xhtml#ref-ankner2024critique)ï¼ˆåŒ…æ‹¬ä¸“é—¨è®­ç»ƒä»¥æˆä¸ºæœ‰æ•ˆè¯„åˆ¤è€…çš„æ¨¡å‹ [[138]](ch021.xhtml#ref-kim2023prometheus)ï¼‰ï¼Œä½†åœ¨ RM è¯„ä¼°ä¸­ï¼Œå®ƒä»¬å¾€å¾€è½åäºç°æœ‰çš„å¥–åŠ±æ¨¡å‹ï¼Œè¿™è¡¨æ˜å¥–åŠ±å»ºæ¨¡æ˜¯å½“å‰ RLHF çš„é‡è¦æŠ€æœ¯ã€‚

æé«˜ LLM-as-a-judge å·¥ä½œæµç¨‹é²æ£’æ€§çš„ä¸€ä¸ªå¸¸è§æŠ€å·§æ˜¯ä½¿ç”¨ 0 çš„é‡‡æ ·æ¸©åº¦ä»¥å‡å°‘è¯„åˆ†çš„æ–¹å·®ã€‚

## è¿›ä¸€æ­¥é˜…è¯»

å¥–åŠ±å»ºæ¨¡çš„å­¦æœ¯æ–‡çŒ®åœ¨ 2024 å¹´ç¡®ç«‹äº†è‡ªå·±ã€‚æ—©æœŸå¥–åŠ±å»ºæ¨¡çš„å¤§éƒ¨åˆ†è¿›å±•åœ¨äºå»ºç«‹åŸºå‡†å’Œè¯†åˆ«è¡Œä¸ºæ¨¡å¼ã€‚ç¬¬ä¸€ä¸ª RM åŸºå‡†ï¼ŒRewardBenchï¼Œä¸ºæµ‹è¯•å¥–åŠ±æ¨¡å‹æä¾›äº†å…±åŒçš„åŸºç¡€è®¾æ–½ [[139]](ch021.xhtml#ref-lambert2024rewardbench)ã€‚ä»é‚£æ—¶èµ·ï¼ŒRM è¯„ä¼°å·²ç»æ‰©å±•åˆ°ç±»ä¼¼äºå¯ç”¨äºé€šç”¨åè®­ç»ƒæ¨¡å‹çš„è¯„ä¼°ç±»å‹ï¼Œå…¶ä¸­ä¸€äº›è¯„ä¼°æµ‹è¯•äº†åœ¨å·²çŸ¥çœŸå®ç­”æ¡ˆçš„é¢†åŸŸæˆ–ä¸â€œæ„Ÿè§‰â€æ›´ç›¸ä¼¼çš„é¢†åŸŸä¸Šçš„é¢„æµ‹å‡†ç¡®æ€§ [[139]](ch021.xhtml#ref-lambert2024rewardbench) æˆ–ä¸ LLM ä½œä¸ºè£åˆ¤æˆ–ä¸å…¶ä»–åŸºå‡†çš„ç›¸å…³æ€§ [[140]](ch021.xhtml#ref-wen2024rethinking)ã€‚

æ–°åŸºå‡†çš„ä¾‹å­åŒ…æ‹¬ï¼š

+   **çº¯æ–‡æœ¬ï¼ˆé€šç”¨èŠå¤©/åå¥½ï¼‰ï¼š** RMB [[141]](ch021.xhtml#ref-zhou2024rmb)ï¼ŒRewardBench2 [[112]](ch021.xhtml#ref-malik2025rewardbench)ï¼Œåå¥½ä»£ç†è¯„ä¼° [[142]](ch021.xhtml#ref-frick2024evaluate)ï¼Œæˆ– RM-Bench [[143]](ch021.xhtml#ref-liu2024rm)ã€‚

+   **ä¸“é—¨åŒ–çš„çº¯æ–‡æœ¬ï¼ˆæ•°å­¦ç­‰ï¼‰ï¼š** å¤šè¯­è¨€å¥–åŠ±åŸºå‡† (M-RewardBench) [[144]](ch021.xhtml#ref-gureja2024m)ï¼Œç”¨äºæ£€ç´¢å¢å¼ºç”Ÿæˆ (RAG) çš„ RAG-RewardBench [[145]](ch021.xhtml#ref-jin2024rag)ï¼Œç”¨äºæ‹¼å†™é”™è¯¯çš„ ReWordBench [[146]](ch021.xhtml#ref-wu2025rewordbench)ï¼ŒRewardMATH [[147]](ch021.xhtml#ref-kim2024evaluating)ï¼Œæˆ– AceMath-RewardBench [[148]](ch021.xhtml#ref-liu2024acemath)ã€‚

+   **è¿‡ç¨‹ RMsï¼š** PRM Bench [[149]](ch021.xhtml#ref-song2025prmbench) æˆ– ProcessBench [[150]](ch021.xhtml#ref-zheng2024processbench) ä»¥åŠ VisualProcessBench [[151]](ch021.xhtml#ref-wang2025visualprm) æˆ– ViLBench [[152]](ch021.xhtml#ref-tu2025vilbench) çš„è§†è§‰åŸºå‡†ã€‚

+   **ä»£ç†å¼ RMsï¼š** Agent-RewardBench [[153]](ch021.xhtml#ref-men2025agentrewardbench) æˆ– CUARewardBench [[154]](ch021.xhtml#ref-lin2025cuarewardbench)ã€‚

+   **å¤šæ¨¡æ€ï¼š** MJ-Bench [[155]](ch021.xhtml#ref-chen2024mj), å¤šæ¨¡æ€å¥–åŠ±åŸºå‡† [[156]](ch021.xhtml#ref-yasunaga2025multimodal), VL å¥–åŠ±åŸºå‡† [[157]](ch021.xhtml#ref-li2024vlrewardbench), æˆ– VLRMBench [[158]](ch021.xhtml#ref-ruan2025vlrmbench)ã€‚

è¦äº†è§£å¥–åŠ±æ¨¡å‹è®­ç»ƒçš„è¿›å±•ï¼Œå¯ä»¥å‚è€ƒæ–°çš„å¥–åŠ±æ¨¡å‹è®­ç»ƒæ–¹æ³•ï¼ŒåŒ…æ‹¬æ–¹é¢æ¡ä»¶æ¨¡å‹ [[159]](ch021.xhtml#ref-wang2024interpretable)ï¼Œé«˜è´¨é‡çš„äººç±»æ•°æ®é›† [[160]](ch021.xhtml#ref-wang2024helpsteer2) [[111]](ch021.xhtml#ref-wang2024helpsteer2p)ï¼Œæ‰©å±•å®éªŒ [[25]](ch021.xhtml#ref-adler2024nemotron)ï¼Œå¹¿æ³›çš„å®éªŒ [[44]](ch021.xhtml#ref-touvron2023llama)ï¼Œæˆ–å»åæ•°æ® [[161]](ch021.xhtml#ref-park2024offsetbias)ã€‚
