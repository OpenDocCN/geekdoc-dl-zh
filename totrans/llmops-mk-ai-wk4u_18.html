<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2.7 Chatbots with LangChain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>2.7 Chatbots with LangChain</h1>
<blockquote>原文：<a href="https://boramorka.github.io/LLM-Book/en/CHAPTER-2/2.7%20Chatbots%20with%20LangChain/">https://boramorka.github.io/LLM-Book/en/CHAPTER-2/2.7%20Chatbots%20with%20LangChain/</a></blockquote>
                
                  


  
  



<p>This chapter is about building and optimizing conversational chatbots with LangChain — a toolkit that connects language models to retrieval systems for dynamic QA. We take a practical route: set up the environment and load documents, build a vector store, choose advanced retrieval strategies, and add conversation memory so the bot maintains context and answers follow‑ups confidently. Conversational bots transform data interaction: instead of independent turns, they track and remember the dialogue, and LangChain’s modular architecture lets you plug in loaders (80+ formats), chunking, embeddings, semantic search, self‑query, and contextual compression step by step. One important detail is early environment and variable setup: observability and careful key handling speed up debugging and operations. We then assemble the core — the Conversational Retrieval Chain — combining the language model, retriever, and memory, and show how buffer memory preserves the sequence of messages and passes it along with new questions to keep the dialogue natural and coherent.</p>
<p>Start by initializing the environment and API keys to safely use cloud LLMs and prepare the interface:</p>
<div class="highlight"><pre><span/><code><span class="c1"># Import environment and API helpers</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span><span class="p">,</span> <span class="n">find_dotenv</span>

<span class="c1"># Ensure Panel is available for interactive apps</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">panel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pn</span>
<span class="n">pn</span><span class="o">.</span><span class="n">extension</span><span class="p">()</span>

<span class="c1"># Load environment variables (including the OpenAI API key)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">load_dotenv</span><span class="p">(</span><span class="n">find_dotenv</span><span class="p">())</span>

<span class="c1"># OPENAI_API_KEY is read by integrations automatically; no direct assignment required</span>
</code></pre></div>
<p>Pick a language model version and fix it for the demo:</p>
<div class="highlight"><pre><span/><code><span class="c1"># Choose a model version</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="n">language_model_version</span> <span class="o">=</span> <span class="s2">"gpt-3.5-turbo"</span>
<span class="nb">print</span><span class="p">(</span><span class="n">language_model_version</span><span class="p">)</span>
</code></pre></div>
<p>Now connect embeddings and a vector store for baseline QA: load/index documents, retrieve relevant fragments, and prepare the model for answers. Then define a prompt template and assemble a RetrievalQA chain that will use your retriever and craft contextual answers:</p>
<div class="highlight"><pre><span/><code><span class="c1"># Embeddings and vector store</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.vectorstores</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chroma</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>

<span class="c1"># Replace 'your_directory_path' with the directory where you will persist embeddings</span>
<span class="n">persist_directory</span> <span class="o">=</span> <span class="s1">'your_directory_path/'</span>
<span class="n">embedding_function</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">()</span>
<span class="n">vector_database</span> <span class="o">=</span> <span class="n">Chroma</span><span class="p">(</span><span class="n">persist_directory</span><span class="o">=</span><span class="n">persist_directory</span><span class="p">,</span> <span class="n">embedding_function</span><span class="o">=</span><span class="n">embedding_function</span><span class="p">)</span>

<span class="c1"># Query the vector store</span>
<span class="n">search_question</span> <span class="o">=</span> <span class="s2">"What are the key subjects covered in this course?"</span>
<span class="n">top_documents</span> <span class="o">=</span> <span class="n">vector_database</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="n">search_question</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Relevant documents found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_documents</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Initialize a chat model and try a simple greeting</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="n">language_model</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">'gpt-4o-mini'</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">greeting_response</span> <span class="o">=</span> <span class="n">language_model</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">"Greetings, universe!"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">greeting_response</span><span class="p">)</span>

<span class="c1"># Prompt for concise, helpful answers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="n">prompt_template</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">Use the following pieces of context to answer the question at the end. If you're unsure about the answer, indicate so rather than speculating. </span>
<span class="s2">Try to keep your response within three sentences for clarity and conciseness. </span>
<span class="s2">End your answer with "thanks for asking!" to maintain a polite tone.</span>

<span class="s2">Context: </span><span class="si">{context}</span>
<span class="s2">Question: </span><span class="si">{question}</span>
<span class="s2">Helpful Answer:</span>
<span class="s2">"""</span>
<span class="n">qa_prompt_template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">"context"</span><span class="p">,</span> <span class="s2">"question"</span><span class="p">],</span> <span class="n">template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">)</span>

<span class="c1"># RetrievalQA chain</span>
<span class="n">default_question</span> <span class="o">=</span> <span class="s2">"Does this course require understanding of probability?"</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chains</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetrievalQA</span>
<span class="n">qa_chain</span> <span class="o">=</span> <span class="n">RetrievalQA</span><span class="o">.</span><span class="n">from_chain_type</span><span class="p">(</span>
    <span class="n">language_model</span><span class="p">,</span>
    <span class="n">retriever</span><span class="o">=</span><span class="n">vector_database</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(),</span>
    <span class="n">return_source_documents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">chain_type_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"prompt"</span><span class="p">:</span> <span class="n">qa_prompt_template</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">qa_result</span> <span class="o">=</span> <span class="n">qa_chain</span><span class="p">({</span><span class="s2">"query"</span><span class="p">:</span> <span class="n">default_question</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Result:"</span><span class="p">,</span> <span class="n">qa_result</span><span class="p">[</span><span class="s2">"result"</span><span class="p">])</span>
</code></pre></div>
<h3 id="implementing-a-conversational-retrieval-chain-with-memory-for-qa">Implementing a Conversational Retrieval Chain with Memory for QA</h3>
<p>This section targets ML engineers, data scientists, and developers building QA systems that understand and retain dialogue context. The focus is on integrating the Conversational Retrieval Chain with a memory component from LangChain.</p>
<h4 id="configure-memory-for-dialogue-history">Configure memory for dialogue history</h4>
<p>Use <code>ConversationBufferMemory</code> so the system remembers context. It stores message history and allows referring to prior turns for relevant follow‑ups.</p>
<div class="highlight"><pre><span/><code><span class="c1"># Conversation memory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationBufferMemory</span>

<span class="n">conversation_history_memory</span> <span class="o">=</span> <span class="n">ConversationBufferMemory</span><span class="p">(</span>
    <span class="n">memory_key</span><span class="o">=</span><span class="s2">"conversation_history"</span><span class="p">,</span>
    <span class="n">return_messages</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>
<h4 id="assemble-the-conversational-retrieval-chain">Assemble the Conversational Retrieval Chain</h4>
<p>Combine the language model, document retriever, and dialogue memory to answer questions in conversational context.</p>
<div class="highlight"><pre><span/><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chains</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationalRetrievalChain</span>

<span class="n">document_retriever</span> <span class="o">=</span> <span class="n">vector_database</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">()</span>

<span class="n">question_answering_chain</span> <span class="o">=</span> <span class="n">ConversationalRetrievalChain</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">language_model</span><span class="p">,</span>
    <span class="n">retriever</span><span class="o">=</span><span class="n">document_retriever</span><span class="p">,</span>
    <span class="n">memory</span><span class="o">=</span><span class="n">conversation_history_memory</span>
<span class="p">)</span>
</code></pre></div>
<h4 id="handle-questions-and-generate-answers">Handle questions and generate answers</h4>
<p>After setup, the chain can process questions and generate answers using the saved conversation history for context.</p>
<div class="highlight"><pre><span/><code><span class="n">initial_question</span> <span class="o">=</span> <span class="s2">"Is probability a fundamental topic in this course?"</span>
<span class="n">initial_result</span> <span class="o">=</span> <span class="n">question_answering_chain</span><span class="p">({</span><span class="s2">"question"</span><span class="p">:</span> <span class="n">initial_question</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Answer:"</span><span class="p">,</span> <span class="n">initial_result</span><span class="p">[</span><span class="s1">'answer'</span><span class="p">])</span>

<span class="n">follow_up_question</span> <span class="o">=</span> <span class="s2">"Why are those topics considered prerequisites?"</span>
<span class="n">follow_up_result</span> <span class="o">=</span> <span class="n">question_answering_chain</span><span class="p">({</span><span class="s2">"question"</span><span class="p">:</span> <span class="n">follow_up_question</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Answer:"</span><span class="p">,</span> <span class="n">follow_up_result</span><span class="p">[</span><span class="s1">'answer'</span><span class="p">])</span>
</code></pre></div>
<h3 id="building-a-documentgrounded-qa-chatbot">Building a Document‑Grounded QA Chatbot</h3>
<p>This part provides an end‑to‑end guide to a chatbot that answers questions based on document content. It covers loading documents, splitting text, embeddings, and assembling a conversational retrieval chain.</p>
<h4 id="initial-setup-and-imports">Initial setup and imports</h4>
<p>Import LangChain components for embeddings, text splitting, in‑memory search, document loading, conversational chains, and the chat model.</p>
<div class="highlight"><pre><span/><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.vectorstores</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocArrayInMemorySearch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.document_loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextLoader</span><span class="p">,</span> <span class="n">PyPDFLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chains</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationalRetrievalChain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
</code></pre></div>
<h4 id="load-and-process-documents">Load and process documents</h4>
<p>Load documents, split them into manageable chunks, generate embeddings, and prepare a vector store; then return a ready‑to‑use conversational retrieval chain.</p>
<div class="highlight"><pre><span/><code><span class="k">def</span><span class="w"> </span><span class="nf">load_documents_and_prepare_database</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">chain_type</span><span class="p">,</span> <span class="n">top_k_results</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Load documents from a file, split into manageable chunks, generate embeddings,</span>
<span class="sd">    and prepare a vector database for retrieval.</span>

<span class="sd">    Args:</span>
<span class="sd">    - file_path: Path to the document file (PDF, text, etc.).</span>
<span class="sd">    - chain_type: Conversational chain type to use.</span>
<span class="sd">    - top_k_results: Number of top results to retrieve.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - A conversational retrieval chain ready to answer questions.</span>
<span class="sd">    """</span>
    <span class="c1"># Load documents using a loader appropriate for the file type</span>
    <span class="n">document_loader</span> <span class="o">=</span> <span class="n">PyPDFLoader</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">document_loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="c1"># Split into chunks</span>
    <span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">document_chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>

    <span class="c1"># Embed chunks and build the vector store</span>
    <span class="n">embeddings_generator</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">()</span>
    <span class="n">vector_database</span> <span class="o">=</span> <span class="n">DocArrayInMemorySearch</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">document_chunks</span><span class="p">,</span> <span class="n">embeddings_generator</span><span class="p">)</span>

    <span class="c1"># Build the retriever</span>
    <span class="n">document_retriever</span> <span class="o">=</span> <span class="n">vector_database</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(</span><span class="n">search_type</span><span class="o">=</span><span class="s2">"similarity"</span><span class="p">,</span> <span class="n">search_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"k"</span><span class="p">:</span> <span class="n">top_k_results</span><span class="p">})</span>

    <span class="c1"># Create the conversational retrieval chain</span>
    <span class="n">chatbot_chain</span> <span class="o">=</span> <span class="n">ConversationalRetrievalChain</span><span class="o">.</span><span class="n">from_llm</span><span class="p">(</span>
        <span class="n">llm</span><span class="o">=</span><span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">'gpt-4o-mini'</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
        <span class="n">chain_type</span><span class="o">=</span><span class="n">chain_type</span><span class="p">,</span> 
        <span class="n">retriever</span><span class="o">=</span><span class="n">document_retriever</span><span class="p">,</span> 
        <span class="n">return_source_documents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_generated_question</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">chatbot_chain</span>
</code></pre></div>
<p>For convenience, add a thin wrapper used by the UI code:</p>
<div class="highlight"><pre><span/><code><span class="k">def</span><span class="w"> </span><span class="nf">load_db</span><span class="p">(</span><span class="n">document_path</span><span class="p">,</span> <span class="n">retrieval_type</span><span class="p">,</span> <span class="n">top_k_results</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">load_documents_and_prepare_database</span><span class="p">(</span><span class="n">document_path</span><span class="p">,</span> <span class="n">retrieval_type</span><span class="p">,</span> <span class="n">top_k_results</span><span class="p">)</span>
</code></pre></div>
<p>Proceed to create a chatbot and a Panel‑based UI: import Panel (<code>pn</code>) and Param (<code>param</code>), then define a class that encapsulates document loading, query processing, and history.</p>
<div class="highlight"><pre><span/><code><span class="kn">import</span><span class="w"> </span><span class="nn">panel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">param</span>
</code></pre></div>
<p>Define a chatbot class that stores history, forms answers, and allows swapping the base document.</p>
<div class="highlight"><pre><span/><code><span class="k">class</span><span class="w"> </span><span class="nc">DocumentBasedChatbot</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">Parameterized</span><span class="p">):</span>
    <span class="n">conversation_history</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">List</span><span class="p">([])</span>  <span class="c1"># (question, answer) pairs</span>
    <span class="n">current_answer</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>      <span class="c1"># Latest answer</span>
    <span class="n">database_query</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>      <span class="c1"># Query sent to the document DB</span>
    <span class="n">database_response</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">List</span><span class="p">([])</span>     <span class="c1"># Retrieved source documents</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DocumentBasedChatbot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface_elements</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># UI elements for the conversation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_document</span> <span class="o">=</span> <span class="s2">"your_document.pdf"</span>  <span class="c1"># Replace with your PDF path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot_model</span> <span class="o">=</span> <span class="n">load_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded_document</span><span class="p">,</span> <span class="s2">"retrieval_type"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Initialize the bot model</span>
</code></pre></div>
<p>Add document loading: <code>load_document</code> checks for a user file (or uses the default document), reloads the knowledge base, and clears history when the source changes.</p>
<div class="highlight"><pre><span/><code>    <span class="k">def</span><span class="w"> </span><span class="nf">load_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upload_count</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">upload_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">file_input</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Loaded document: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded_document</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_input</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"temp.pdf"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_document</span> <span class="o">=</span> <span class="n">file_input</span><span class="o">.</span><span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot_model</span> <span class="o">=</span> <span class="n">load_db</span><span class="p">(</span><span class="s2">"temp.pdf"</span><span class="p">,</span> <span class="s2">"retrieval_type"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_conversation_history</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Loaded document: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded_document</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
<p>Handle user turns: <code>process_query</code> sends the turn to the model, updates history and UI, and shows source snippets.</p>
<div class="highlight"><pre><span/><code>    <span class="k">def</span><span class="w"> </span><span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_query</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_query</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'User:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)),</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatbot_model</span><span class="p">({</span><span class="s2">"question"</span><span class="p">:</span> <span class="n">user_query</span><span class="p">,</span> <span class="s2">"chat_history"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">user_query</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">"answer"</span><span class="p">])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_query</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">"generated_question"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_response</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">"source_documents"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_answer</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">'answer'</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface_elements</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'User:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="n">user_query</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)),</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'Assistant:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_answer</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s1">'#F6F6F6'</span><span class="p">}))</span>
        <span class="p">])</span>
        <span class="n">input_field</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">''</span>  <span class="c1"># Clear input</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">interface_elements</span><span class="p">,</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>For transparency, display the last DB query and the retrieved source documents.</p>
<div class="highlight"><pre><span/><code>    <span class="k">def</span><span class="w"> </span><span class="nf">display_last_database_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_query</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
                <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">"Last database query:"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s1">'#F6F6F6'</span><span class="p">})),</span>
                <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s2">"No database queries yet"</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">"Database query:"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s1">'#F6F6F6'</span><span class="p">})),</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_query</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">display_database_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_response</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">response_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">"Vector DB search result:"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s1">'#F6F6F6'</span><span class="p">}))]</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_response</span><span class="p">:</span>
            <span class="n">response_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">doc</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="o">*</span><span class="n">response_list</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Optionally, display the current chat history for quick inspection.</p>
<div class="highlight"><pre><span/><code>    <span class="k">def</span><span class="w"> </span><span class="nf">display_chat_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'Chat:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s1">'No messages yet.'</span><span class="p">)),</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'User:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)))</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'Assistant:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s2">"#FAFAFA"</span><span class="p">})))</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">650</span><span class="p">,</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Don’t forget reset: <code>clear_conversation_history</code> clears the current dialogue context.</p>
<div class="highlight"><pre><span/><code>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_conversation_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
<p>The result is a cohesive method: you set up the environment and keys, load documents and assemble a vector store, add advanced retrieval (self‑query, compression, semantic search), integrate dialogue memory, and build a Conversational Retrieval Chain where model, retriever, and memory work together. The examples and code show how the steps form a working bot; thanks to LangChain’s modularity, the result is easy to extend and debug.</p>
<h2 id="theory-questions">Theory Questions</h2>
<ol>
<li>What components are needed to set up a LangChain chatbot development environment?</li>
<li>How does keeping dialogue history improve a chatbot’s functionality?</li>
<li>How are document chunks transformed into embeddings, and why?</li>
<li>Why are self‑query, compression, and semantic search useful?</li>
<li>How does the Conversational Retrieval Chain combine model, retriever, and memory?</li>
<li>How does ConversationBufferMemory help maintain dialogue context?</li>
<li>What are the steps to configure a vector store for semantic search in LangChain?</li>
<li>Why manage environment variables and API keys?</li>
<li>How does the modularity of LangChain’s retrieval methods increase development flexibility?</li>
<li>Why is choosing an appropriate LLM version important?</li>
</ol>
<h2 id="practical-tasks">Practical Tasks</h2>
<ol>
<li>Create and populate a vector store (<code>create_vector_store</code>) from a list of strings (use a stub embedding function <code>embed_document</code>).</li>
<li>Implement semantic search (<code>perform_semantic_search</code>): embed a query, find the nearest document, return its index.</li>
<li>Add dialogue history to a <code>Chatbot</code> class and a <code>respond_to_query</code> method (generate via a stub <code>generate_response</code>).</li>
<li>Assemble a simplified Conversational Retrieval Chain with stubs (<code>LanguageModel</code>/<code>DocumentRetriever</code>/<code>ConversationMemory</code>).</li>
<li>In <code>Chatbot</code>, add methods to append and reset history; incorporate history when generating.</li>
<li>Document QA: load a string, split it, create embeddings, build a vector store, run semantic search, and generate an answer (stubs allowed).</li>
<li>Integrate memory into the retrieval chain (use the extensions from tasks 5–6).</li>
<li>Build a small CLI for chatting with the <code>Chatbot</code>: send queries, print answers, view/reset history.</li>
</ol>
<h3 id="alternate-panel-ui-variant-and-dashboard">Alternate Panel UI Variant and Dashboard</h3>
<p>Below is an additional chatbot class and a ready-to-use Panel dashboard that mirrors the Russian version’s UI section.</p>
<div class="highlight"><pre><span/><code><span class="kn">import</span><span class="w"> </span><span class="nn">panel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">param</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ChatWithYourDataBot</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">Parameterized</span><span class="p">):</span>
    <span class="n">conversation_history</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">List</span><span class="p">([])</span>
    <span class="n">latest_answer</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">document_query</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">document_response</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">List</span><span class="p">([])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ChatWithYourDataBot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_document_path</span> <span class="o">=</span> <span class="s2">"your_document.pdf"</span>  <span class="c1"># Replace with your PDF path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot_model</span> <span class="o">=</span> <span class="n">load_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_document_path</span><span class="p">,</span> <span class="s2">"retrieval_mode"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div>
<p>Add minimal method implementations to support the bound UI actions and panels:</p>
<div class="highlight"><pre><span/><code>    <span class="k">def</span><span class="w"> </span><span class="nf">load_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clicks</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">document_upload</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Loaded document: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">default_document_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">document_upload</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"temp.pdf"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_document_path</span> <span class="o">=</span> <span class="n">document_upload</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_document_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot_model</span> <span class="o">=</span> <span class="n">load_db</span><span class="p">(</span><span class="s2">"temp.pdf"</span><span class="p">,</span> <span class="s2">"retrieval_mode"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_history</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Loaded document: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">default_document_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_query</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_query</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'User:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)),</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatbot_model</span><span class="p">({</span><span class="s2">"question"</span><span class="p">:</span> <span class="n">user_query</span><span class="p">,</span> <span class="s2">"chat_history"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">user_query</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"answer"</span><span class="p">,</span> <span class="s2">""</span><span class="p">))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document_query</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"generated_question"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document_response</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"source_documents"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_answer</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'answer'</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface_elements</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'User:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="n">user_query</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)),</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'Assistant:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_answer</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s2">"#F6F6F6"</span><span class="p">}))</span>
        <span class="p">])</span>
        <span class="n">user_query_input</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">interface_elements</span><span class="p">,</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">display_last_database_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_query</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
                <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">"Last database query:"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s2">"#F6F6F6"</span><span class="p">})),</span>
                <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s2">"No database queries yet"</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">"Database query:"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s2">"#F6F6F6"</span><span class="p">})),</span>
            <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document_query</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">display_database_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_response</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">"Vector DB search result:"</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s2">"#F6F6F6"</span><span class="p">}))]</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document_response</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">doc</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">display_chat_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'Chat:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s1">'No messages yet.'</span><span class="p">)),</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'User:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)))</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="s1">'Assistant:'</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">'background-color'</span><span class="p">:</span> <span class="s2">"#FAFAFA"</span><span class="p">})))</span>
        <span class="k">return</span> <span class="n">pn</span><span class="o">.</span><span class="n">WidgetBox</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">650</span><span class="p">,</span> <span class="n">scroll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
<p>Create widgets and bind actions:</p>
<div class="highlight"><pre><span/><code><span class="n">document_upload</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">accept</span><span class="o">=</span><span class="s1">'.pdf'</span><span class="p">)</span>
<span class="n">load_database_button</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Load document"</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">'primary'</span><span class="p">)</span>
<span class="n">clear_history_button</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Clear history"</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s1">'warning'</span><span class="p">)</span>
<span class="n">clear_history_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">ChatWithYourDataBot</span><span class="o">.</span><span class="n">clear_history</span><span class="p">)</span>
<span class="n">user_query_input</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span><span class="n">placeholder</span><span class="o">=</span><span class="s1">'Type your question here…'</span><span class="p">)</span>

<span class="n">load_document_action</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ChatWithYourDataBot</span><span class="o">.</span><span class="n">load_document</span><span class="p">,</span> <span class="n">load_database_button</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">clicks</span><span class="p">)</span>
<span class="n">process_query</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ChatWithYourDataBot</span><span class="o">.</span><span class="n">process_query</span><span class="p">,</span> <span class="n">user_query_input</span><span class="p">)</span>
</code></pre></div>
<p>Assemble tabs and the dashboard:</p>
<div class="highlight"><pre><span/><code><span class="c1"># Optional: Add a conversation flow diagram image if available</span>
<span class="c1"># conversation_visual = pn.pane.Image('path/to/your/conversation_flow.jpg')</span>

<span class="n">conversation_tab</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">user_query_input</span><span class="p">),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">(),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">process_query</span><span class="p">,</span> <span class="n">loading_indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">database_query_tab</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">ChatWithYourDataBot</span><span class="o">.</span><span class="n">display_last_database_query</span><span class="p">),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">(),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">ChatWithYourDataBot</span><span class="o">.</span><span class="n">display_database_responses</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">chat_history_tab</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">panel</span><span class="p">(</span><span class="n">ChatWithYourDataBot</span><span class="o">.</span><span class="n">display_chat_history</span><span class="p">),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">configuration_tab</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">document_upload</span><span class="p">,</span> <span class="n">load_database_button</span><span class="p">,</span> <span class="n">load_document_action</span><span class="p">),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">clear_history_button</span><span class="p">,</span> <span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s2">"Clears the conversation for a new topic."</span><span class="p">)),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Divider</span><span class="p">(),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">conversation_visual</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">)),</span>
<span class="p">)</span>

<span class="n">chatbot_dashboard</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">pn</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s1">'# ChatWithYourDat-Bot'</span><span class="p">)),</span>
    <span class="n">pn</span><span class="o">.</span><span class="n">Tabs</span><span class="p">((</span><span class="s1">'Conversation'</span><span class="p">,</span> <span class="n">conversation_tab</span><span class="p">),</span> <span class="p">(</span><span class="s1">'DB queries'</span><span class="p">,</span> <span class="n">database_query_tab</span><span class="p">),</span> <span class="p">(</span><span class="s1">'Chat history'</span><span class="p">,</span> <span class="n">chat_history_tab</span><span class="p">),</span> <span class="p">(</span><span class="s1">'Setup'</span><span class="p">,</span> <span class="n">configuration_tab</span><span class="p">))</span>
<span class="p">)</span>
</code></pre></div>
<p>This completes the UI parity with the Russian chapter while keeping the English text clear and idiomatic.</p>












                
                  
</body>
</html>