<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>1.5 The Power of Prompt Chaining</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>1.5 The Power of Prompt Chaining</h1>
<blockquote>原文：<a href="https://boramorka.github.io/LLM-Book/en/CHAPTER-1/1.5%20The%20Power%20of%20Prompt%20Chaining/">https://boramorka.github.io/LLM-Book/en/CHAPTER-1/1.5%20The%20Power%20of%20Prompt%20Chaining/</a></blockquote>
                
                  


  
  



<p>Prompt chaining solves complex tasks through a sequence of simple, interconnected steps. Instead of one “monolithic” request, you build a chain of small prompts: each step solves a specific subtask and prepares context for the next. This reduces errors, makes model behavior more controllable, and increases observability: it’s easier to see where and why a mistake happened and to intervene precisely. It’s like cooking a complex dish step by step or using modular architecture in software — it’s always easier to debug and maintain a series of small, clear operations than a single spaghetti‑like step.</p>
<p>Practical benefits are clear: you can orchestrate the workflow by checkpointing state at each step and adapting the next step to the previous result; save context and budget, since long prompts cost more while each chain step uses only the minimum needed; reduce errors by isolating the problem; and load only relevant information, respecting LLM context limits. Methodologically, this means decomposing the task, explicitly managing state between steps, designing each prompt for a narrow focus, adding tools for loading and pre‑processing data, and dynamically injecting only the context fragments needed right now. Best practices are simple: don’t overcomplicate when a single prompt suffices; be clear; keep and update external context; think about efficiency (quality, cost, latency); and test the chain end to end.</p>
<p>Below is a sequential example that assembles an end‑to‑end scenario: entity extraction, querying a simple “database”, parsing JSON, and composing a user‑facing answer — then tying it all together into a single support flow.</p>
<div class="highlight"><pre><span/><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span><span class="p">,</span> <span class="n">find_dotenv</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">load_dotenv</span><span class="p">(</span><span class="n">find_dotenv</span><span class="p">())</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
</code></pre></div>
<p>Now extract entities from a user request. The first step sets the task and output format in a system instruction. The user input is bounded by delimiters, which makes it easier to control data boundaries and pass the result along the chain.</p>
<div class="highlight"><pre><span/><code><span class="k">def</span><span class="w"> </span><span class="nf">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">"gpt-4o-mini"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">message_sequence</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>

<span class="n">system_instruction</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">You will receive support requests. The request is delimited by '####'.</span>
<span class="s2">Return a Python list of objects, each representing a product or category mentioned in the request.</span>
<span class="s2">"""</span>

<span class="n">user_query</span> <span class="o">=</span> <span class="s2">"#### Tell me about the SmartX ProPhone and the FotoSnap DSLR Camera, and also about your televisions ####"</span>

<span class="n">message_sequence</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">user_query</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">extracted_info</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extracted_info</span><span class="p">)</span>
</code></pre></div>
<p>Next, plug in a data source and find the specific products or categories. Even an in‑memory “database” demonstrates the idea: extract entities → move to structured data → prepare facts for the answer.</p>
<div class="highlight"><pre><span/><code><span class="n">product_database</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"TechPro Ultrabook"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"TechPro Ultrabook"</span><span class="p">,</span>
        <span class="s2">"category"</span><span class="p">:</span> <span class="s2">"Computers and Laptops"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c1"># ...</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_product_details_by_name</span><span class="p">(</span><span class="n">product_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">product_database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">product_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_products_in_category</span><span class="p">(</span><span class="n">category_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">product_database</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">"category"</span><span class="p">]</span> <span class="o">==</span> <span class="n">category_name</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_product_details_by_name</span><span class="p">(</span><span class="s2">"TechPro Ultrabook"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_products_in_category</span><span class="p">(</span><span class="s2">"Computers and Laptops"</span><span class="p">))</span>
</code></pre></div>
<p>On the next step, convert JSON strings that the model might return during entity extraction into Python objects for downstream chain steps.</p>
<div class="highlight"><pre><span/><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">def</span><span class="w"> </span><span class="nf">json_string_to_python_list</span><span class="p">(</span><span class="n">json_string</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">json_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_string</span> <span class="o">=</span> <span class="n">json_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"'"</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Error: Invalid JSON string"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">json_input</span> <span class="o">=</span> <span class="s2">"[{</span><span class="se">\"</span><span class="s2">category</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">Smartphones and Accessories</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">products</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">SmartX ProPhone</span><span class="se">\"</span><span class="s2">]}]"</span>
<span class="n">python_list</span> <span class="o">=</span> <span class="n">json_string_to_python_list</span><span class="p">(</span><span class="n">json_input</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">python_list</span><span class="p">)</span>
</code></pre></div>
<p>Finally, compose a concise user‑facing answer from the resulting structures. You can swap this formatting layer for templates, localization, or generation tuned to your UX.</p>
<div class="highlight"><pre><span/><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_response_from_data</span><span class="p">(</span><span class="n">product_data_list</span><span class="p">):</span>
    <span class="n">response_string</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">if</span> <span class="n">product_data_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response_string</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">product_data_list</span><span class="p">:</span>
        <span class="n">response_string</span> <span class="o">+=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">response_string</span>

<span class="n">response_instruction</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">You are a support assistant. Answer briefly and ask clarifying questions when needed.</span>
<span class="s2">"""</span>

<span class="n">final_response</span> <span class="o">=</span> <span class="n">generate_response_from_data</span><span class="p">(</span><span class="n">python_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">final_response</span><span class="p">)</span>
</code></pre></div>
<p>We’ll finish with an end‑to‑end support scenario: first detect interest in photography, then provide troubleshooting, clarify warranty coverage, and end with accessory recommendations — four steps in one chain, each building on the previous result.</p>
<div class="highlight"><pre><span/><code><span class="n">system_instruction</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">You will receive support requests delimited by '####'.</span>
<span class="s2">Return a list of objects: the mentioned products/categories.</span>
<span class="s2">"""</span>

<span class="n">user_query_1</span> <span class="o">=</span> <span class="s2">"#### I'm interested in upgrading my photography gear. Can you tell me about the latest DSLR cameras and compatible accessories? ####"</span>

<span class="n">message_sequence_1</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">user_query_1</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">response_1</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Product query response:"</span><span class="p">,</span> <span class="n">response_1</span><span class="p">)</span>

<span class="n">troubleshooting_query</span> <span class="o">=</span> <span class="s2">"#### I just bought the FotoSnap DSLR Camera you recommended, but I'm having trouble connecting it to my smartphone. What should I do? ####"</span>
<span class="n">system_instruction_troubleshooting</span> <span class="o">=</span> <span class="s2">"Provide step‑by‑step troubleshooting advice for the customer’s issue."</span>
<span class="n">message_sequence_2</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction_troubleshooting</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">troubleshooting_query</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">response_2</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Troubleshooting response:"</span><span class="p">,</span> <span class="n">response_2</span><span class="p">)</span>

<span class="n">follow_up_query</span> <span class="o">=</span> <span class="s2">"#### Also, could you clarify what the warranty covers for the FotoSnap DSLR Camera? ####"</span>
<span class="n">system_instruction_follow_up</span> <span class="o">=</span> <span class="s2">"Provide detailed information about the product’s warranty coverage."</span>
<span class="n">message_sequence_3</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction_follow_up</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">follow_up_query</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">response_3</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Warranty information response:"</span><span class="p">,</span> <span class="n">response_3</span><span class="p">)</span>

<span class="n">additional_assistance_query</span> <span class="o">=</span> <span class="s2">"#### Given your interest in photography, would you like recommendations for lenses and tripods compatible with the FotoSnap DSLR Camera? ####"</span>
<span class="n">system_instruction_additional_assistance</span> <span class="o">=</span> <span class="s2">"Suggest accessories that complement the user’s existing products."</span>
<span class="n">message_sequence_4</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction_additional_assistance</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">additional_assistance_query</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">response_4</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Additional assistance response:"</span><span class="p">,</span> <span class="n">response_4</span><span class="p">)</span>
</code></pre></div>
<p>In the end, prompt chaining gives you a robust and understandable workflow: it saves context and budget, localizes errors more precisely, and preserves flexibility to tailor the answer to the user’s task.</p>
<h2 id="theory-questions">Theory Questions</h2>
<ol>
<li>What is prompt chaining and how does it differ from using one long prompt?</li>
<li>Provide two analogies and explain how they map to chaining.</li>
<li>How does chaining help manage workflow?</li>
<li>Where do the savings come from when using chaining?</li>
<li>How does chaining reduce errors on complex tasks?</li>
<li>Why is dynamic data loading useful given LLM context limits?</li>
<li>Describe a step‑by‑step methodology for chaining and the role of each step.</li>
<li>List best practices that ensure chaining efficiency.</li>
<li>Which libraries are used in the example and for what?</li>
<li>How does the system message guide the model’s answer?</li>
<li>What is the role of the product database, and how do you query it?</li>
<li>Why convert JSON strings to Python objects, and how?</li>
<li>How does formatting answers from processed data improve service quality?</li>
<li>How does the end‑to‑end scenario demonstrate adapting to user needs via chaining?</li>
</ol>
<h2 id="practical-tasks">Practical Tasks</h2>
<ol>
<li>Implement <code>retrieve_model_response</code> with <code>model</code>, <code>temperature</code>, and <code>max_tokens</code> parameters.</li>
<li>Show an entity‑extraction example using a system instruction.</li>
<li>Create a mini product database and functions to query by name or category.</li>
<li>Implement JSON‑to‑Python list conversion with error handling.</li>
<li>Write <code>generate_response_from_data</code> that formats a data list into a user‑friendly answer.</li>
<li>Compose an end‑to‑end support scenario (query → troubleshooting → warranty → recommendations) based on the functions above.</li>
</ol>












                
                  
</body>
</html>