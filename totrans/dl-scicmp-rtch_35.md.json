["```r\nlibrary(torch)\nlibrary(ggplot2)\nlibrary(patchwork)\nlibrary(tidyr)\nlibrary(zeallot)\n\nmorlet <- function(omega, K, t_k, t) {\n (torch_exp(-1i * omega * (t - t_k)) -\n torch_exp(-torch_square(K))) *\n torch_exp(-torch_square(omega) * torch_square(t - t_k) /\n torch_square(2 * K))\n}\n```", "```r\nomega <- 6 * pi\nK <- 6\nt_k <- 5\n\nsample_time <- torch_arange(3, 7, 0.0001)\n\ncreate_wavelet_plot <- function(omega, K, t_k, sample_time) {\n morlet <- morlet(omega, K, t_k, sample_time)\n df <- data.frame(\n x = as.numeric(sample_time),\n real = as.numeric(morlet$real),\n imag = as.numeric(morlet$imag)\n ) %>%\n pivot_longer(-x, names_to = \"part\", values_to = \"value\")\n ggplot(df, aes(x = x, y = value, color = part)) +\n geom_line() +\n scale_colour_grey(start = 0.8, end = 0.4) +\n xlab(\"time\") +\n ylab(\"wavelet value\") +\n ggtitle(\"Morlet wavelet\",\n subtitle = paste0(\"ω_a = \", omega / pi, \"π , K = \", K)\n ) +\n theme_minimal()\n}\n\ncreate_wavelet_plot(omega, K, t_k, sample_time)\n```", "```r\np1 <- create_wavelet_plot(6 * pi, 4, 5, sample_time)\np2 <- create_wavelet_plot(6 * pi, 6, 5, sample_time)\np3 <- create_wavelet_plot(6 * pi, 8, 5, sample_time)\np4 <- create_wavelet_plot(4 * pi, 6, 5, sample_time)\np5 <- create_wavelet_plot(6 * pi, 6, 5, sample_time)\np6 <- create_wavelet_plot(8 * pi, 6, 5, sample_time)\n\n(p1 | p4) /\n (p2 | p5) /\n (p3 | p6)\n```", "```r\nwavelet_transform <- function(x, omega, K) {\n n_samples <- dim(x)[1]\n W <- torch_complex(\n torch_zeros(n_samples), torch_zeros(n_samples)\n )\n for (i in 1:n_samples) {\n # move center of wavelet\n t_k <- x[i, 1]\n m <- morlet(omega, K, t_k, x[, 1])\n # compute local dot product\n # note wavelet is conjugated\n dot <- torch_matmul(\n m$conj()$unsqueeze(1),\n x[, 2]$to(dtype = torch_cfloat())\n )\n W[i] <- dot\n }\n W\n}\n```", "```r\ngencos <- function(amp, freq, phase, fs, duration) {\n x <- torch_arange(0, duration, 1 / fs)[1:-2]$unsqueeze(2)\n y <- amp * torch_cos(2 * pi * freq * x + phase)\n torch_cat(list(x, y), dim = 2)\n}\n\n# sampling frequency\nfs <- 8000\n\nf1 <- 100\nf2 <- 200\nphase <- 0\nduration <- 0.25\n\ns1 <- gencos(1, f1, phase, fs, duration)\ns2 <- gencos(1, f2, phase, fs, duration)\n\ns3 <- torch_cat(list(s1, s2), dim = 1)\ns3[(dim(s1)[1] + 1):(dim(s1)[1] * 2), 1] <-\n s3[(dim(s1)[1] + 1):(dim(s1)[1] * 2), 1] + duration\n\ndf <- data.frame(\n x = as.numeric(s3[, 1]),\n y = as.numeric(s3[, 2])\n)\nggplot(df, aes(x = x, y = y)) +\n geom_line() +\n xlab(\"time\") +\n ylab(\"amplitude\") +\n theme_minimal()\n```", "```r\nK <- 2\nomega <- 2 * pi * f1\n\nres <- wavelet_transform(x = s3, omega, K)\ndf <- data.frame(\n x = as.numeric(s3[, 1]),\n y = as.numeric(res$abs())\n)\n\nggplot(df, aes(x = x, y = y)) +\n geom_line() +\n xlab(\"time\") +\n ylab(\"Wavelet Transform\") +\n theme_minimal()\n```", "```r\nK <- 20\n\nres <- wavelet_transform(x = s3, omega, K)\ndf <- data.frame(\n x = as.numeric(s3[, 1]),\n y = as.numeric(res$abs())\n)\n\nggplot(df, aes(x = x, y = y)) +\n geom_line() +\n xlab(\"time\") +\n ylab(\"Wavelet Transform\") +\n theme_minimal()\n```", "```r\ngencosines <- function(freqs, amps, samples_per_frame, fs) {\n t <- (1:samples_per_frame) / fs\n lastphase <- 0\n x <- torch_zeros(length(freqs), samples_per_frame)\n\n for (i in 1:length(freqs)) {\n amp <- torch_ones(samples_per_frame) * amps[i]\n freq <- torch_ones(samples_per_frame) * freqs[i]\n\n phase <- torch_tensor(2 * pi * freq * t + lastphase)\n x_frame <- amp * torch_cos(phase)\n\n # save phase to be used in next frame\n lastphase <- as.numeric(phase[samples_per_frame]) %%\n (2 * pi)\n x[i, ] <- x_frame\n }\n\n x$reshape(length(freqs) * samples_per_frame)\n}\n```", "```r\nfreqs <- c(100, 200, 100, 200, 100, 200, 100)\namps <- c(1.2, 0.8, 1.2, 0.8, 1.2, 0.8, 1.2)\nsamples_per_frame <- 100\nfs <- 800\n\nx <- gencosines(freqs, amps, samples_per_frame, fs)\ndf <- data.frame(x = 1:dim(x)[1], y = as.numeric(x))\nggplot(df, aes(x = x, y = y)) +\n geom_line() +\n xlab(\"sample\") +\n ylab(\"amplitude\") +\n theme_minimal()\n```", "```r\nF <- torch_fft_fft(x)\n```", "```r\nmorlet_fourier <- function(K, omega_a, omega) {\n 2 * (torch_exp(-torch_square(\n K * (omega - omega_a) / omega_a\n )) -\n torch_exp(-torch_square(K)) *\n torch_exp(-torch_square(K * omega / omega_a)))\n}\n```", "```r\n# again look for 100Hz parts\nomega <- 2 * pi * f1\n\n# need the bin corresponding to some frequency in Hz\nomega_bin <- f1/fs * dim(x)[1]\n```", "```r\nK <- 3\n\nm <- morlet_fourier(K, omega_bin, 1:dim(x)[1])\nprod <- F * m\ntransformed <- torch_fft_ifft(prod)\n```", "```r\ndf <- data.frame(\n x = as.numeric(1:dim(x)[1]) / fs,\n y = as.numeric(transformed$abs())\n)\nggplot(df, aes(x = x, y = y)) +\n geom_line() +\n xlab(\"time\") +\n ylab(\"Wavelet Transform\") +\n theme_minimal()\n```", "```r\nwavelet_transform_fourier <- function(x, omega_a, K, fs) {\n N <- dim(x)[1]\n omega_bin <- omega_a / fs * N\n m <- morlet_fourier(K, omega_bin, 1:N)\n x_fft <- torch_fft_fft(x)\n prod <- x_fft * m\n w <- torch_fft_ifft(prod)\n w\n}\n```", "```r\nK <- 6\n\ntransformed <- wavelet_transform_fourier(x, f2, K, fs)\ndf <- data.frame(\n x = 1:dim(x)[1] / fs,\n y = as.numeric(transformed$abs())\n)\nggplot(df, aes(x = x, y = y)) +\n geom_line() +\n xlab(\"time\") +\n ylab(\"Wavelet Transform\") +\n theme_minimal()\n```", "```r\nwavelet_grid <- function(x, K, f_start, f_end, fs) {\n # downsample analysis frequency range\n # as per Vistnes, eq. 14.17\n num_freqs <- 1 + log(f_end / f_start)/ log(1 + 1/(8 * K))\n freqs <- seq(f_start, f_end, length.out = floor(num_freqs))\n\n transformed <- torch_zeros(\n num_freqs, dim(x)[1],\n dtype = torch_cfloat()\n )\n for(i in 1:num_freqs) {\n w <- wavelet_transform_fourier(x, freqs[i], K, fs)\n transformed[i, ] <- w\n }\n list(transformed, freqs)\n}\n```", "```r\nplot_wavelet_diagram <- function(x,\n freqs,\n grid,\n K,\n fs,\n f_end,\n type = \"magnitude\") {\n grid <- switch(type,\n magnitude = grid$abs(),\n magnitude_squared = torch_square(grid$abs()),\n magnitude_sqrt = torch_sqrt(grid$abs())\n )\n\n # downsample time series\n # as per Vistnes, eq. 14.9\n new_x_take_every <- max(K / 24 * fs / f_end, 1)\n new_x_length <- floor(dim(grid)[2] / new_x_take_every)\n new_x <- torch_arange(\n x[1],\n x[dim(x)[1]],\n step = x[dim(x)[1]] / new_x_length\n )\n\n # interpolate grid\n new_grid <- nnf_interpolate(\n grid$view(c(1, 1, dim(grid)[1], dim(grid)[2])),\n c(dim(grid)[1], new_x_length)\n )$squeeze()\n out <- as.matrix(new_grid)\n\n # plot log frequencies\n freqs <- log10(freqs)\n\n image(\n x = as.numeric(new_x),\n y = freqs,\n z = t(out),\n ylab = \"log frequency [Hz]\",\n xlab = \"time [s]\",\n col = hcl.colors(12, palette = \"Light grays\")\n )\n main <- paste0(\"Wavelet Transform, K = \", K)\n sub <- switch(type,\n magnitude = \"Magnitude\",\n magnitude_squared = \"Magnitude squared\",\n magnitude_sqrt = \"Magnitude (square root)\"\n )\n\n mtext(side = 3, line = 2, at = 0, adj = 0, cex = 1.3, main)\n mtext(side = 3, line = 1, at = 0, adj = 0, cex = 1, sub)\n}\n```", "```r\nf_start <- 70\nf_end <- 230\n\nK <- 12\nc(grid, freqs) %<-% wavelet_grid(\n x, K, f_start, f_end, fs\n)\nplot_wavelet_diagram(\n torch_tensor(1:dim(grid)[2]), freqs, grid, K, fs, f_end\n)\n```", "```r\nplot_wavelet_diagram(\n torch_tensor(1:dim(grid)[2]), freqs, grid, K, fs, f_end,\n type = \"magnitude_squared\"\n)\n```", "```r\nplot_wavelet_diagram(\n torch_tensor(1:dim(grid)[2]), freqs, grid, K, fs, f_end,\n type = \"magnitude_sqrt\"\n)\n```", "```r\nK <- 6\nc(grid, freqs) %<-% wavelet_grid(\n x, K, f_start, f_end, fs\n)\nplot_wavelet_diagram(\n torch_tensor(1:dim(grid)[2]), freqs, grid, K, fs, f_end,\n type = \"magnitude_squared\"\n)\n```", "```r\nK <- 24\nc(grid, freqs) %<-% wavelet_grid(\n x, K, f_start, f_end, fs\n)\nplot_wavelet_diagram(\n torch_tensor(1:dim(grid)[2]), freqs, grid, K, fs, f_end,\n type = \"magnitude_squared\"\n)\n```", "```r\nK <- 48\nc(grid, freqs) %<-% wavelet_grid(\n x, K, f_start, f_end, fs\n)\nplot_wavelet_diagram(\n torch_tensor(1:dim(grid)[2]), freqs, grid, K, fs, f_end,\n type = \"magnitude_squared\"\n)\n```", "```r\nurl <- \"http://www.physics.uio.no/pow/wavbirds/chaffinch.wav\"\n\ndownload.file(\n file.path(url),\n destfile = \"resources/chaffinch.wav\"\n)\n```", "```r\nlibrary(torchaudio)\nlibrary(tuneR)\n\nwav <- tuneR_loader(\"resources/chaffinch.wav\")\nwav <- mono(wav, \"both\")\nwav\n```", "```r\nWave Object\n    Number of Samples:      1864548\n    Duration (seconds):     42.28\n    Samplingrate (Hertz):   44100\n    Channels (Mono/Stereo): Mono\n    PCM (integer format):   TRUE\n    Bit (8/16/24/32/64):    16 \n```", "```r\nwaveform_and_sample_rate <- transform_to_tensor(wav)\nx <- waveform_and_sample_rate[[1]]$squeeze()\nfs <- waveform_and_sample_rate[[2]]\n\n# http://www.physics.uio.no/pow/wavbirds/chaffinchInfo.txt\nstart <- 34000\nN <- 1024 * 128\nend <- start + N - 1\nx <- x[start:end]\n\ndim(x)\n```", "```r\n[1] 131072\n```", "```r\ndf <- data.frame(x = 1:dim(x)[1], y = as.numeric(x))\nggplot(df, aes(x = x, y = y)) +\n geom_line() +\n xlab(\"sample\") +\n ylab(\"amplitude\") +\n theme_minimal()\n```", "```r\nF <- torch_fft_fft(x)\n```", "```r\nbins <- 1:dim(F)[1]\nfreqs <- bins / N * fs\n\n# the bin, not the frequency\ncutoff <- N/4\n\ndf <- data.frame(\n x = freqs[1:cutoff],\n y = as.numeric(F$abs())[1:cutoff]\n)\nggplot(df, aes(x = x, y = y)) +\n geom_col() +\n xlab(\"frequency (Hz)\") +\n ylab(\"magnitude\") +\n theme_minimal()\n```", "```r\nfft_size <- 1024\nwindow_size <- 1024\npower <- 0.5\n\nspectrogram <- transform_spectrogram(\n n_fft = fft_size,\n win_length = window_size,\n normalized = TRUE,\n power = power\n)\n\nspec <- spectrogram(x)\ndim(spec)\n```", "```r\n[1] 513 257\n```", "```r\nbins <- 1:dim(spec)[1]\nfreqs <- bins * fs / fft_size\nlog_freqs <- log10(freqs)\n\nframes <- 1:(dim(spec)[2])\nseconds <- (frames / dim(spec)[2])  * (dim(x)[1] / fs)\n\nimage(x = seconds,\n y = log_freqs,\n z = t(as.matrix(spec)),\n ylab = 'log frequency [Hz]',\n xlab = 'time [s]',\n col = hcl.colors(12, palette = \"Light grays\")\n)\nmain <- paste0(\"Spectrogram, window size = \", window_size)\nsub <- \"Magnitude (square root)\"\nmtext(side = 3, line = 2, at = 0, adj = 0, cex = 1.3, main)\nmtext(side = 3, line = 1, at = 0, adj = 0, cex = 1, sub)\n```", "```r\nf_start <- 1800\nf_end <- 8500\n\nK <- 48\nc(grid, freqs) %<-% wavelet_grid(x, K, f_start, f_end, fs)\nplot_wavelet_diagram(\n torch_tensor(1:dim(grid)[2]),\n freqs, grid, K, fs, f_end,\n type = \"magnitude_sqrt\"\n)\n```"]