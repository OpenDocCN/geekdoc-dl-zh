<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Answers 1.5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Answers 1.5</h1>
<blockquote>原文：<a href="https://boramorka.github.io/LLM-Book/en/CHAPTER-1/Answers%201.5/">https://boramorka.github.io/LLM-Book/en/CHAPTER-1/Answers%201.5/</a></blockquote>
                
                  


  
  



<h2 id="theory">Theory</h2>
<ol>
<li>Prompt chaining decomposes a complex task into sequential, interconnected steps (prompts), each solving a subtask. Unlike the “monolithic” approach, it simplifies and improves control.</li>
<li>Analogies: step‑by‑step cooking of a complex dish; modular development where each module contributes to the final result.</li>
<li>Workflow management in chaining means checkpointing state after each step and adapting the next step to results so far.</li>
<li>Resource savings: each step processes only what’s needed, reducing computation versus one long prompt.</li>
<li>Error reduction: focusing on a single subtask simplifies debugging and enables targeted improvements.</li>
<li>Dynamic information loading matters due to context limits; chaining injects relevant data as needed.</li>
<li>Core steps: task decomposition, state management, prompt design, data loading/pre‑processing, dynamic context injection.</li>
<li>Best practices: avoid unnecessary complexity, write clear prompts, manage external context, aim for efficiency, and test continuously.</li>
<li>The examples use <code>dotenv</code> and <code>openai</code> for configuration and API calls.</li>
<li>The system message defines structure and format, increasing precision and consistency.</li>
<li>The product database stores details; lookup functions by name or category support effective support answers.</li>
<li>Converting JSON strings to Python objects simplifies downstream processing in chains.</li>
<li>Formatting a user answer from data keeps interactions informative and relevant.</li>
<li>Chaining lets the system move from the initial request to troubleshooting, warranty, and recommendations — covering complex support scenarios.</li>
</ol>
<h2 id="practice">Practice</h2>
<ol>
<li>
<p><code>retrieve_model_response</code> function:
    </p><div class="highlight"><pre><span/><code><span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">"gpt-4o-mini"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="n">message_sequence</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</code></pre></div>
</li>
<li>
<p>Extracting products/categories from a request:
    </p><div class="highlight"><pre><span/><code><span class="n">system_instruction</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">You will receive support requests. The request will be delimited by '####'.</span>
<span class="s2">Output a Python list of objects, each representing a product or category mentioned in the request.</span>
<span class="s2">"""</span>

<span class="n">user_query</span> <span class="o">=</span> <span class="s2">"#### Tell me about SmartX ProPhone and FotoSnap DSLR Camera, and also your televisions ####"</span>

<span class="n">message_sequence</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">user_query</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">extracted_info</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extracted_info</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>Product database helpers:
    </p><div class="highlight"><pre><span/><code><span class="n">product_database</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"SmartX ProPhone"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"SmartX ProPhone"</span><span class="p">,</span>
        <span class="s2">"category"</span><span class="p">:</span> <span class="s2">"Smartphones and Accessories"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">"FotoSnap DSLR Camera"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"FotoSnap DSLR Camera"</span><span class="p">,</span>
        <span class="s2">"category"</span><span class="p">:</span> <span class="s2">"Cameras &amp; Photography"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">"UltraView HD TV"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"UltraView HD TV"</span><span class="p">,</span>
        <span class="s2">"category"</span><span class="p">:</span> <span class="s2">"Televisions"</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_product_details_by_name</span><span class="p">(</span><span class="n">product_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">product_database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">product_name</span><span class="p">,</span> <span class="s2">"Product not found."</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_products_in_category</span><span class="p">(</span><span class="n">category_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">product_database</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">"category"</span><span class="p">]</span> <span class="o">==</span> <span class="n">category_name</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_product_details_by_name</span><span class="p">(</span><span class="s2">"SmartX ProPhone"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_products_in_category</span><span class="p">(</span><span class="s2">"Smartphones and Accessories"</span><span class="p">))</span>
</code></pre></div>
</li>
<li>
<p>JSON string to list:
    </p><div class="highlight"><pre><span/><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">def</span><span class="w"> </span><span class="nf">json_string_to_python_list</span><span class="p">(</span><span class="n">json_string</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"JSON decode error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="n">json_input</span> <span class="o">=</span> <span class="s1">'[{"category": "Smartphones and Accessories", "products": ["SmartX ProPhone"]}]'</span>
<span class="n">python_list</span> <span class="o">=</span> <span class="n">json_string_to_python_list</span><span class="p">(</span><span class="n">json_input</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">python_list</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>Generate a user‑facing answer:
    </p><div class="highlight"><pre><span/><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_response_from_data</span><span class="p">(</span><span class="n">product_data_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">product_data_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"We couldn't find products matching your request."</span>

    <span class="n">response_string</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="n">product_data</span> <span class="ow">in</span> <span class="n">product_data_list</span><span class="p">:</span>
        <span class="n">response_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"Product: </span><span class="si">{</span><span class="n">product_data</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
        <span class="n">response_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"Category: </span><span class="si">{</span><span class="n">product_data</span><span class="p">[</span><span class="s1">'category'</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">response_string</span>

<span class="n">python_list</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">'category'</span><span class="p">:</span> <span class="s1">'Smartphones and Accessories'</span><span class="p">,</span> <span class="s1">'products'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'SmartX ProPhone'</span><span class="p">]}]</span>
<span class="n">final_response</span> <span class="o">=</span> <span class="n">generate_response_from_data</span><span class="p">(</span><span class="n">python_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">final_response</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>End‑to‑end support scenario: describe how the assistant handles an initial product inquiry, troubleshooting, a warranty question, and accessory recommendations using the functions above.
    </p><div class="highlight"><pre><span/><code><span class="c1"># 1) Initial product inquiry: extract entities and list details</span>
<span class="n">system_instruction_catalog</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">You will receive support requests delimited by '####'.</span>
<span class="s2">Return a Python list of objects: mentioned products/categories.</span>
<span class="s2">"""</span>

<span class="n">user_query_1</span> <span class="o">=</span> <span class="s2">"#### I'm interested in upgrading my smartphone. What can you tell me about the latest models? ####"</span>

<span class="n">message_sequence_1</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction_catalog</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">user_query_1</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">extracted</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Extracted entities:"</span><span class="p">,</span> <span class="n">extracted</span><span class="p">)</span>

<span class="c1"># Suppose we parsed 'extracted' to a Python list called parsed_entities (omitted for brevity)</span>
<span class="c1"># You could then look up details via your product DB helpers:</span>
<span class="c1"># for e in parsed_entities: ... get_product_details_by_name(...), get_products_in_category(...)</span>

<span class="c1"># 2) Troubleshooting: step‑by‑step guidance for a specific product issue</span>
<span class="n">troubleshooting_query</span> <span class="o">=</span> <span class="s2">"#### I just bought the FotoSnap DSLR Camera you recommended, but I can't pair it with my smartphone. What should I do? ####"</span>
<span class="n">system_instruction_troubleshooting</span> <span class="o">=</span> <span class="s2">"Provide step‑by‑step troubleshooting advice for the customer’s issue."</span>
<span class="n">message_sequence_2</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction_troubleshooting</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">troubleshooting_query</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">troubleshooting_response</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Troubleshooting response:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">troubleshooting_response</span><span class="p">)</span>

<span class="c1"># 3) Warranty: clarify coverage details</span>
<span class="n">follow_up_query</span> <span class="o">=</span> <span class="s2">"#### Also, could you clarify what the warranty covers for the FotoSnap DSLR Camera? ####"</span>
<span class="n">system_instruction_warranty</span> <span class="o">=</span> <span class="s2">"Provide detailed information about the product’s warranty coverage."</span>
<span class="n">message_sequence_3</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction_warranty</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">follow_up_query</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">warranty_response</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Warranty response:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">warranty_response</span><span class="p">)</span>

<span class="c1"># 4) Recommendations: suggest compatible accessories based on user interest</span>
<span class="n">additional_assistance_query</span> <span class="o">=</span> <span class="s2">"#### Given your interest in photography, would you like recommendations for lenses and tripods compatible with the FotoSnap DSLR Camera? ####"</span>
<span class="n">system_instruction_recommendations</span> <span class="o">=</span> <span class="s2">"Suggest accessories that complement the user’s existing products."</span>
<span class="n">message_sequence_4</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'system'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">system_instruction_recommendations</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">'role'</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span> <span class="s1">'content'</span><span class="p">:</span> <span class="n">additional_assistance_query</span><span class="p">},</span>
<span class="p">]</span>
<span class="n">recommendations_response</span> <span class="o">=</span> <span class="n">retrieve_model_response</span><span class="p">(</span><span class="n">message_sequence_4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Accessory recommendations:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">recommendations_response</span><span class="p">)</span>
</code></pre></div>
<p>This sequence demonstrates a complete, chained workflow where the assistant:
- Extracts mentioned entities and consults a product database.
- Provides step‑wise troubleshooting tailored to the problem.
- Explains warranty coverage clearly and concisely.
- Offers personalized accessory recommendations aligned with the user’s interests.</p>
</li>
</ol>












                
                  
</body>
</html>