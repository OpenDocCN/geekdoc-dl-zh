<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>18  Image classification, take two: Improving performance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>18  Image classification, take two: Improving performance</h1>
<blockquote>原文：<a href="https://skeydan.github.io/Deep-Learning-and-Scientific-Computing-with-R-torch/image_classification_2.html">https://skeydan.github.io/Deep-Learning-and-Scientific-Computing-with-R-torch/image_classification_2.html</a></blockquote>

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">

</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>In the last two chapters, we saw how changes to data input, network architecture, and training modalities can result in improved results, “improvement” having two principal denotations: better generalization to the test set, and faster training progress.</p>
<p>Now, we’ll apply a few of those techniques to the image classification task we started our journey into real-world deep learning with: Tiny Imagenet. In terms of counteracting overfitting, we’ll introduce data augmentation, dropout layers, and early stopping. To speed up training, we make use of the learning rate finder, add batchnorm layers, and integrate a pre-trained network. We won’t add-and-remove these techniques one at a time, that is, we won’t assess their effects in isolation. While this is something you might want to do yourself, here we want to avoid the impression that there is some fixed ranking – this is best, that is second … – , <em>independently of dataset and task</em>.</p>
<p>Instead, what we do is:</p>
<ul>
<li><p>Always use data augmentation. There is hardly ever a case where you’d <em>not</em> want to use it – unless, of course, you are already using a different data augmentation technique.</p></li>
<li><p>Always run with early stopping enabled. This will not just prevent overfitting, but also, save time.</p></li>
<li><p>Always make use of the learning rate finder, together with a one-cycle learning rate schedule.</p></li>
<li><p>For our first setup, we take the convnet from three chapters ago, and add dropout layers.</p></li>
<li><p>In scenario number two, we replace dropout by batch normalization. (Everything else stays the same.)</p></li>
<li><p>Third, we replace the model completely, by one chaining a pre-trained feature classifier (ResNet) and a small sequential model.</p></li>
</ul>
<section id="data-input-common-for-all" class="level2" data-number="18.1">
<h2 data-number="18.1" class="anchored" data-anchor-id="data-input-common-for-all"><span class="header-section-number">18.1</span> Data input (common for all)</h2>
<p>All three runs use the same data input pipeline. Compared with our first go at telling apart the two hundred classes in Tiny Imagenet, two things are new.</p>
<p>First, we now apply data augmentation to the training set: rotations and translations, to be precise.</p>
<p>Second, input tensors are normalized, channel-wise, to a set of given means and standard deviations. This really is required for the third run (using ResNet) only; we just do to our images what was done in training ResNet. (The same goes for most of the pre-trained models trained on ImageNet.) There really is no problem, though, in doing the same for runs one and two; so normalization is part of the common pre-processing pipeline.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"/><span class="fu">library</span>(torch)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"/><span class="fu">library</span>(torchvision)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"/><span class="fu">library</span>(torchdatasets)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"/><span class="fu">library</span>(luz)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"/></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"/><span class="fu">set.seed</span>(<span class="dv">777</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"/><span class="fu">torch_manual_seed</span>(<span class="dv">777</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"/></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"/>dir <span class="ot">&lt;-</span> <span class="st">"~/.torch-datasets"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"/></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"/>train_ds <span class="ot">&lt;-</span> <span class="fu">tiny_imagenet_dataset</span>(</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"/>  dir,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"/>  <span class="at">download =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"/>  <span class="at">transform =</span> . <span class="sc">%&gt;%</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"/>    <span class="fu">transform_to_tensor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"/>    <span class="fu">transform_random_affine</span>(</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"/>      <span class="at">degrees =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>, <span class="dv">30</span>), <span class="at">translate =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"/>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"/>    <span class="fu">transform_normalize</span>(</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"/>      <span class="at">mean =</span> <span class="fu">c</span>(<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>),</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"/>      <span class="at">std =</span> <span class="fu">c</span>(<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"/>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"/></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"/>valid_ds <span class="ot">&lt;-</span> <span class="fu">tiny_imagenet_dataset</span>(</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"/>  dir,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"/>  <span class="at">split =</span> <span class="st">"val"</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"/>  <span class="at">transform =</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"/>    x <span class="sc">%&gt;%</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"/>      <span class="fu">transform_to_tensor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"/>      <span class="fu">transform_normalize</span>(</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"/>        <span class="at">mean =</span> <span class="fu">c</span>(<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>),</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"/>        <span class="at">std =</span> <span class="fu">c</span>(<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>))</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"/>  }</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"/>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"/></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"/>train_dl <span class="ot">&lt;-</span> <span class="fu">dataloader</span>(</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"/>  train_ds,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"/>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"/>  <span class="at">shuffle =</span> <span class="cn">TRUE</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"/>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"/>valid_dl <span class="ot">&lt;-</span> <span class="fu">dataloader</span>(valid_ds, <span class="at">batch_size =</span> <span class="dv">128</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<p>Next, we compare three different configurations.</p>
</section>
<section id="run-1-dropout" class="level2" data-number="18.2">
<h2 data-number="18.2" class="anchored" data-anchor-id="run-1-dropout"><span class="header-section-number">18.2</span> Run 1: Dropout</h2>
<p>In run one, we take the convnet we were using, and add dropout layers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"/>convnet <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"/>  <span class="st">"convnet"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"/>  <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"/>    self<span class="sc">$</span>features <span class="ot">&lt;-</span> <span class="fu">nn_sequential</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">3</span>, <span class="dv">64</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_dropout2d</span>(<span class="at">p =</span> <span class="fl">0.05</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">64</span>, <span class="dv">128</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_dropout2d</span>(<span class="at">p =</span> <span class="fl">0.05</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">128</span>, <span class="dv">256</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_dropout2d</span>(<span class="at">p =</span> <span class="fl">0.05</span>),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">256</span>, <span class="dv">512</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_dropout2d</span>(<span class="at">p =</span> <span class="fl">0.05</span>),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">512</span>, <span class="dv">1024</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>), </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_adaptive_avg_pool2d</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_dropout2d</span>(<span class="at">p =</span> <span class="fl">0.05</span>),</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"/>    self<span class="sc">$</span>classifier <span class="ot">&lt;-</span> <span class="fu">nn_sequential</span>(</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">1024</span>),</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_dropout</span>(<span class="at">p =</span> <span class="fl">0.05</span>),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">1024</span>),</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_dropout</span>(<span class="at">p =</span> <span class="fl">0.05</span>),</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">200</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"/>  },</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"/>  <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"/>    x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">features</span>(x)<span class="sc">$</span><span class="fu">squeeze</span>()</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"/>    x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">classifier</span>(x)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"/>    x</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"/>  }</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"/>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<p>Next, we run the learning rate finder (<a href="#fig-images2-lr-finder-dropout">fig. <span>18.1</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"/>model <span class="ot">&lt;-</span> convnet <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"/>  <span class="fu">setup</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"/>    <span class="at">loss =</span> <span class="fu">nn_cross_entropy_loss</span>(),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"/>    <span class="at">optimizer =</span> optim_adam,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"/>    <span class="at">metrics =</span> <span class="fu">list</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"/>      <span class="fu">luz_metric_accuracy</span>()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"/>  ) </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"/>    </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"/>rates_and_losses <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">lr_finder</span>(train_dl)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"/>rates_and_losses <span class="sc">%&gt;%</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<div id="fig-images2-lr-finder-dropout" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="../Images/4a988e517473fbe4eabb35fec7dac73b.png" class="quarto-discovered-preview-image img-fluid figure-img" alt="A curve that, from left to right, stays flat for a long time (until about x=0.01), then oscillates between low and higher values, and finally (at about x=0.05) starts to rise very sharply." data-original-src="https://skeydan.github.io/Deep-Learning-and-Scientific-Computing-with-R-torch/images/images2-lr-finder-dropout.png"/></p>
<p/><figcaption class="figure-caption">Figure 18.1: Learning rate finder, run on Tiny Imagenet. Convnet with dropout layers.</figcaption><p/>
</figure>
</div>
<p>We already know that discerning between two hundred classes is a task that takes time; it’s thus not surprising to see a flat-ish loss curve during most of learning rate increase. We can conclude, though, that we had better not exceed a learning rate of 0.01.</p>
<p>As in all further configurations, we now train with the one-cycle learning rate scheduler, and early stopping enabled.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"/>fitted <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"/>  <span class="fu">fit</span>(train_dl, <span class="at">epochs =</span> <span class="dv">50</span>, <span class="at">valid_data =</span> valid_dl,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"/>      <span class="at">callbacks =</span> <span class="fu">list</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">2</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_lr_scheduler</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"/>          lr_one_cycle,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"/>          <span class="at">max_lr =</span> <span class="fl">0.01</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"/>          <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"/>          <span class="at">steps_per_epoch =</span> <span class="fu">length</span>(train_dl),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"/>          <span class="at">call_on =</span> <span class="st">"on_batch_end"</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_model_checkpoint</span>(<span class="at">path =</span> <span class="st">"cpt_dropout/"</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_csv_logger</span>(<span class="st">"logs_dropout.csv"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"/>        ),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"/>      <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<p>For me, training stopped after thirty-five epochs, at a validation accuracy of 0.4, and a training accuracy that was just slightly higher: 0.44.</p>
<pre><code>Epoch 1/50
Train metrics: Loss: 5.116 - Acc: 0.0128                                      
Valid metrics: Loss: 4.9144 - Acc: 0.0217
Epoch 2/50
Train metrics: Loss: 4.7217 - Acc: 0.042                                      
Valid metrics: Loss: 4.4143 - Acc: 0.067
Epoch 3/50
Train metrics: Loss: 4.3681 - Acc: 0.0791                                     
Valid metrics: Loss: 4.1145 - Acc: 0.105
...
...
Epoch 33/50
Train metrics: Loss: 2.3006 - Acc: 0.4304                                     
Valid metrics: Loss: 2.5863 - Acc: 0.4025
Epoch 34/50
Train metrics: Loss: 2.2717 - Acc: 0.4365                                     
Valid metrics: Loss: 2.6377 - Acc: 0.3889
Epoch 35/50
Train metrics: Loss: 2.2456 - Acc: 0.4402                                     
Valid metrics: Loss: 2.6208 - Acc: 0.4043
Early stopping at epoch 35 of 50</code></pre>
<p>Comparing with the initial approach, where after fifty epochs, we were left with accuracies of 0.22 for validation, and 0.92 for training, we see an impressive reduction in overfitting. Of course, we cannot really say anything about the respective merits of dropout and data augmentation here. If you’re curious, please go ahead and find out!</p>
</section>
<section id="run-2-batch-normalization" class="level2" data-number="18.3">
<h2 data-number="18.3" class="anchored" data-anchor-id="run-2-batch-normalization"><span class="header-section-number">18.3</span> Run 2: Batch normalization</h2>
<p>In configuration number two, dropout is replaced by batch normalization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"/>convnet <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"/>  <span class="st">"convnet"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"/>  <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"/>    self<span class="sc">$</span>features <span class="ot">&lt;-</span> <span class="fu">nn_sequential</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">3</span>, <span class="dv">64</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_batch_norm2d</span>(<span class="dv">64</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">64</span>, <span class="dv">128</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_batch_norm2d</span>(<span class="dv">128</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">128</span>, <span class="dv">256</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_batch_norm2d</span>(<span class="dv">256</span>),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">256</span>, <span class="dv">512</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_batch_norm2d</span>(<span class="dv">512</span>),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_max_pool2d</span>(<span class="at">kernel_size =</span> <span class="dv">2</span>),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_conv2d</span>(<span class="dv">512</span>, <span class="dv">1024</span>, <span class="at">kernel_size =</span> <span class="dv">3</span>, <span class="at">padding =</span> <span class="dv">1</span>), </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_batch_norm2d</span>(<span class="dv">1024</span>),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_adaptive_avg_pool2d</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"/>    self<span class="sc">$</span>classifier <span class="ot">&lt;-</span> <span class="fu">nn_sequential</span>(</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">1024</span>),</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_batch_norm1d</span>(<span class="dv">1024</span>),</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">1024</span>),</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_batch_norm1d</span>(<span class="dv">1024</span>),</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">200</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"/>  },</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"/>  <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"/>    x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">features</span>(x)<span class="sc">$</span><span class="fu">squeeze</span>()</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"/>    x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">classifier</span>(x)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"/>    x</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"/>  }</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"/>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<p>Again, we run the learning rate finder (<a href="#fig-images2-lr-finder-batchnorm">fig. <span>18.2</span></a>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"/>model <span class="ot">&lt;-</span> convnet <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"/>  <span class="fu">setup</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"/>    <span class="at">loss =</span> <span class="fu">nn_cross_entropy_loss</span>(),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"/>    <span class="at">optimizer =</span> optim_adam,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"/>    <span class="at">metrics =</span> <span class="fu">list</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"/>      <span class="fu">luz_metric_accuracy</span>()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"/>  ) </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"/></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"/>rates_and_losses <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">lr_finder</span>(train_dl)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"/>rates_and_losses <span class="sc">%&gt;%</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<div id="fig-images2-lr-finder-batchnorm" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="../Images/421e5f2f3d3777e42ee6e4565b4cf949.png" class="img-fluid figure-img" alt="A curve that, from left to right, first descends in a smooth, accelerating curve (until about x=0.001), stays flat for a while, and then (shortly before x=0.001), begins to rise in a sharp, but still smooth, curve." data-original-src="https://skeydan.github.io/Deep-Learning-and-Scientific-Computing-with-R-torch/images/images2-lr-finder-batchnorm.png"/></p>
<p/><figcaption class="figure-caption">Figure 18.2: Learning rate finder, run on Tiny Imagenet. Convnet with batchnorm layers.</figcaption><p/>
</figure>
</div>
<p>This looks surprisingly different! Of course, this is in part due to the scale on the loss axis; the loss does not explode as much, and thus, we get better resolution in the early and middle stages. The loss not exploding is an interesting finding in itself; the conclusion for us to draw from this plot is to be a bit more careful with the learning rate. This time, we’ll choose 0.001 for the maximum.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"/>fitted <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"/>  <span class="fu">fit</span>(train_dl, <span class="at">epochs =</span> <span class="dv">50</span>, <span class="at">valid_data =</span> valid_dl,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"/>      <span class="at">callbacks =</span> <span class="fu">list</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">2</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_lr_scheduler</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"/>          lr_one_cycle,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"/>          <span class="at">max_lr =</span> <span class="fl">0.001</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"/>          <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"/>          <span class="at">steps_per_epoch =</span> <span class="fu">length</span>(train_dl),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"/>          <span class="at">call_on =</span> <span class="st">"on_batch_end"</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_model_checkpoint</span>(<span class="at">path =</span> <span class="st">"cpt_batchnorm/"</span>),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_csv_logger</span>(<span class="st">"logs_batchnorm.csv"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"/>        ),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"/>      <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<p>Compared with scenario one, I saw slightly more overfitting with batchnorm.</p>
<pre><code>Epoch 1/50
Train metrics: Loss: 4.5434 - Acc: 0.0862                                     
Valid metrics: Loss: 4.0914 - Acc: 0.1332
Epoch 2/50
Train metrics: Loss: 3.9534 - Acc: 0.161                                      
Valid metrics: Loss: 3.7865 - Acc: 0.1809
Epoch 3/50
Train metrics: Loss: 3.6425 - Acc: 0.2054                                     
Valid metrics: Loss: 3.5965 - Acc: 0.2115
...
...
Epoch 19/50
Train metrics: Loss: 2.1063 - Acc: 0.4859                                     
Valid metrics: Loss: 2.621 - Acc: 0.3912
Epoch 20/50
Train metrics: Loss: 2.0514 - Acc: 0.4987                                     
Valid metrics: Loss: 2.6334 - Acc: 0.3914
Epoch 21/50
Train metrics: Loss: 1.9982 - Acc: 0.5069                                     
Valid metrics: Loss: 2.6603 - Acc: 0.3932
Early stopping at epoch 21 of 50</code></pre>
</section>
<section id="run-3-transfer-learning" class="level2" data-number="18.4">
<h2 data-number="18.4" class="anchored" data-anchor-id="run-3-transfer-learning"><span class="header-section-number">18.4</span> Run 3: Transfer learning</h2>
<p>Finally, the setup including transfer learning. A pre-trained ResNet is used for feature extraction, and a small sequential model takes care of classification. During training, all of ResNets weights are left untouched.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"/>convnet <span class="ot">&lt;-</span> <span class="fu">nn_module</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"/>  <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"/>    self<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="fu">model_resnet18</span>(<span class="at">pretrained =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"/>    <span class="cf">for</span> (par <span class="cf">in</span> self<span class="sc">$</span>parameters) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"/>      par<span class="sc">$</span><span class="fu">requires_grad_</span>(<span class="cn">FALSE</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"/>    }</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"/>    self<span class="sc">$</span>model<span class="sc">$</span>fc <span class="ot">&lt;-</span> <span class="fu">nn_sequential</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(self<span class="sc">$</span>model<span class="sc">$</span>fc<span class="sc">$</span>in_features, <span class="dv">1024</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">1024</span>),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_relu</span>(),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"/>      <span class="fu">nn_linear</span>(<span class="dv">1024</span>, <span class="dv">200</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"/>  },</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"/>  <span class="at">forward =</span> <span class="cf">function</span>(x) {</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"/>    self<span class="sc">$</span><span class="fu">model</span>(x)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"/>  }</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"/>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<p>As always, we run the learning rate finder (<a href="#fig-images2-lr-finder-resnet">fig. <span>18.3</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"/>model <span class="ot">&lt;-</span> convnet <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"/>  <span class="fu">setup</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"/>    <span class="at">loss =</span> <span class="fu">nn_cross_entropy_loss</span>(),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"/>    <span class="at">optimizer =</span> optim_adam,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"/>    <span class="at">metrics =</span> <span class="fu">list</span>(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"/>      <span class="fu">luz_metric_accuracy</span>()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"/>    )</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"/>  ) </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"/></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"/>rates_and_losses <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">lr_finder</span>(train_dl)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"/>rates_and_losses <span class="sc">%&gt;%</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<div id="fig-images2-lr-finder-resnet" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="../Images/5302967a65ea3a1846403411ee0307e1.png" class="img-fluid figure-img" alt="A curve that, from left to right, first stays flat (until about x=0.01), then begins to rise very sharply, while at the same time showing high variability." data-original-src="https://skeydan.github.io/Deep-Learning-and-Scientific-Computing-with-R-torch/images/images2-lr-finder-resnet.png"/></p>
<p/><figcaption class="figure-caption">Figure 18.3: Learning rate finder, run on Tiny Imagenet. Convnet with transfer learning (ResNet).</figcaption><p/>
</figure>
</div>
<p>A maximal rate of 0.01 looks like it could be on the edge, but I decided to give it a try.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"/>fitted <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"/>  <span class="fu">fit</span>(train_dl, <span class="at">epochs =</span> <span class="dv">50</span>, <span class="at">valid_data =</span> valid_dl,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"/>      <span class="at">callbacks =</span> <span class="fu">list</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_early_stopping</span>(<span class="at">patience =</span> <span class="dv">2</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_lr_scheduler</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"/>          lr_one_cycle,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"/>          <span class="at">max_lr =</span> <span class="fl">0.01</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"/>          <span class="at">epochs =</span> <span class="dv">50</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"/>          <span class="at">steps_per_epoch =</span> <span class="fu">length</span>(train_dl),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"/>          <span class="at">call_on =</span> <span class="st">"on_batch_end"</span>),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_model_checkpoint</span>(<span class="at">path =</span> <span class="st">"cpt_resnet/"</span>),</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"/>        <span class="fu">luz_callback_csv_logger</span>(<span class="st">"logs_resnet.csv"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"/>        ),</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"/>      <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"/></button></pre></div>
</div>
<p>For me, this configuration resulted in early stopping after nine epochs already, and yielded the best results by far: Final accuracy on the validation set was 0.48. Interestingly, in this setup, accuracy ended up <em>worse</em> for training than for validation.</p>
<pre><code>Epoch 1/50
Train metrics: Loss: 3.4036 - Acc: 0.2322                                     
Valid metrics: Loss: 2.5491 - Acc: 0.3884
Epoch 2/50
Train metrics: Loss: 2.7911 - Acc: 0.3436                                     
Valid metrics: Loss: 2.417 - Acc: 0.4233
Epoch 3/50
Train metrics: Loss: 2.6423 - Acc: 0.3726                                     
Valid metrics: Loss: 2.3492 - Acc: 0.4431
...
...
Valid metrics: Loss: 2.1822 - Acc: 0.4868
Epoch 7/50
Train metrics: Loss: 2.4031 - Acc: 0.4198                                     
Valid metrics: Loss: 2.1413 - Acc: 0.4889
Epoch 8/50
Train metrics: Loss: 2.3759 - Acc: 0.4252                                     
Valid metrics: Loss: 2.149 - Acc: 0.4958
Epoch 9/50
Train metrics: Loss: 2.3447 - Acc: 0.433                                      
Valid metrics: Loss: 2.1888 - Acc: 0.484
Early stopping at epoch 9 of 50</code></pre>
<p>In the next chapter, we stay with the domain – images – but vary the task: We move on from classification to segmentation.</p>


</section>

    
</body>
</html>