["```r\nset.seed(777)\n\nlibrary(torch)\ntorch_manual_seed(777)\n\nlibrary(dplyr)\nlibrary(readr)\n\nlibrary(zeallot)\n\nuci <- \"https://archive.ics.uci.edu\"\nds_path <- \"ml/machine-learning-databases/00514\"\nds_file <- \"Bias_correction_ucl.csv\"\n\n# download.file(\n#   file.path(uci, ds_path, ds_file),\n#   destfile = \"resources/matrix-weather.csv\"\n# )\n\nweather_df <- read_csv(\"resources/matrix-weather.csv\") %>%\n na.omit()\nweather_df %>% glimpse()\n```", "```r\nRows: 7,588\nColumns: 25\n$ station           <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,…\n$ Date              <date> 2013-06-30, 2013-06-30,…\n$ Present_Tmax      <dbl> 28.7, 31.9, 31.6, 32.0, 31.4, 31.9,…\n$ Present_Tmin      <dbl> 21.4, 21.6, 23.3, 23.4, 21.9, 23.5,…\n$ LDAPS_RHmin       <dbl> 58.25569, 52.26340, 48.69048,…\n$ LDAPS_RHmax       <dbl> 91.11636, 90.60472, 83.97359,…\n$ LDAPS_Tmax_lapse  <dbl> 28.07410, 29.85069, 30.09129,…\n$ LDAPS_Tmin_lapse  <dbl> 23.00694, 24.03501, 24.56563,…\n$ LDAPS_WS          <dbl> 6.818887, 5.691890, 6.138224,…\n$ LDAPS_LH          <dbl> 69.45181, 51.93745, 20.57305,…\n$ LDAPS_CC1         <dbl> 0.2339475, 0.2255082, 0.2093437,…\n$ LDAPS_CC2         <dbl> 0.2038957, 0.2517714, 0.2574694,…\n$ LDAPS_CC3         <dbl> 0.1616969, 0.1594441, 0.2040915,…\n$ LDAPS_CC4         <dbl> 0.1309282, 0.1277273, 0.1421253,…\n$ LDAPS_PPT1        <dbl> 0.0000000, 0.0000000, 0.0000000,…\n$ LDAPS_PPT2        <dbl> 0.000000, 0.000000, 0.000000,…\n$ LDAPS_PPT3        <dbl> 0.0000000, 0.0000000, 0.0000000,…\n$ LDAPS_PPT4        <dbl> 0.0000000, 0.0000000, 0.0000000,…\n$ lat               <dbl> 37.6046, 37.6046, 37.5776, 37.6450,…\n$ lon               <dbl> 126.991, 127.032, 127.058, 127.022,…\n$ DEM               <dbl> 212.3350, 44.7624, 33.3068, 45.7160,…\n$ Slope             <dbl> 2.7850, 0.5141, 0.2661, 2.5348,…\n$ `Solar radiation` <dbl> 5992.896, 5869.312, 5863.556,…\n$ Next_Tmax         <dbl> 29.1, 30.5, 31.1, 31.7, 31.2, 31.5,…\n$ Next_Tmin         <dbl> 21.2, 22.5, 23.9, 24.3, 22.5, 24.0,…\n```", "```r\nweather_df <- weather_df %>%\n select(-c(station, Next_Tmin, Date)) %>%\n mutate(across(.fns = scale))\n```", "```r\nweather <- torch_tensor(weather_df %>% as.matrix())\nA <- weather[ , 1:-2]\nb <- weather[ , -1]\n\ndim(A)\n```", "```r\n[1] 7588   21\n```", "```r\nfit <- lm(Next_Tmax ~ . , data = weather_df)\nfit %>% summary()\n```", "```r\nCall:\nlm(formula = Next_Tmax ~ ., data = weather_df)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-1.94439 -0.27097  0.01407  0.28931  2.04015 \n\nCoefficients:\n                    Estimate Std. Error t value Pr(>|t|)    \n(Intercept)        2.605e-15  5.390e-03   0.000 1.000000    \nPresent_Tmax       1.456e-01  9.049e-03  16.089  < 2e-16 ***\nPresent_Tmin       4.029e-03  9.587e-03   0.420 0.674312    \nLDAPS_RHmin        1.166e-01  1.364e-02   8.547  < 2e-16 ***\nLDAPS_RHmax       -8.872e-03  8.045e-03  -1.103 0.270154    \nLDAPS_Tmax_lapse   5.908e-01  1.480e-02  39.905  < 2e-16 ***\nLDAPS_Tmin_lapse   8.376e-02  1.463e-02   5.726 1.07e-08 ***\nLDAPS_WS          -1.018e-01  6.046e-03 -16.836  < 2e-16 ***\nLDAPS_LH           8.010e-02  6.651e-03  12.043  < 2e-16 ***\nLDAPS_CC1         -9.478e-02  1.009e-02  -9.397  < 2e-16 ***\nLDAPS_CC2         -5.988e-02  1.230e-02  -4.868 1.15e-06 ***\nLDAPS_CC3         -6.079e-02  1.237e-02  -4.913 9.15e-07 ***\nLDAPS_CC4         -9.948e-02  9.329e-03 -10.663  < 2e-16 ***\nLDAPS_PPT1        -3.970e-03  6.412e-03  -0.619 0.535766    \nLDAPS_PPT2         7.534e-02  6.513e-03  11.568  < 2e-16 ***\nLDAPS_PPT3        -1.131e-02  6.058e-03  -1.866 0.062056 .  \nLDAPS_PPT4        -1.361e-03  6.073e-03  -0.224 0.822706    \nlat               -2.181e-02  5.875e-03  -3.713 0.000207 ***\nlon               -4.688e-02  5.825e-03  -8.048 9.74e-16 ***\nDEM               -9.480e-02  9.153e-03 -10.357  < 2e-16 ***\nSlope              9.402e-02  9.100e-03  10.331  < 2e-16 ***\n`Solar radiation`  1.145e-02  5.986e-03   1.913 0.055746 .  \n---\nSignif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n\nResidual standard error: 0.4695 on 7566 degrees of freedom\nMultiple R-squared:  0.7802,    Adjusted R-squared:  0.7796 \nF-statistic:  1279 on 21 and 7566 DF,  p-value: < 2.2e-16\n```", "```r\nrmse <- function(y_true, y_pred) {\n (y_true - y_pred)^2 %>%\n sum() %>%\n sqrt()\n}\n\nall_preds <- data.frame(\n b = weather_df$Next_Tmax,\n lm = fit$fitted.values\n)\nall_errs <- data.frame(lm = rmse(all_preds$b, all_preds$lm))\nall_errs\n```", "```r\n lm\n1 40.8369\n```", "```r\nx_lstsq <- linalg_lstsq(A, b)$solution\n\nall_preds$lstsq <- as.matrix(A$matmul(x_lstsq))\nall_errs$lstsq <- rmse(all_preds$b, all_preds$lstsq)\n\ntail(all_preds)\n```", "```r\n b         lm      lstsq\n7583 -1.1380931 -1.3544620 -1.3544616\n7584 -0.8488721 -0.9040997 -0.9040993\n7585 -0.7203294 -0.9675286 -0.9675281\n7586 -0.6239224 -0.9044044 -0.9044040\n7587 -0.5275154 -0.8738639 -0.8738635\n7588 -0.7846007 -0.8725795 -0.8725792\n```", "```r\nall_errs\n```", "```r\n lm    lstsq\n1 40.8369 40.8369\n```", "```r\nweather_df_alt <- \n read_csv(\"resources/matrix-weather.csv\") %>% \n na.omit() %>%\n select(-c(station, Next_Tmin, Date)) \n\nweather_alt <- torch_tensor(weather_df_alt %>% as.matrix())\nA_alt <- weather_alt[ , 1:-2]\nb_alt <- weather_alt[ , -1]\n```", "```r\nfit_alt <- lm(Next_Tmax ~ ., data = weather_df_alt)\nall_preds_alt <- data.frame(\n b = weather_df_alt$Next_Tmax,\n lm = fit_alt$fitted.values\n)\n\nall_errs_alt <- data.frame(\n lm = rmse(\n all_preds_alt$b,\n all_preds_alt$lm\n )\n)\n\nall_errs_alt\n```", "```r\n lm\n1 127.0765\n```", "```r\nx_lstsq_alt <- linalg_lstsq(A_alt, b_alt)$solution\n\nall_preds_alt$lstsq <- as.matrix(A_alt$matmul(x_lstsq_alt))\nall_errs_alt$lstsq <- rmse(\n all_preds_alt$b, all_preds_alt$lstsq\n)\n\nall_errs_alt\n```", "```r\n lm    lstsq\n1 127.0765 177.9128\n```", "```r\nlinalg_matrix_rank(A_alt)\n```", "```r\ntorch_tensor\n21\n[ CPULongType{} ]\n```", "```r\nx_lstsq_alt <- linalg_lstsq(\n A_alt, b_alt,\n driver = \"gels\"\n)$solution\n\nall_preds_alt$lstsq <- as.matrix(A_alt$matmul(x_lstsq_alt))\nall_errs_alt$lstsq <- rmse(\n all_preds_alt$b,\n all_preds_alt$lstsq\n)\n\nall_errs_alt\n```", "```r\n lm    lstsq\n1 127.0765 127.9489\n```", "```r\nsvals_normalized_A <- linalg_svdvals(A)/linalg_svdvals(A)[1]\nsvals_normalized_A %>% as.numeric()\n```", "```r\n[1] 1.0000000 0.7473214 0.5929527 0.5233989 0.5188764 0.4706140\n[7] 0.4391665 0.4249273 0.4034659 0.3815900 0.3621315 0.3557949\n[13] 0.3297923 0.2707912 0.2489560 0.2229859 0.2175170 0.1852890\n[19] 0.1627083 0.1553169 0.1075778\n```", "```r\nsvals_normalized_A_alt <- linalg_svdvals(A_alt) /\n linalg_svdvals(A_alt)[1]\nsvals_normalized_A_alt %>% as.numeric()\n```", "```r\n[1] 1.000000e+00 1.014369e-02 6.407313e-03 2.881966e-03\n[5] 2.236537e-03 9.633782e-04 6.678377e-04 3.988165e-04\n[9] 3.584047e-04 3.137257e-04 2.699152e-04 2.383501e-04\n[13] 2.234150e-04 1.803384e-04 1.625245e-04 1.300101e-04\n[17] 4.312536e-05 3.463851e-05 1.964120e-05 1.689913e-05\n[18] 8.419599e-06\n```", "```r\nlinalg_cond(A)\nlinalg_cond(A_alt)\n```", "```r\ntorch_tensor\n9.2956\n[ CPUFloatType{} ]\n\ntorch_tensor\n118770\n[ CPUFloatType{} ]\n```", "```r\nlinalg_svdvals(A)[1]/linalg_svdvals(A)[21]\nlinalg_svdvals(A_alt)[1]/linalg_svdvals(A_alt)[21]\n```", "```r\ntorch_tensor\n9.29559\n[ CPUFloatType{} ]\n\ntorch_tensor\n118770\n[ CPUFloatType{} ]\n```", "```r\nAtA <- A$t()$matmul(A)\nAtb <- A$t()$matmul(b)\ninv <- linalg_inv(AtA)\nx <- inv$matmul(Atb)\n\nall_preds$neq <- as.matrix(A$matmul(x))\nall_errs$neq <- rmse(all_preds$b, all_preds$neq)\n\nall_errs\n```", "```r\n lm   lstsq     neq\n1 40.8369 40.8369 40.8369\n```", "```r\n# AtA = L L_t\nAtA <- A$t()$matmul(A)\nL <- linalg_cholesky(AtA)\n```", "```r\nLLt <- L$matmul(L$t())\ndiff <- LLt - AtA\nlinalg_norm(diff, ord = \"fro\")\n```", "```r\ntorch_tensor\n0.00258896\n[ CPUFloatType{} ]\n```", "```r\nsome_L <- torch_tensor(\n matrix(c(1, 0, 0, 2, 3, 0, 3, 4, 1), nrow = 3, byrow = TRUE)\n)\nsome_b <- torch_tensor(matrix(c(1, 11, 15), ncol = 1))\n\nx <- torch_triangular_solve(\n some_b,\n some_L,\n upper = FALSE\n)[[1]]\nx\n```", "```r\ntorch_tensor\n 1\n 3\n 0\n[ CPUFloatType{3,1} ]\n```", "```r\nAtb <- A$t()$matmul(b)\n\ny <- torch_triangular_solve(\n Atb$unsqueeze(2),\n L,\n upper = FALSE\n)[[1]]\n```", "```r\nx <- torch_triangular_solve(y, L$t())[[1]]\n```", "```r\nall_preds$chol <- as.matrix(A$matmul(x))\nall_errs$chol <- rmse(all_preds$b, all_preds$chol)\n\nall_errs\n```", "```r\n lm   lstsq     neq    chol\n1 40.8369 40.8369 40.8369 40.8369\n```", "```r\nL <- linalg_cholesky(AtA)\n\nx <- torch_cholesky_solve(Atb$unsqueeze(2), L)\n\nall_preds$chol2 <- as.matrix(A$matmul(x))\nall_errs$chol2 <- rmse(all_preds$b, all_preds$chol2)\nall_errs\n```", "```r\n lm   lstsq     neq    chol   chol2\n1 40.8369 40.8369 40.8369 40.8369 40.8369\n```", "```r\nlu <- torch_lu(AtA)\n\nc(P, L, U) %<-% torch_lu_unpack(lu[[1]], lu[[2]]) \n```", "```r\nAtb <- P$t()$matmul(Atb)\n```", "```r\ny <- torch_triangular_solve(\n Atb$unsqueeze(2),\n L,\n upper = FALSE\n)[[1]]\nx <- torch_triangular_solve(y, U)[[1]]\n\nall_preds$lu <- as.matrix(A$matmul(x))\nall_errs$lu <- rmse(all_preds$b, all_preds$lu)\nall_errs[1, -5]\n```", "```r\n lm   lstsq     neq    chol      lu\n1 40.8369 40.8369 40.8369 40.8369 40.8369\n```", "```r\nlu <- torch_lu(AtA)\nx <- torch_lu_solve(Atb$unsqueeze(2), lu[[1]], lu[[2]])\n\nall_preds$lu2 <- as.matrix(A$matmul(x))\nall_errs$lu2 <- rmse(all_preds$b, all_preds$lu2)\nall_errs[1, -5]\n```", "```r\n lm   lstsq     neq    chol      lu      lu\n1 40.8369 40.8369 40.8369 40.8369 40.8369 40.8369\n```", "```r\nc(Q, R) %<-% linalg_qr(A)\n```", "```r\nQtb <- Q$t()$matmul(b)\n```", "```r\nx <- torch_triangular_solve(Qtb$unsqueeze(2), R)[[1]]\n\nall_preds$qr <- as.matrix(A$matmul(x))\nall_errs$qr <- rmse(all_preds$b, all_preds$qr)\nall_errs[1, -c(5,7)]\n```", "```r\n lm   lstsq     neq    chol      lu      qr\n1 40.8369 40.8369 40.8369 40.8369 40.8369 40.8369 \n```", "```r\nc(U, S, Vt) %<-% linalg_svd(A, full_matrices = FALSE)\n\ndim(U)\ndim(S)\ndim(Vt)\n```", "```r\n[1] 7588   21\n[1] 21\n[1] 21 21\n```", "```r\nUtb <- U$t()$matmul(b)\n```", "```r\ny <- Utb / S\n```", "```r\nx <- Vt$t()$matmul(y)\n```", "```r\nall_preds$svd <- as.matrix(A$matmul(x))\nall_errs$svd <- rmse(all_preds$b, all_preds$svd)\n\nall_errs[1, -c(5, 7)]\n```", "```r\n lm   lstsq     neq    chol      lu     qr      svd\n1 40.8369 40.8369 40.8369 40.8369 40.8369 40.8369 40.8369\n```", "```r\n# normal equations\nls_normal_eq <- function(A, b) {\n AtA <- A$t()$matmul(A)\n x <- linalg_inv(AtA)$matmul(A$t())$matmul(b)\n x\n}\n\n# normal equations and Cholesky decomposition (done manually)\n# A_t A x = A_t b\n# L L_t x = A_t b\n# L y = A_t b \n# L_t x = y\nls_cholesky_diy <- function(A, b) {\n AtA <- A$t()$matmul(A)\n Atb <- A$t()$matmul(b)\n L <- linalg_cholesky(AtA)\n y <- torch_triangular_solve(\n Atb$unsqueeze(2),\n L,\n upper = FALSE\n )[[1]]\n x <- torch_triangular_solve(y, L$t())[[1]]\n x\n}\n\n# torch's Cholesky solver\nls_cholesky_solve <- function(A, b) {\n AtA <- A$t()$matmul(A)\n Atb <- A$t()$matmul(b)\n L <- linalg_cholesky(AtA)\n x <- torch_cholesky_solve(Atb$unsqueeze(2), L)\n x\n}\n\n# normal equations and LU factorization (done manually)\n# A_t A x = A_t b\n# P L U x = A_t b\n# L y = P_t A_t b          # where y = U x\n# U x = y\nls_lu_diy <- function(A, b) {\n AtA <- A$t()$matmul(A)\n Atb <- A$t()$matmul(b)\n lu <- torch_lu(AtA)\n c(P, L, U) %<-% torch_lu_unpack(lu[[1]], lu[[2]]) \n Atb <- P$t()$matmul(Atb)\n y <- torch_triangular_solve(\n Atb$unsqueeze(2),\n L,\n upper = FALSE\n )[[1]]\n x <- torch_triangular_solve(y, U)[[1]]\n x\n}\n\n# torch's LU solver\nls_lu_solve <- function(A, b) {\n AtA <- A$t()$matmul(A) \n Atb <- A$t()$matmul(b)\n lu <- torch_lu(AtA)\n m = lu[[1]]\n pivots = lu[[2]]\n x <- torch_lu_solve(Atb$unsqueeze(2), m, pivots)\n x\n}\n\n# QR factorization\n# A x = b\n# Q R x = b\n# R x = Q_t b \nls_qr <- function(A, b) {\n c(Q, R) %<-% linalg_qr(A)\n Qtb <- Q$t()$matmul(b)\n x <- torch_triangular_solve(Qtb$unsqueeze(2), R)[[1]]\n x\n}\n\n# SVD\n# A x = b\n# U S V_ x = b\n# S V_t x = U_t b\n# S y = U_t b \n# V_t x = y\nls_svd <- function(A, b) {\n c(U, S, Vt) %<-% linalg_svd(A, full_matrices = FALSE)\n Utb <- U$t()$matmul(b)\n y <- Utb / S\n x <- Vt$t()$matmul(y)\n x\n}\n\n# torch's general least squares solver\nls_lstsq <- function(A, b) {\n x <- linalg_lstsq(A, b)\n x\n}\n```", "```r\nset.seed(777)\ntorch_manual_seed(777)\nlibrary(bench)\nlibrary(ggplot2)\n\nres <- mark(ls_normal_eq(A, b),\n ls_cholesky_diy(A, b),\n ls_cholesky_solve(A, b),\n ls_lu_diy(A, b),\n ls_lu_solve(A, b),\n ls_qr(A, b),\n ls_svd(A, b),\n ls_lstsq(A, b)$solution,\n min_iterations = 1000)\n\nautoplot(res, type = \"ridge\") + theme_minimal()\n```", "```r\nset.seed(777)\ntorch_manual_seed(777)\n\nm <- 100\nn <- 15\nt <- torch_linspace(0, 1, m)$to(dtype = torch_double())\n\nA <- torch_vander(t, N = n, increasing = TRUE)$to(\n dtype = torch_double()\n)\n```", "```r\nlinalg_cond(A)\n```", "```r\ntorch_tensor\n2.27178e+10\n[ CPUDoubleType{} ]\n```", "```r\nlinalg_cond(A$t()$matmul(A))\n```", "```r\ntorch_tensor\n7.27706e+17\n[ CPUDoubleType{} ]\n```", "```r\nb <- torch_exp(torch_sin(4*t))\nb <- b/2006.787453080206\n```", "```r\n# normal equations\nls_normal_eq <- function(A, b) {\n AtA <- A$t()$matmul(A)\n x <- linalg_inv(AtA)$matmul(A$t())$matmul(b)\n x\n}\n\n# normal equations and Cholesky decomposition (done manually)\n# A_t A x = A_t b\n# L L_t x = A_t b\n# L y = A_t b \n# L_t x = y\nls_cholesky_diy <- function(A, b) {\n # add a small multiple of the identity matrix \n # to counteract numerical instability\n # if Cholesky decomposition fails in your \n # setup, increase eps\n eps <- 1e-10\n id <- eps * torch_diag(torch_ones(dim(A)[2]))\n AtA <- A$t()$matmul(A) + id\n Atb <- A$t()$matmul(b)\n L <- linalg_cholesky(AtA)\n y <- torch_triangular_solve(\n Atb$unsqueeze(2),\n L,\n upper = FALSE\n )[[1]]\n x <- torch_triangular_solve(y, L$t())[[1]]\n x\n}\n\n# normal equations and LU factorization (done manually)\n# A_t A x = A_t b\n# P L U x = A_t b\n# L y = P_t A_t b          # where y = U x\n# U x = y\nls_lu_diy <- function(A, b) {\n AtA <- A$t()$matmul(A)\n Atb <- A$t()$matmul(b)\n lu <- torch_lu(AtA)\n c(P, L, U) %<-% torch_lu_unpack(lu[[1]], lu[[2]]) \n Atb <- P$t()$matmul(Atb)\n y <- torch_triangular_solve(\n Atb$unsqueeze(2),\n L,\n upper = FALSE\n )[[1]]\n x <- torch_triangular_solve(y, U)[[1]]\n x\n}\n\n# QR factorization\n# A x = b\n# Q R x = b\n# R x = Q_t b \nls_qr <- function(A, b) {\n c(Q, R) %<-% linalg_qr(A)\n Qtb <- Q$t()$matmul(b)\n x <- torch_triangular_solve(Qtb$unsqueeze(2), R)[[1]]\n x\n}\n\n# SVD\n# A x = b\n# U S V_ x = b\n# S V_t x = U_t b\n# S y = U_t b \n# V_t x = y\nls_svd <- function(A, b) {\n c(U, S, Vt) %<-% linalg_svd(A, full_matrices = FALSE)\n Utb <- U$t()$matmul(b)\n y <- Utb / S\n x <- Vt$t()$matmul(y)\n x\n}\n```", "```r\nalgorithms <- c(\n \"ls_normal_eq\",\n \"ls_cholesky_diy\",\n \"ls_lu_diy\",\n \"ls_qr\",\n \"ls_svd\"\n)\n\nrmses <- purrr::map(\n algorithms,\n function(m) {\n rmse(\n as.numeric(b),\n as.numeric(A$matmul(get(m)(A, b)))\n )\n }\n)\n\nrmse_df <- data.frame(\n method = algorithms,\n rmse = unlist(rmses)\n)\n\nrmse_df\n```", "```r\n method         rmse\n1    ls_normal_eq 2.882399e-03\n2 ls_cholesky_diy 1.373906e-06\n3       ls_lu_diy 1.274305e-07\n4           ls_qr 3.436749e-08\n5          ls_svd 3.436749e-08\n```"]