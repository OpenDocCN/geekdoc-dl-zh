- en: Direct Alignment Algorithms
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ç›´æ¥å¯¹é½ç®—æ³•
- en: Direct Alignment Algorithms (DAAs) allow one to update models to solve the same
    RLHF objective, shown again in eq.Â [68](ch012.xhtml#eq:review_rlhf), without ever
    training an intermediate reward model or using reinforcement learning optimizers.
    It solves the same preference learning problem weâ€™ve been studying (with literally
    the same data!), in order to make language models more aligned, smarter, and easier
    to use. The lack of a reward model and online optimization makes DAAs far simpler
    to implement, reducing compute spent during training and making experimentation
    easier. This chapter details the complex mathematics that were done to derive
    these algorithms, and then shows that the sometimes tedious derivations result
    in simple implementations.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: ç›´æ¥å¯¹é½ç®—æ³•ï¼ˆDAAsï¼‰å…è®¸æ›´æ–°æ¨¡å‹ä»¥è§£å†³ç›¸åŒçš„RLHFç›®æ ‡ï¼Œå¦‚ç­‰å¼[68](ch012.xhtml#eq:review_rlhf)æ‰€ç¤ºï¼Œè€Œæ— éœ€è®­ç»ƒä»»ä½•ä¸­é—´å¥–åŠ±æ¨¡å‹æˆ–ä½¿ç”¨å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–å™¨ã€‚å®ƒè§£å†³äº†æˆ‘ä»¬ä¸€ç›´åœ¨ç ”ç©¶ï¼ˆå®é™…ä¸Šä½¿ç”¨çš„æ˜¯ç›¸åŒçš„æ•°æ®ï¼ï¼‰çš„ç›¸åŒåå¥½å­¦ä¹ é—®é¢˜ï¼Œç›®çš„æ˜¯ä½¿è¯­è¨€æ¨¡å‹æ›´åŠ å¯¹é½ã€æ›´æ™ºèƒ½ã€æ›´æ˜“äºä½¿ç”¨ã€‚æ²¡æœ‰å¥–åŠ±æ¨¡å‹å’Œåœ¨çº¿ä¼˜åŒ–ä½¿å¾—DAAsçš„å®ç°æ›´åŠ ç®€å•ï¼Œå‡å°‘äº†è®­ç»ƒè¿‡ç¨‹ä¸­çš„è®¡ç®—é‡ï¼Œå¹¶ä½¿å®éªŒæ›´å®¹æ˜“è¿›è¡Œã€‚æœ¬ç« è¯¦ç»†ä»‹ç»äº†ä¸ºäº†æ¨å¯¼è¿™äº›ç®—æ³•æ‰€è¿›è¡Œçš„å¤æ‚æ•°å­¦ï¼Œç„¶åå±•ç¤ºäº†æœ‰æ—¶ç¹ççš„æ¨å¯¼æœ€ç»ˆå¯¼è‡´äº†ç®€å•çš„å®ç°ã€‚
- en: 'The most prominent DAA and one that catalyzed an entire academic movement of
    aligning language models is Direct Preference Optimization (DPO) [[20]](ch021.xhtml#ref-rafailov2024direct).
    At its core, DPO is using gradient ascent to solve the same constrained RLHF objective
    (see Chapter 4):'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€çªå‡ºçš„DAAä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å‚¬åŒ–äº†æ•´ä¸ªå°†è¯­è¨€æ¨¡å‹å¯¹é½çš„å­¦æœ¯è¿åŠ¨çš„æ˜¯ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰[[20]](ch021.xhtml#ref-rafailov2024direct)ã€‚åœ¨å…¶æ ¸å¿ƒï¼ŒDPOæ˜¯ä½¿ç”¨æ¢¯åº¦ä¸Šå‡æ¥è§£å†³ç›¸åŒçš„çº¦æŸRLHFç›®æ ‡ï¼ˆè§ç¬¬4ç« ï¼‰ï¼š
- en: <semantics><mrow><munder><mi mathvariant="normal">max</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mo>âˆ’</mo><mi>Î²</mi><msub><mi>ğ’Ÿ</mi><mtext
    mathvariant="normal">KL</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>68</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\max_{\pi}
    \mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)} \left[r_\theta(x,
    y)\right] - \beta \mathcal{D}_{\text{KL}}\left(\pi(y|x) \| \pi_{\text{ref}}(y|x)\right)\qquad{(68)}</annotation></semantics>
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><munder><mi mathvariant="normal">max</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mo>âˆ’</mo><mi>Î²</mi><msub><mi>ğ’Ÿ</mi><mtext
    mathvariant="normal">KL</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mi><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>68</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\max_{\pi}
    \mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)} \left[r_\theta(x,
    y)\right] - \beta \mathcal{D}_{\text{KL}}\left(\pi(y|x) \| \pi_{\text{ref}}(y|x)\right)\qquad{(68)}</annotation></semantics>
- en: Since its release in May of 2023, after a brief delay where the community figured
    out the right data and hyperparameters to use DPO with (specifically, surprisingly
    low learning rates), many popular models have used DPO or its variants, from Zephyr-<semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics> kickstarting it in
    October of 2023 [[21]](ch021.xhtml#ref-tunstall2023zephyr), Llama 3 Instruct [[24]](ch021.xhtml#ref-dubey2024llama),
    TÃ¼lu 2 [[22]](ch021.xhtml#ref-ivison2023camels) and 3 [[6]](ch021.xhtml#ref-lambert2024t),
    Nemotron 4 340B [[25]](ch021.xhtml#ref-adler2024nemotron), and others. Technically,
    Sequence Likelihood Calibration (SLiC-HF) was the first, modern direct alignment
    algorithm released [[210]](ch021.xhtml#ref-zhao2023slic), but it did not catch
    on due to a combination of factors (unwinding the adoption of research methods
    is always a tricky task).
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: è‡ª2023å¹´5æœˆå‘å¸ƒä»¥æ¥ï¼Œç»è¿‡çŸ­æš‚çš„å»¶è¿Ÿï¼ˆç¤¾åŒºæ‰¾åˆ°äº†ä½¿ç”¨DPOçš„æ­£ç¡®æ•°æ®å’Œè¶…å‚æ•°ï¼Œç‰¹åˆ«æ˜¯å‡ºäººæ„æ–™åœ°ä½çš„å­¦ä¹ ç‡ï¼‰ï¼Œè®¸å¤šæµè¡Œçš„æ¨¡å‹å·²ç»ä½¿ç”¨äº†DPOæˆ–å…¶å˜ä½“ï¼Œä»2023å¹´10æœˆå¯åŠ¨çš„Zephyr-<semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics> [[21]](ch021.xhtml#ref-tunstall2023zephyr)ï¼ŒLlama
    3 Instruct [[24]](ch021.xhtml#ref-dubey2024llama)ï¼ŒTÃ¼lu 2 [[22]](ch021.xhtml#ref-ivison2023camels)
    å’Œ 3 [[6]](ch021.xhtml#ref-lambert2024t)ï¼ŒNemotron 4 340B [[25]](ch021.xhtml#ref-adler2024nemotron)ï¼Œä»¥åŠå…¶ä»–æ¨¡å‹ã€‚æŠ€æœ¯ä¸Šè®²ï¼Œåºåˆ—ä¼¼ç„¶æ ¡å‡†ï¼ˆSLiC-HFï¼‰æ˜¯ç¬¬ä¸€ä¸ªå‘å¸ƒçš„ç°ä»£ç›´æ¥å¯¹é½ç®—æ³•
    [[210]](ch021.xhtml#ref-zhao2023slic)ï¼Œä½†ç”±äºå¤šç§å› ç´ ï¼ˆé€†è½¬ç ”ç©¶æ–¹æ³•çš„é‡‡ç”¨æ€»æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼‰å¹¶æœªæµè¡Œèµ·æ¥ã€‚
- en: The most impactful part of DPO and DAAs is lowering the barrier of entry to
    experimenting with language model post-training â€“ it uses less compute, is easier
    to implement from scratch, and is easier to get working on both toy and production
    examples.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: DPOå’ŒDAAsæœ€å…·å½±å“åŠ›çš„éƒ¨åˆ†æ˜¯é™ä½äº†åœ¨è®­ç»ƒåå°è¯•è¯­è¨€æ¨¡å‹çš„é—¨æ§›â€”â€”å®ƒä½¿ç”¨çš„è®¡ç®—èµ„æºæ›´å°‘ï¼Œä»å¤´å¼€å§‹å®ç°æ›´å®¹æ˜“ï¼Œå¹¶ä¸”æ›´å®¹æ˜“åœ¨ç©å…·å’Œå®é™…ç”Ÿäº§æ¡ˆä¾‹ä¸­è¿è¡Œã€‚
- en: '*Throughout this chapter, we use <semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics>
    to denote prompts and <semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics>
    to denote completions. This notation is common in the language model literature,
    where methods operate on full prompt-completion pairs rather than individual tokens.*'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: '*åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics>è¡¨ç¤ºæç¤ºï¼Œ<semantics><mi>y</mi><annotation
    encoding="application/x-tex">y</annotation></semantics>è¡¨ç¤ºå®Œæˆã€‚è¿™ç§ç¬¦å·åœ¨è¯­è¨€æ¨¡å‹æ–‡çŒ®ä¸­å¾ˆå¸¸è§ï¼Œå…¶ä¸­æ–¹æ³•æ“ä½œçš„æ˜¯å®Œæ•´çš„æç¤º-å®Œæˆå¯¹ï¼Œè€Œä¸æ˜¯å•ä¸ªæ ‡è®°ã€‚*'
- en: Direct Preference Optimization (DPO)
  id: totrans-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰
- en: Here we explain intuitions for how DPO works and re-derive the core equations
    fully.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è§£é‡ŠDPOçš„å·¥ä½œç›´è§‰å¹¶é‡æ–°æ¨å¯¼æ ¸å¿ƒæ–¹ç¨‹ã€‚
- en: How DPO Works
  id: totrans-9
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: DPOæ˜¯å¦‚ä½•å·¥ä½œçš„
- en: 'DPO at a surface level is directly optimizing a policy to solve the RLHF objective.
    The loss function for this, which we will revisit below in the derivations, is
    a pairwise relationship of log-probabilities. The loss function derived from a
    Bradley-Terry reward model follows:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¡¨é¢å±‚é¢ä¸Šï¼ŒDPOæ˜¯ç›´æ¥ä¼˜åŒ–ç­–ç•¥ä»¥è§£å†³RLHFç›®æ ‡ã€‚è¿™ä¸ªæŸå¤±å‡½æ•°ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„æ¨å¯¼ä¸­é‡æ–°å®¡è§†ï¼Œæ˜¯æˆå¯¹çš„å¯¹æ•°æ¦‚ç‡å…³ç³»ã€‚ä»Bradley-Terryå¥–åŠ±æ¨¡å‹æ¨å¯¼å‡ºçš„æŸå¤±å‡½æ•°å¦‚ä¸‹ï¼š
- en: <semantics><mrow><msub><mi>â„’</mi><mtext mathvariant="normal">DPO</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo>;</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi mathvariant="normal">log</mi><mi>Ïƒ</mi><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo
    stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>69</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\mathcal{L}_{\text{DPO}}(\pi_\theta;
    \pi_{\text{ref}}) = -\mathbb{E}_{(x, y_c, y_r) \sim \mathcal{D}}\left[ \log \sigma\left(
    \beta \log \frac{\pi_{\theta}(y_c \mid x)}{\pi_{\text{ref}}(y_c \mid x)} - \beta
    \log \frac{\pi_{\theta}(y_r \mid x)}{\pi_{\text{ref}}(y_r \mid x)} \right) \right]
    \qquad{(69)}</annotation></semantics>
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><msub><mi>â„’</mi><mtext mathvariant="normal">DPO</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo>;</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi mathvariant="normal">log</mi><mi>Ïƒ</mi><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo
    stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>69</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\mathcal{L}_{\text{DPO}}(\pi_\theta;
    \pi_{\text{ref}}) = -\mathbb{E}_{(x, y_c, y_r) \sim \mathcal{D}}\left[ \log \sigma\left(
    \beta \log \frac{\pi_{\theta}(y_c \mid x)}{\pi_{\text{ref}}(y_c \mid x)} - \beta
    \log \frac{\pi_{\theta}(y_r \mid x)}{\pi_{\text{ref}}(y_r \mid x)} \right) \right]
    \qquad{(69)}</annotation></semantics>
- en: 'Throughout, <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>
    is a hyperparameter balancing the reward optimization to the KL distance between
    the final model and the initial reference (i.e.Â balancing over-optimization, as
    a crucial hyperparameter to using DPO correction). This relies on the implicit
    reward for DPO training that replaces using an external reward model, which is
    a log-ratio of probabilities:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œ<semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>
    æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œç”¨äºå¹³è¡¡å¥–åŠ±ä¼˜åŒ–ä¸æœ€ç»ˆæ¨¡å‹ä¸åˆå§‹å‚è€ƒæ¨¡å‹ä¹‹é—´çš„KLè·ç¦»ï¼ˆå³å¹³è¡¡è¿‡åº¦ä¼˜åŒ–ï¼Œä½œä¸ºä½¿ç”¨DPOæ ¡æ­£çš„å…³é”®è¶…å‚æ•°ï¼‰ã€‚è¿™ä¾èµ–äºDPOè®­ç»ƒçš„éšå«å¥–åŠ±ï¼Œå®ƒå–ä»£äº†ä½¿ç”¨å¤–éƒ¨å¥–åŠ±æ¨¡å‹ï¼Œåè€…æ˜¯æ¦‚ç‡çš„å¯¹æ•°æ¯”ç‡ï¼š
- en: <semantics><mrow><mi>r</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msub><mi>Ï€</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow></mfrac><mrow><mo stretchy="false" form="prefix">(</mo><mn>70</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r(x,
    y) = \beta \log \frac{\pi_r(y \mid x)}{\pi_{\text{ref}}(y \mid x)}\qquad{(70)}</annotation></semantics>
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mi>r</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msub><mi>Ï€</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow></mfrac><mrow><mo stretchy="false" form="prefix">(</mo><mn>70</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r(x,
    y) = \beta \log \frac{\pi_r(y \mid x)}{\pi_{\text{ref}}(y \mid x)}\qquad{(70)}</annotation></semantics>
- en: where <semantics><mrow><msub><mi>Ï€</mi><mi>r</mi></msub><mo stretchy="false"
    form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">\pi_r(y \mid x)</annotation></semantics> is the exact,
    optimal reward policy that we are solving for. This comes from deriving the Bradley-Terry
    reward with respect to an optimal policy (shown in eq.Â [84](ch012.xhtml#eq:dpo_opt_policy)),
    as shown in the Bradley-Terry model section of Chapter 7\. Essentially, the implicit
    reward model shows â€œthe probability of human preference data in terms of the optimal
    policy rather than the reward model.â€
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: å…¶ä¸­ <semantics><mrow><msub><mi>Ï€</mi><mi>r</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\pi_r(y
    \mid x)</annotation></semantics> æ˜¯æˆ‘ä»¬æ­£åœ¨è§£å†³çš„ç²¾ç¡®ã€æœ€ä¼˜å¥–åŠ±ç­–ç•¥ã€‚è¿™æ¥è‡ªäºæ ¹æ®æœ€ä¼˜ç­–ç•¥ï¼ˆå¦‚ç¬¬7ç« çš„å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œå¥–åŠ±æ¨¡å‹éƒ¨åˆ†ä¸­æ‰€ç¤ºï¼Œè§ç­‰å¼[84](ch012.xhtml#eq:dpo_opt_policy)ï¼‰æ¨å¯¼å‡ºçš„å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œå¥–åŠ±ï¼Œæ­£å¦‚ç¬¬7ç« çš„å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œæ¨¡å‹éƒ¨åˆ†æ‰€ç¤ºã€‚æœ¬è´¨ä¸Šï¼Œéšå¼å¥–åŠ±æ¨¡å‹æ˜¾ç¤ºäº†â€œä»¥æœ€ä¼˜ç­–ç•¥è€Œä¸æ˜¯å¥–åŠ±æ¨¡å‹æ¥è¡¨ç¤ºäººç±»åå¥½æ•°æ®çš„æ¦‚ç‡ã€‚â€
- en: Let us consider the loss shown in eq.Â [69](ch012.xhtml#eq:dpo_core) that the
    optimizer must decrease. Here, the loss will be lower when the log-ratio of the
    chosen response is bigger than the log-ratio of the rejected response (normalized
    by the reference model). In practice, this is a sum of log-probabilities of the
    model across the sequence of tokens in the data presented. Hence, DPO is increasing
    the delta in probabilities between the chosen and rejected responses.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬è€ƒè™‘ç­‰å¼[69](ch012.xhtml#eq:dpo_core)ä¸­æ˜¾ç¤ºçš„æŸå¤±ï¼Œä¼˜åŒ–å™¨å¿…é¡»å‡å°‘è¿™ä¸ªæŸå¤±ã€‚åœ¨è¿™é‡Œï¼Œå½“æ‰€é€‰å“åº”çš„å¯¹æ•°æ¯”ç‡å¤§äºè¢«æ‹’ç»å“åº”çš„å¯¹æ•°æ¯”ç‡ï¼ˆæŒ‰å‚è€ƒæ¨¡å‹å½’ä¸€åŒ–ï¼‰æ—¶ï¼ŒæŸå¤±ä¼šæ›´ä½ã€‚åœ¨å®è·µä¸­ï¼Œè¿™æ˜¯æ¨¡å‹åœ¨æ•°æ®å‘ˆç°çš„æ ‡è®°åºåˆ—ä¸­çš„å¯¹æ•°æ¦‚ç‡çš„æ€»å’Œã€‚å› æ­¤ï¼ŒDPOæ­£åœ¨å¢åŠ æ‰€é€‰å’Œè¢«æ‹’ç»å“åº”ä¹‹é—´çš„æ¦‚ç‡å·®å¼‚ã€‚
- en: 'With the reward in eq.Â [70](ch012.xhtml#eq:dpo_reward), we can write the gradient
    of the loss to further interpret what is going on:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ç­‰å¼[70](ch012.xhtml#eq:dpo_reward)ä¸­çš„å¥–åŠ±ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºæŸå¤±çš„æ¢¯åº¦ä»¥è¿›ä¸€æ­¥è§£é‡Šæ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ï¼š
- en: <semantics><mrow><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><msub><mi>â„’</mi><mtext mathvariant="normal">DPO</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo>;</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><mi>Î²</mi><msub><mi>ğ”¼</mi><mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi>Ïƒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi mathvariant="normal">log</mi><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi
    mathvariant="normal">log</mi><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo
    stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>71</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\nabla_{\theta}\mathcal{L}_{\text{DPO}}(\pi_{\theta};
    \pi_{\text{ref}}) = -\beta \mathbb{E}_{(x, y_c, y_r)\sim \mathcal{D}}\left[ \sigma\left(r_{\theta}(x,
    y_r) - r_{\theta}(x, y_c)\right) \left(\nabla_{\theta}\log \pi(y_c \mid x) - \nabla_{\theta}\log
    \pi(y_r \mid x)\right) \right] \qquad{(71)}</annotation></semantics>
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><msub><mi>â„’</mi><mtext mathvariant="normal">DPO</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo>;</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><mi>Î²</mi><msub><mi>ğ”¼</mi><mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi>Ïƒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi mathvariant="normal">log</mi><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi
    mathvariant="normal">log</mi><mi>Ï€</mi><mo stretchy="false" form="postfix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo
    stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>71</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\nabla_{\theta}\mathcal{L}_{\text{DPO}}(\pi_{\theta};
    \pi_{\text{ref}}) = -\beta \mathbb{E}_{(x, y_c, y_r)\sim \mathcal{D}}\left[ \sigma\left(r_{\theta}(x,
    y_r) - r_{\theta}(x, y_c)\right) \left(\nabla_{\theta}\log \pi(y_c \mid x) - \nabla_{\theta}\log
    \pi(y_r \mid x)\right) \right] \qquad{(71)}</annotation></semantics>
- en: 'Here, the gradient solves the above objective by doing the following:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™é‡Œï¼Œæ¢¯åº¦é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³ä¸Šè¿°ç›®æ ‡ï¼š
- en: The first term within the sigmoid function, <semantics><mrow><mi>Ïƒ</mi><mo stretchy="false"
    form="prefix">(</mo><mi>â‹…</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">\sigma(\cdot)</annotation></semantics>, creates a
    weight of the parameter update from 0 to 1 that is higher when the reward estimate
    is incorrect. When the rejected sample is preferred over the chosen, the weight
    update should be larger!
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Sigmoidå‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ªé¡¹ï¼Œ<semantics><mrow><mi>Ïƒ</mi><mo stretchy="false" form="prefix">(</mo><mi>â‹…</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\sigma(\cdot)</annotation></semantics>ï¼Œåˆ›å»ºäº†ä¸€ä¸ªä»0åˆ°1çš„å‚æ•°æ›´æ–°æƒé‡ï¼Œå½“å¥–åŠ±ä¼°è®¡ä¸æ­£ç¡®æ—¶æƒé‡æ›´é«˜ã€‚å½“æ‹’ç»çš„æ ·æœ¬è¢«ä¼˜å…ˆé€‰æ‹©æ—¶ï¼Œæƒé‡æ›´æ–°åº”è¯¥æ›´å¤§ï¼
- en: Second, the terms in the inner brackets <semantics><mrow><mo stretchy="false"
    form="prefix">[</mo><mi>â‹…</mi><mo stretchy="false" form="postfix">]</mo></mrow><annotation
    encoding="application/x-tex">[\cdot]</annotation></semantics> increase the likelihood
    of the chosen response <semantics><msub><mi>y</mi><mi>c</mi></msub><annotation
    encoding="application/x-tex">y_c</annotation></semantics> and decrease the likelihood
    of the rejected <semantics><msub><mi>y</mi><mi>r</mi></msub><annotation encoding="application/x-tex">y_r</annotation></semantics>.
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å…¶æ¬¡ï¼Œå†…æ‹¬å·ä¸­çš„æœ¯è¯­<semantics><mrow><mo stretchy="false" form="prefix">[</mo><mi>â‹…</mi><mo
    stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[\cdot]</annotation></semantics>å¢åŠ äº†æ‰€é€‰å“åº”<semantics><msub><mi>y</mi><mi>c</mi></msub><annotation
    encoding="application/x-tex">y_c</annotation></semantics>çš„å¯èƒ½æ€§ï¼Œå¹¶å‡å°‘äº†è¢«æ‹’ç»çš„<semantics><msub><mi>y</mi><mi>r</mi></msub><annotation
    encoding="application/x-tex">y_r</annotation></semantics>çš„å¯èƒ½æ€§ã€‚
- en: These terms are weighted by <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>,
    which controls how the update balances ordering the completions correctly relative
    to the KL distance.
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: è¿™äº›æœ¯è¯­é€šè¿‡<semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>è¿›è¡ŒåŠ æƒï¼Œå®ƒæ§åˆ¶äº†æ›´æ–°å¦‚ä½•å¹³è¡¡æ­£ç¡®æ’åºå®Œæˆé¡¹ä¸KLè·ç¦»ä¹‹é—´çš„å…³ç³»ã€‚
- en: The core intuition is that DPO is fitting an implicit reward model whose corresponding
    optimal policy can be extracted in a closed form (thanks to gradient descent and
    our ML tools). The closed form of the equation means that it is straightforward
    to implement the exact gradient, rather than needing to reach it by proxy of training
    a reward model and sampling completions to score. What is often misunderstood
    is that DPO is learning a reward model at its core, hence the subtitle of the
    paper *Your Language Model is Secretly a Reward Model.* It is easy to confuse
    this with the DPO objective training a policy directly, hence studying the derivations
    below is good for a complete understanding.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: æ ¸å¿ƒç›´è§‰æ˜¯DPOæ­£åœ¨æ‹Ÿåˆä¸€ä¸ªéšå¼å¥–åŠ±æ¨¡å‹ï¼Œå…¶ç›¸åº”çš„æœ€ä½³ç­–ç•¥å¯ä»¥ä»¥é—­å¼å½¢å¼æå–ï¼ˆå¤šäºäº†æ¢¯åº¦ä¸‹é™å’Œæˆ‘ä»¬çš„MLå·¥å…·ï¼‰ã€‚æ–¹ç¨‹çš„é—­å¼å½¢å¼æ„å‘³ç€å®ç°ç²¾ç¡®æ¢¯åº¦æ˜¯ç›´æ¥çš„ï¼Œè€Œä¸æ˜¯éœ€è¦é€šè¿‡è®­ç»ƒå¥–åŠ±æ¨¡å‹å’Œé‡‡æ ·å®Œæˆé¡¹æ¥è¯„åˆ†æ¥é—´æ¥è¾¾åˆ°ã€‚å¸¸è¢«è¯¯è§£çš„æ˜¯ï¼ŒDPOåœ¨æœ¬è´¨ä¸Šæ˜¯åœ¨å­¦ä¹ ä¸€ä¸ªå¥–åŠ±æ¨¡å‹ï¼Œå› æ­¤è®ºæ–‡çš„å‰¯æ ‡é¢˜æ˜¯*Your
    Language Model is Secretly a Reward Model.* å®¹æ˜“å°†å…¶ä¸ç›´æ¥è®­ç»ƒç­–ç•¥çš„DPOç›®æ ‡æ··æ·†ï¼Œå› æ­¤ç ”ç©¶ä¸‹é¢çš„æ¨å¯¼å¯¹å®Œæ•´ç†è§£å¾ˆæœ‰å¸®åŠ©ã€‚
- en: With the implicit reward model learning, DPO is generating an optimal solution
    to the RLHF objective given the data in the dataset and the specific KL constraint
    in the objective <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>.
    Here, DPO solves for the exact policy given a specific KL distance because the
    generations are not online as in policy gradient algorithms â€“ a core difference
    from the RL methods for preference tuning. In many ways, this makes the <semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics> value easier to tune
    with DPO relative to online RL methods, but crucially and intuitively the optimal
    value depends on the model being trained and the data training it.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨éšå¼å¥–åŠ±æ¨¡å‹å­¦ä¹ çš„æƒ…å†µä¸‹ï¼ŒDPOæ ¹æ®æ•°æ®é›†ä¸­çš„æ•°æ®å’Œç›®æ ‡ä¸­çš„ç‰¹å®šKLçº¦æŸç”ŸæˆRLHFç›®æ ‡çš„æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚<semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics>ã€‚åœ¨è¿™é‡Œï¼ŒDPOé’ˆå¯¹ç‰¹å®šçš„KLè·ç¦»æ±‚è§£ç²¾ç¡®ç­–ç•¥ï¼Œå› ä¸ºç”Ÿæˆä¸æ˜¯åœ¨çº¿çš„ï¼Œå°±åƒç­–ç•¥æ¢¯åº¦ç®—æ³•é‚£æ ·â€”â€”è¿™æ˜¯ä¸åå¥½è°ƒæ•´çš„RLæ–¹æ³•çš„æ ¸å¿ƒåŒºåˆ«ã€‚åœ¨è®¸å¤šæ–¹é¢ï¼Œè¿™ä½¿å¾—ä¸åœ¨çº¿RLæ–¹æ³•ç›¸æ¯”ï¼Œä½¿ç”¨DPOè°ƒæ•´<semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics>å€¼æ›´å®¹æ˜“ï¼Œä½†å…³é”®ä¸”ç›´è§‚çš„æ˜¯ï¼Œæœ€ä½³å€¼å–å†³äºæ­£åœ¨è®­ç»ƒçš„æ¨¡å‹å’Œè®­ç»ƒå®ƒçš„æ•°æ®ã€‚
- en: At each batch of preference data, composed of many pairs of completions <semantics><mrow><msub><mi>y</mi><mrow><mi>c</mi><mi>h</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>n</mi></mrow></msub><mo>â‰»</mo><msub><mi>y</mi><mrow><mi>r</mi><mi>e</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>d</mi></mrow></msub></mrow><annotation
    encoding="application/x-tex">y_{chosen} \succ y_{rejected}</annotation></semantics>,
    DPO takes gradient steps directly towards the optimal solution. It is far simpler
    than policy gradient methods.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æ¯ä¸ªåå¥½æ•°æ®æ‰¹æ¬¡ä¸­ï¼Œç”±è®¸å¤šå¯¹å®Œæˆé¡¹<semantics><mrow><msub><mi>y</mi><mrow><mi>c</mi><mi>h</mi><mi>o</mi><mi}s</mi><mi>e</mi><mi>n</mi></mrow></msub><mo>â‰»</mo><msub><mi>y</mi><mrow><mi>r</mi><mi>e</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>d</mi></mrow></msub></mrow><annotation
    encoding="application/x-tex">y_{chosen} \succ y_{rejected}</annotation></semantics>ç»„æˆï¼ŒDPOç›´æ¥å‘æœ€ä½³è§£å†³æ–¹æ¡ˆé‡‡å–æ¢¯åº¦æ­¥éª¤ã€‚è¿™æ¯”ç­–ç•¥æ¢¯åº¦æ–¹æ³•ç®€å•å¾—å¤šã€‚
- en: '![Figure 18: When DPO first released it sparked a fierce debate in the research
    community about how to best do RLHF and preference learning. This meme is a great
    job capturing the sentiment, where the debate often felt forced and over the top,
    but many people both getting started and in top labs were getting immense benefit
    out of DPO. DPO simplicity meme, credit Tom Goldstein.](../media/file16.jpg)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
  zh: '![å›¾ 18ï¼šå½“ DPO é¦–æ¬¡å‘å¸ƒæ—¶ï¼Œå®ƒåœ¨ç ”ç©¶ç¤¾åŒºä¸­å¼•å‘äº†å…³äºå¦‚ä½•æœ€å¥½åœ°è¿›è¡Œ RLHF å’Œåå¥½å­¦ä¹ çš„æ¿€çƒˆè¾©è®ºã€‚è¿™ä¸ªæ¢—å¾ˆå¥½åœ°æ•æ‰äº†è¿™ç§æƒ…ç»ªï¼Œè¾©è®ºå¾€å¾€æ„Ÿè§‰æ˜¯è¢«å¼ºåŠ çš„ï¼Œè¿‡äºå¤¸å¼ ï¼Œä½†è®¸å¤šåˆšå¼€å§‹å’Œå¤„äºé¡¶çº§å®éªŒå®¤çš„äººä»¬éƒ½ä»
    DPO ä¸­è·å¾—äº†å·¨å¤§çš„ç›Šå¤„ã€‚DPO ç®€åŒ–æ¢—ï¼Œå½’åŠŸäºæ±¤å§†Â·æˆˆå°”èŒ¨å¦ã€‚](../media/file16.jpg)'
- en: 'Figure 18: When DPO first released it sparked a fierce debate in the research
    community about how to best do RLHF and preference learning. This meme is a great
    job capturing the sentiment, where the debate often felt forced and over the top,
    but many people both getting started and in top labs were getting immense benefit
    out of DPO. DPO simplicity meme, credit Tom Goldstein.'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: å›¾ 18ï¼šå½“ DPO é¦–æ¬¡å‘å¸ƒæ—¶ï¼Œå®ƒåœ¨ç ”ç©¶ç¤¾åŒºä¸­å¼•å‘äº†å…³äºå¦‚ä½•æœ€å¥½åœ°è¿›è¡Œ RLHF å’Œåå¥½å­¦ä¹ çš„æ¿€çƒˆè¾©è®ºã€‚è¿™ä¸ªæ¢—å¾ˆå¥½åœ°æ•æ‰äº†è¿™ç§æƒ…ç»ªï¼Œè¾©è®ºå¾€å¾€æ„Ÿè§‰æ˜¯è¢«å¼ºåŠ çš„ï¼Œè¿‡äºå¤¸å¼ ï¼Œä½†è®¸å¤šåˆšå¼€å§‹å’Œå¤„äºé¡¶çº§å®éªŒå®¤çš„äººä»¬éƒ½ä»
    DPO ä¸­è·å¾—äº†å·¨å¤§çš„ç›Šå¤„ã€‚DPO ç®€åŒ–æ¢—ï¼Œå½’åŠŸäºæ±¤å§†Â·æˆˆå°”èŒ¨å¦ã€‚
- en: DPO Derivation
  id: totrans-27
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: DPO æ¨å¯¼
- en: The DPO derivation takes two primary parts. First, the authors show the form
    of the policy that optimally solved the RLHF objective used throughout this book.
    Next, they show how to arrive at that solution from pairwise preference data (i.e.Â a
    Bradley Terry model).
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: DPO æ¨å¯¼åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ã€‚é¦–å…ˆï¼Œä½œè€…å±•ç¤ºäº†åœ¨æ•´ä¸ªä¹¦ä¸­ä½¿ç”¨çš„ RLHF ç›®æ ‡æœ€ä¼˜ç­–ç•¥çš„å½¢å¼ã€‚æ¥ä¸‹æ¥ï¼Œä»–ä»¬å±•ç¤ºäº†å¦‚ä½•ä»æˆå¯¹åå¥½æ•°æ®ï¼ˆå³å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œæ¨¡å‹ï¼‰åˆ°è¾¾é‚£ä¸ªè§£å†³æ–¹æ¡ˆã€‚
- en: 1\. Deriving the Optimal RLHF Solution
  id: totrans-29
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 1. æ¨å¯¼æœ€ä¼˜ RLHF è§£å†³æ–¹æ¡ˆ
- en: 'To start, we should consider the RLHF optimization objective once again, here
    indicating we wish to maximize this quantity:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥å†æ¬¡è€ƒè™‘ RLHF ä¼˜åŒ–ç›®æ ‡ï¼Œè¿™é‡Œè¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›æœ€å¤§åŒ–è¿™ä¸ªé‡ï¼š
- en: <semantics><mrow><munder><mi mathvariant="normal">max</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mo>âˆ’</mo><mi>Î²</mi><msub><mi>ğ’Ÿ</mi><mtext
    mathvariant="normal">KL</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>72</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\max_{\pi}
    \mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)} \left[r_\theta(x,
    y)\right] - \beta \mathcal{D}_{\text{KL}}\left(\pi(y|x) \| \pi_{\text{ref}}(y|x)\right)\qquad{(72)}</annotation></semantics>
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><munder><mi mathvariant="normal">max</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><msub><mi>r</mi><mi>Î¸</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mo>âˆ’</mo><mi>Î²</mi><msub><mi>ğ’Ÿ</mi><mtext
    mathvariant="normal">KL</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">âˆ¥</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mi><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>72</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\max_{\pi}
    \mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)} \left[r_\theta(x,
    y)\right] - \beta \mathcal{D}_{\text{KL}}\left(\pi(y|x) \| \pi_{\text{ref}}(y|x)\right)\qquad{(72)}</annotation></semantics>
- en: 'Here, the dual expectation only applies to the sampling to compute the expected
    reward, as the KL term is still an analytical expression. First, let us expand
    the definition of KL-divergence. Recall that <semantics><mrow><msub><mi>ğ’Ÿ</mi><mtext
    mathvariant="normal">KL</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>Ï€</mi><mo
    stretchy="false" form="postfix">âˆ¥</mo><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation
    encoding="application/x-tex">\mathcal{D}_{\text{KL}}(\pi \| \pi_{\text{ref}})
    = \mathbb{E}_{y \sim \pi}\left[\log \frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)}\right]</annotation></semantics>,
    where the <semantics><mrow><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">\pi(y|x)</annotation></semantics> weighting in the
    sum becomes the sampling distribution. Since both terms now share the same expectation
    over <semantics><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">y \sim \pi(y|x)</annotation></semantics>, we can
    combine them:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿™é‡Œï¼ŒåŒé‡æœŸæœ›ä»…é€‚ç”¨äºç”¨äºè®¡ç®—æœŸæœ›å¥–åŠ±çš„é‡‡æ ·ï¼Œå› ä¸ºKLé¡¹ä»ç„¶æ˜¯ä¸€ä¸ªè§£æè¡¨è¾¾å¼ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ‰©å±•KLæ•£åº¦çš„å®šä¹‰ã€‚å›å¿†ä¸€ä¸‹ <semantics><mrow><msub><mi>ğ’Ÿ</mi><mtext
    mathvariant="normal">KL</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>Ï€</mi><mo
    stretchy="false" form="postfix">âˆ¥</mo><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation
    encoding="application/x-tex">\mathcal{D}_{\text{KL}}(\pi \| \pi_{\text{ref}})
    = \mathbb{E}_{y \sim \pi}\left[\log \frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)}\right]</annotation></semantics>ï¼Œå…¶ä¸­æ±‚å’Œä¸­çš„
    <semantics><mrow><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">\pi(y|x)</annotation></semantics> æƒé‡å˜æˆäº†é‡‡æ ·åˆ†å¸ƒã€‚ç”±äºç°åœ¨ä¸¤ä¸ªé¡¹éƒ½å¯¹
    <semantics><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">y \sim \pi(y|x)</annotation></semantics> æœ‰ç›¸åŒçš„æœŸæœ›ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬åˆå¹¶ï¼š
- en: <semantics><mrow><munder><mi mathvariant="normal">max</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi>r</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>73</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">\max_{\pi} \mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y
    \sim \pi(y|x)}\left[r(x,y)-\beta\log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)}\right]
    \qquad{(73)}</annotation></semantics>
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, pull the negative sign out of the difference in brackets. To do this,
    split it into two terms:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: <semantics><mrow><mo>=</mo><munder><mi mathvariant="normal">max</mi><mi>Ï€</mi></munder><mrow><mo
    stretchy="true" form="prefix">(</mo><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mo stretchy="false" form="prefix">[</mo><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>Î²</mi><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>74</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \max_{\pi}\left(\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}[r(x,y)]
    - \beta\,\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}\left[\log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)}\right]\right)
    \qquad{(74)}</annotation></semantics>
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mo>=</mo><munder><mi mathvariant="normal">max</mi><mi>Ï€</mi></munder><mrow><mo
    stretchy="true" form="prefix">(</mo><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mo stretchy="false" form="prefix">[</mo><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo><mo>âˆ’</mo><mi>Î²</mi><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mi><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>74</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \max_{\pi}\left(\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}[r(x,y)]
    - \beta\,\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}\left[\log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)}\right]\right)
    \qquad{(74)}</annotation></semantics>
- en: Then, remove the factor of <semantics><mrow><mi>âˆ’</mi><mn>1</mn></mrow><annotation
    encoding="application/x-tex">-1</annotation></semantics> and <semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics>,
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åç§»é™¤å› å­<semantics><mrow><mi>âˆ’</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics>å’Œ<semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics>ï¼Œ
- en: <semantics><mrow><mo>=</mo><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mo stretchy="false" form="prefix">[</mo><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo><mo>+</mo><mi>Î²</mi><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mrow><mi mathvariant="normal">r</mi><mi
    mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub><mo stretchy="false"
    form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>75</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \min_{\pi}\left(-\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}[r(x,y)]
    + \beta\,\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}\left[\log\frac{\pi(y|x)}{\pi_{\mathrm{ref}}(y|x)}\right]\right)
    \qquad{(75)}</annotation></semantics>
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mo>=</mo><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mo stretchy="false" form="prefix">[</mo><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo><mo>+</mo><mi>Î²</mi><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mrow><mi mathvariant="normal">r</mi><mi
    mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub><mo stretchy="false"
    form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>75</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \min_{\pi}\left(-\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}[r(x,y)]
    + \beta\,\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}\left[\log\frac{\pi(y|x)}{\pi_{\mathrm{ref}}(y|x)}\right]\right)
    \qquad{(75)}</annotation></semantics>
- en: 'Divide by <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>
    and recombine:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: å°†å…¶é™¤ä»¥ <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>
    å¹¶é‡æ–°ç»„åˆï¼š
- en: <semantics><mrow><mo>=</mo><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><mrow><mo
    stretchy="true" form="prefix">(</mo><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true"
    form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>76</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \min_{\pi}\left(\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}\left[
    \log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)} - \frac{1}{\beta}r(x,y) \right]\right)
    \qquad{(76)}</annotation></semantics>
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mo>=</mo><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><mrow><mo
    stretchy="true" form="prefix">(</mo><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true"
    form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>76</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \min_{\pi}\left(\mathbb{E}_{x \sim \mathcal{D}}\mathbb{E}_{y \sim \pi(y|x)}\left[
    \log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)} - \frac{1}{\beta}r(x,y) \right]\right)
    \qquad{(76)}</annotation></semantics>
- en: 'Next, we must introduce a partition function, <semantics><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">Z(x)</annotation></semantics>:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»å¼•å…¥ä¸€ä¸ªé…åˆ†å‡½æ•°ï¼Œ<semantics><mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">Z(x)</annotation></semantics>ï¼š
- en: <semantics><mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><munder><mo>âˆ‘</mo><mi>y</mi></munder><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>77</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">Z(x) = \sum_y \pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)
    \qquad{(77)}</annotation></semantics>
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><munder><mo>âˆ‘</mo><mi>y</mi></munder><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>77</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">Z(x) = \sum_y \pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)
    \qquad{(77)}</annotation></semantics>
- en: 'The partition function acts as a normalization factor over the reference policy,
    summing over all possible responses <semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics>
    to a prompt <semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics>.
    With this substituted in, we obtain our intermediate transformation:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: é…åˆ†å‡½æ•°ä½œä¸ºå‚è€ƒç­–ç•¥çš„å½’ä¸€åŒ–å› å­ï¼Œå¯¹æ‰€æœ‰å¯èƒ½çš„å“åº” <semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics>
    åˆ°æç¤º <semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics>
    çš„æ€»å’Œã€‚å°†æ­¤ä»£å…¥åï¼Œæˆ‘ä»¬å¾—åˆ°æˆ‘ä»¬çš„ä¸­é—´è½¬æ¢ï¼š
- en: <semantics><mrow><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>âˆ’</mo><mi
    mathvariant="normal">log</mi><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>78</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">\min_{\pi}\mathbb{E}_{x\sim\mathcal{D}}\mathbb{E}_{y\sim\pi(y|x)}\left[\log\frac{\pi(y|x)}{\frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)}
    - \log Z(x)\right] \qquad{(78)}</annotation></semantics>
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><msub><mi>ğ”¼</mi><mrow><mi>y</mi><mo>âˆ¼</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></msub><mrow><mo stretchy="true"
    form="prefix">[</mo><mi mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>âˆ’</mo><mi
    mathvariant="normal">log</mi><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>78</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">\min_{\pi}\mathbb{E}_{x\sim\mathcal{D}}\mathbb{E}_{y\sim\pi(y|x)}\left[\log\frac{\pi(y|x)}{\frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)}
    - \log Z(x)\right] \qquad{(78)}</annotation></semantics>
- en: 'To see how this is obtained, consider the internal part of the optimization
    in brackets of eq.Â [76](ch012.xhtml#eq:dpo_deriv_4):'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: è¦äº†è§£è¿™æ˜¯å¦‚ä½•å¾—åˆ°çš„ï¼Œè€ƒè™‘æ–¹ç¨‹[76](ch012.xhtml#eq:dpo_deriv_4)ä¸­æ‹¬å·å†…çš„ä¼˜åŒ–å†…éƒ¨éƒ¨åˆ†ï¼š
- en: <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>79</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)}
    - \frac{1}{\beta}r(x,y) \qquad{(79)}</annotation></semantics>
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>79</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)}
    - \frac{1}{\beta}r(x,y) \qquad{(79)}</annotation></semantics>
- en: 'Then, add <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\log
    Z(x) - \log Z(x)</annotation></semantics> to both sides:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åï¼Œå°† <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\log
    Z(x) - \log Z(x)</annotation></semantics> æ·»åŠ åˆ°ç­‰å¼çš„ä¸¤è¾¹ï¼š
- en: <semantics><mrow><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo>+</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>80</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)} - \frac{1}{\beta}r(x,y) + \log Z(x)
    - \log Z(x) \qquad{(80)}</annotation></semantics>
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo>+</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>80</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \log\frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)} - \frac{1}{\beta}r(x,y) + \log Z(x)
    - \log Z(x) \qquad{(80)}</annotation></semantics>
- en: 'Then, we group the terms:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åï¼Œæˆ‘ä»¬å°†è¿™äº›é¡¹åˆ†ç»„ï¼š
- en: <semantics><mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi
    mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>+</mo><mi
    mathvariant="normal">log</mi><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>81</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \left( \log \frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)} + \log Z(x) \right) - \log
    Z(x) - \frac{1}{\beta}r(x,y) \qquad{(81)}</annotation></semantics>
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: '`<semantics><mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi
    mathvariant="normal">log</mi><mfrac><mrow><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mi><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>+</mo><mi
    mathvariant="normal">log</mi><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>81</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \left( \log \frac{\pi(y|x)}{\pi_{\text{ref}}(y|x)} + \log Z(x) \right) - \log
    Z(x) - \frac{1}{\beta}r(x,y) \qquad{(81)}</annotation></semantics>`'
- en: 'With <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>â‹…</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\log(x) +
    \log(y) = \log(x\cdot y)</annotation></semantics> (and moving <semantics><mi>Z</mi><annotation
    encoding="application/x-tex">Z</annotation></semantics> to the denominator), we
    get:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: é€šè¿‡ `<semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>â‹…</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\log(x) +
    \log(y) = \log(x\cdot y)</annotation></semantics>` (å¹¶å°† `<semantics><mi>Z</mi><annotation
    encoding="application/x-tex">Z</annotation></semantics>` ç§»è‡³åˆ†æ¯)ï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š
- en: <semantics><mrow><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>82</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \log \frac{\pi(y|x)}{\frac{1}{Z(x)}\pi_{\text{ref}}(y|x)}- \log Z(x) - \frac{1}{\beta}r(x,y)
    \qquad{(82)}</annotation></semantics>
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>82</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">=
    \log \frac{\pi(y|x)}{\frac{1}{Z(x)}\pi_{\text{ref}}(y|x)}- \log Z(x) - \frac{1}{\beta}r(x,y)
    \qquad{(82)}</annotation></semantics>
- en: 'Next, we expand <semantics><mrow><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\frac{1}{\beta}r(x,y)</annotation></semantics>
    to <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\log \exp
    \frac{1}{\beta}r(x,y)</annotation></semantics> and do the same operation to get
    eq.Â [78](ch012.xhtml#eq:dpo_deriv_5). With this optimization form, we need to
    actually solve for the optimal policy <semantics><msup><mi>Ï€</mi><mo>*</mo></msup><annotation
    encoding="application/x-tex">\pi^*</annotation></semantics>. To do so, let us
    consider the above optimization as a KL distance:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°† <semantics><mrow><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo stretchy="false"
    form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">\frac{1}{\beta}r(x,y)</annotation></semantics> å±•å¼€ä¸º
    <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\log \exp
    \frac{1}{\beta}r(x,y)</annotation></semantics> å¹¶å¯¹ç­‰å¼[78](ch012.xhtml#eq:dpo_deriv_5)è¿›è¡Œç›¸åŒçš„æ“ä½œã€‚é‡‡ç”¨è¿™ç§ä¼˜åŒ–å½¢å¼ï¼Œæˆ‘ä»¬éœ€è¦å®é™…æ±‚è§£æœ€ä¼˜ç­–ç•¥
    <semantics><msup><mi>Ï€</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\pi^*</annotation></semantics>ã€‚ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬å°†ä¸Šè¿°ä¼˜åŒ–è§†ä¸ºKLè·ç¦»ï¼š
- en: <semantics><mrow><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><msub><mi>ğ’Ÿ</mi><mtext mathvariant="normal">KL</mtext></msub><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="false" form="prefix">|</mo><mo stretchy="false" form="prefix">|</mo><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mi
    mathvariant="normal">exp</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true"
    form="postfix">)</mo></mrow><mo>âˆ’</mo><mi mathvariant="normal">log</mi><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>83</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\min_{\pi}\mathbb{E}_{x\sim\mathcal{D}}\left[\mathcal{D}_{\text{KL}}
    \left(\pi(y|x)||\frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)
    \right) - \log Z(x)\right] \qquad{(83)}</annotation></semantics>
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><munder><mi mathvariant="normal">min</mi><mi>Ï€</mi></munder><msub><mi>ğ”¼</mi><mrow><mi>x</mi><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><msub><mi>ğ’Ÿ</mi><mtext mathvariant="normal">KL</mtext></msub><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="false" form="prefix">|</mo><mo stretchy="false" form="prefix">|</mo><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mi
    mathvariant="normal">exp</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true"
    form="postfix">)</mo></mrow><mo>âˆ’</mo><mi mathvariant="normal">log</mi><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>83</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow> <annotation encoding="application/x-tex">\min_{\pi}\mathbb{E}_{x\sim\mathcal{D}}\left[\mathcal{D}_{\text{KL}}
    \left(\pi(y|x)||\frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)
    \right) - \log Z(x)\right] \qquad{(83)}</annotation></semantics>
- en: 'Since the partition function <semantics><mrow><mi>Z</mi><mo stretchy="false"
    form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">Z(x)</annotation></semantics> does not depend on
    the final answer, we can ignore it. This leaves us with just the KL distance between
    our policy we are learning and a form relating the partition, <semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics>, reward, and reference
    policy. The Gibbâ€™s inequality tells this is minimized at a distance of 0, only
    when the two quantities are equal! Hence, we get an optimal policy:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: ç”±äºé…åˆ†å‡½æ•° <semantics><mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">Z(x)</annotation></semantics>
    ä¸ä¾èµ–äºæœ€ç»ˆç­”æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥å®ƒã€‚è¿™ä½¿æˆ‘ä»¬åªå‰©ä¸‹æˆ‘ä»¬æ­£åœ¨å­¦ä¹ çš„ç­–ç•¥ä¸ä¸é…åˆ†ç›¸å…³çš„å½¢å¼ä¹‹é—´çš„KLè·ç¦»ï¼Œ<semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics>ï¼Œå¥–åŠ±å’Œå‚è€ƒç­–ç•¥ã€‚å‰å¸ƒæ–¯ä¸ç­‰å¼å‘Šè¯‰æˆ‘ä»¬ï¼Œå½“è¿™ä¸¤ä¸ªé‡ç›¸ç­‰æ—¶ï¼Œè·ç¦»ä¸º0ï¼Œæ­¤æ—¶è¾¾åˆ°æœ€å°åŒ–ï¼å› æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæœ€ä¼˜ç­–ç•¥ï¼š
- en: <semantics><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>84</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">\pi^*(y|x) = \pi(y|x) = \frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)
    \qquad{(84)}</annotation></semantics>
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Ï€</mi><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><mi>r</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>84</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">\pi^*(y|x) = \pi(y|x) = \frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r(x,y)\right)
    \qquad{(84)}</annotation></semantics>
- en: 2\. Deriving DPO Objective for Bradley Terry Models
  id: totrans-56
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 2. æ¨å¯¼å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œæ¨¡å‹çš„ç›®æ ‡å‡½æ•°
- en: 'To start, recall from Chapter 7 on Reward Modeling and Chapter 6 on Preference
    Data that a Bradley-Terry model of human preferences is formed as:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: é¦–å…ˆï¼Œå›é¡¾ç¬¬7ç« å…³äºå¥–åŠ±å»ºæ¨¡å’Œç¬¬6ç« å…³äºåå¥½æ•°æ®çš„å†…å®¹ï¼Œäº†è§£äººç±»åå¥½çš„å¸ƒæ‹‰å¾·åˆ©-ç‰¹é‡Œæ¨¡å‹æ˜¯å¦‚ä½•å½¢æˆçš„ï¼š
- en: <semantics><mrow><msup><mi>p</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>â‰»</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><msup><mi>r</mi><mo>*</mo></msup><mo stretchy="false"
    form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mn>1</mn></msub><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mn>2</mn></msub><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>85</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">p^*(y_1 \succ y_2 \mid x) = \frac{\exp\left(r^*(x,y_1)\right)}{\exp\left(r^*(x,y_1)\right)
    + \exp\left(r^*(x, y_2)\right)} \qquad{(85)}</annotation></semantics>
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: 'By manipulating eq.Â [84](ch012.xhtml#eq:dpo_opt_policy), we can solve for the
    optimal reward. First, take the logarithm of both sides:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mrow><mi>Z</mi><mo stretchy="false"
    form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mi
    mathvariant="normal">exp</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true"
    form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>86</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log
    \pi^*(y|x) = \log \left( \frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r^*(x,y)\right)
    \right)\qquad{(86)}</annotation></semantics>
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mrow><mi>Z</mi><mo stretchy="false"
    form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mi
    mathvariant="normal">exp</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true"
    form="postfix">)</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>86</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log
    \pi^*(y|x) = \log \left( \frac{1}{Z(x)}\pi_{\text{ref}}(y|x)\exp\left(\frac{1}{\beta}r^*(x,y)\right)
    \right)\qquad{(86)}</annotation></semantics>
- en: 'Expanding the right-hand side using <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo
    stretchy="false" form="prefix">(</mo><mi>a</mi><mi>b</mi><mi>c</mi><mo stretchy="false"
    form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>a</mi><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>b</mi><mo>+</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>c</mi></mrow><annotation
    encoding="application/x-tex">\log(abc) = \log a + \log b + \log c</annotation></semantics>:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨ <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo
    stretchy="false" form="prefix">(</mo><mi>a</mi><mi>b</mi><mi>c</mi><mo stretchy="false"
    form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>a</mi><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>b</mi><mo>+</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>c</mi></mrow><annotation
    encoding="application/x-tex">\log(abc) = \log a + \log b + \log c</annotation></semantics>
    å±•å¼€å³ä¾§ï¼š
- en: <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>+</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>87</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log
    \pi^*(y|x) = -\log Z(x) + \log \pi_{\text{ref}}(y|x) + \frac{1}{\beta}r^*(x,y)\qquad{(87)}</annotation></semantics>
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>+</mo><mfrac><mn>1</mn><mi>Î²</mi></mfrac><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>87</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log
    \pi^*(y|x) = -\log Z(x) + \log \pi_{\text{ref}}(y|x) + \frac{1}{\beta}r^*(x,y)\qquad{(87)}</annotation></semantics>
- en: 'Rearranging to solve for <semantics><mrow><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">r^*(x,y)</annotation></semantics>:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 'å¯¹ <semantics><mrow><msup><mi>r</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">r^*(x,y)</annotation></semantics>
    è¿›è¡Œé‡æ–°æ’åˆ—ä»¥æ±‚è§£:'
- en: <semantics><mrow><mfrac><mn>1</mn><mi>Î²</mi></mfrac><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>88</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{1}{\beta}r^*(x,y)
    = \log \pi^*(y|x) - \log \pi_{\text{ref}}(y|x) + \log Z(x)\qquad{(88)}</annotation></semantics>
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mfrac><mn>1</mn><mi>Î²</mi></mfrac><msup><mi>r</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo stretchy="false"
    form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><mi>y</mi><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mrow><mo stretchy="false" form="prefix">(</mo><mn>88</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{1}{\beta}r^*(x,y)
    = \log \pi^*(y|x) - \log \pi_{\text{ref}}(y|x) + \log Z(x)\qquad{(88)}</annotation></semantics>
- en: 'Multiplying both sides by <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 'ä¸¤è¾¹åŒæ—¶ä¹˜ä»¥ <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>:'
- en: <semantics><mrow><msup><mi>r</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow></mfrac><mo>+</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>89</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">r^*(x, y) = \beta \log \frac{\pi^*(y \mid x)}{\pi_{\text{ref}}(y
    \mid x)} + \beta \log Z(x)\qquad{(89)}</annotation></semantics>
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><msup><mi>r</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><mi>y</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><mi>y</mi><mo>âˆ£</mo><mi>x</mi><mo stretchy="false"
    form="postfix">)</mo></mrow></mfrac><mo>+</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>89</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">r^*(x, y) = \beta \log \frac{\pi^*(y \mid x)}{\pi_{\text{ref}}(y
    \mid x)} + \beta \log Z(x)\qquad{(89)}</annotation></semantics>
- en: 'We then can substitute the reward into the Bradley-Terry equation shown in
    eq.Â [85](ch012.xhtml#eq:bradley_terry_dpo) to obtain:'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬å¯ä»¥å°†å¥–åŠ±ä»£å…¥åˆ°æ–¹ç¨‹å¼[85](ch012.xhtml#eq:bradley_terry_dpo)ä¸­æ‰€ç¤ºçš„Bradley-Terryæ–¹ç¨‹ï¼Œä»¥è·å¾—ï¼š
- en: <semantics><mrow><msup><mi>p</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>â‰»</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>+</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>+</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>+</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mrow><mo stretchy="false"
    form="prefix">(</mo><mn>90</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">p^*(y_1 \succ y_2 \mid x) = \frac{\exp\left(\beta
    \log \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1 \mid x)} + \beta \log Z(x)\right)}
    {\exp\left(\beta \log \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1 \mid x)} +
    \beta \log Z(x)\right) + \exp\left(\beta \log \frac{\pi^*(y_2 \mid x)}{\pi_{\text{ref}}(y_2
    \mid x)} + \beta \log Z(x)\right)} \qquad{(90)}</annotation></semantics>
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: 'By decomposing the exponential expressions from <semantics><msup><mi>e</mi><mrow><mi>a</mi><mo>+</mo><mi>b</mi></mrow></msup><annotation
    encoding="application/x-tex">e^{a+b}</annotation></semantics> to <semantics><mrow><msup><mi>e</mi><mi>a</mi></msup><msup><mi>e</mi><mi>b</mi></msup></mrow><annotation
    encoding="application/x-tex">e^a e^b</annotation></semantics> and then cancelling
    out the terms <semantics><msup><mi>e</mi><mrow><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo
    stretchy="false" form="prefix">(</mo><mi>Z</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow></msup><annotation
    encoding="application/x-tex">e^{\log(Z(x))}</annotation></semantics>, this simplifies
    to:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: é€šè¿‡å°†æŒ‡æ•°è¡¨è¾¾å¼ä» <semantics><msup><mi>e</mi><mrow><mi>a</mi><mo>+</mo><mi>b</mi></mrow></msup><annotation
    encoding="application/x-tex">e^{a+b}</annotation></semantics> åˆ†è§£ä¸º <semantics><mrow><msup><mi>e</mi><mi>a</mi></msup><msup><mi>e</mi><mi>b</mi></msup></mrow><annotation
    encoding="application/x-tex">e^a e^b</annotation></semantics>ï¼Œç„¶åæ¶ˆå»é¡¹ <semantics><msup><mi>e</mi><mrow><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>Z</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="false" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">e^{\log(Z(x))}</annotation></semantics>ï¼Œè¿™ç®€åŒ–ä¸ºï¼š
- en: <semantics><mrow><msup><mi>p</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>â‰»</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>91</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">p^*(y_1 \succ y_2 \mid x) = \frac{\exp\left(\beta
    \log \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1 \mid x)}\right)} {\exp\left(\beta
    \log \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1 \mid x)}\right) + \exp\left(\beta
    \log \frac{\pi^*(y_2 \mid x)}{\pi_{\text{ref}}(y_2 \mid x)}\right)} \qquad{(91)}</annotation></semantics>
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: 'Then, multiply the numerator and denominator by <semantics><mrow><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>âˆ’</mi><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">\exp\left(-\beta \log \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1
    \mid x)}\right)</annotation></semantics> to obtain:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åï¼Œå°†åˆ†å­å’Œåˆ†æ¯ä¹˜ä»¥ `<semantics><mrow><mrow><mi mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>âˆ’</mi><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">\exp\left(-\beta \log \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1
    \mid x)}\right)</annotation></semantics>` ä»¥è·å¾—ï¼š
- en: <semantics><mrow><msup><mi>p</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>â‰»</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>92</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">p^*(y_1 \succ y_2 \mid x) = \frac{1}{1 + \exp\left(\beta
    \log \frac{\pi^*(y_2 \mid x)}{\pi_{\text{ref}}(y_2 \mid x)} - \beta \log \frac{\pi^*(y_1
    \mid x)}{\pi_{\text{ref}}(y_1 \mid x)}\right)} \qquad{(92)}</annotation></semantics>
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '`<semantics><mrow><msup><mi>p</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>â‰»</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><mrow><mi
    mathvariant="normal">exp</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y'
- en: 'Finally, with the definition of a sigmoid function as <semantics><mrow><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mi>âˆ’</mi><mi>x</mi></mrow></msup></mrow></mfrac></mrow><annotation
    encoding="application/x-tex">\sigma(x) = \frac{1}{1+e^{-x}}</annotation></semantics>,
    we obtain:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€åï¼Œæ ¹æ®sigmoidå‡½æ•°çš„å®šä¹‰ <semantics><mrow><mi>Ïƒ</mi><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mi>âˆ’</mi><mi>x</mi></mrow></msup></mrow></mfrac></mrow><annotation
    encoding="application/x-tex">\sigma(x) = \frac{1}{1+e^{-x}}</annotation></semantics>ï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š
- en: <semantics><mrow><msup><mi>p</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>â‰»</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Ïƒ</mi><mrow><mo stretchy="true"
    form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>93</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">p^*(y_1 \succ y_2 \mid x) = \sigma\left(\beta \log
    \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1 \mid x)} - \beta \log \frac{\pi^*(y_2
    \mid x)}{\pi_{\text{ref}}(y_2 \mid x)}\right) \qquad{(93)}</annotation></semantics>
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><msup><mi>p</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>â‰»</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Ïƒ</mi><mrow><mo stretchy="true"
    form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msup><mi>Ï€</mi><mo>*</mo></msup><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext mathvariant="normal">ref</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>âˆ£</mo><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>93</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">p^*(y_1 \succ y_2 \mid x) = \sigma\left(\beta \log
    \frac{\pi^*(y_1 \mid x)}{\pi_{\text{ref}}(y_1 \mid x)} - \beta \log \frac{\pi^*(y_2
    \mid x)}{\pi_{\text{ref}}(y_2 \mid x)}\right) \qquad{(93)}</annotation></semantics>
- en: This is the loss function for DPO, as shown in eq.Â [69](ch012.xhtml#eq:dpo_core).
    The DPO paper has an additional derivation for the objective under a Plackett-Luce
    Model, which is far less used in practice [[20]](ch021.xhtml#ref-rafailov2024direct).
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å°±æ˜¯DPOçš„æŸå¤±å‡½æ•°ï¼Œå¦‚æ–¹ç¨‹[69](ch012.xhtml#eq:dpo_core)æ‰€ç¤ºã€‚DPOè®ºæ–‡åœ¨Plackett-Luceæ¨¡å‹ä¸‹å¯¹ç›®æ ‡å‡½æ•°çš„æ¨å¯¼æœ‰é¢å¤–çš„è¯´æ˜ï¼Œè¿™åœ¨å®è·µä¸­è¿œä¸å¦‚å…¶ä»–æ–¹æ³•å¸¸ç”¨
    [[20]](ch021.xhtml#ref-rafailov2024direct)ã€‚
- en: 3\. Deriving the Bradley Terry DPO Gradient
  id: totrans-76
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 3. æ¨å¯¼Bradley-Terry DPOæ¢¯åº¦
- en: We used the DPO gradient shown in eq.Â [71](ch012.xhtml#eq:dpo_gradient) to explain
    intuitions for how the model learns. To derive this, we must take the gradient
    of eq.Â [93](ch012.xhtml#eq:dpo_loss_deriv3) with respect to the model parameters.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ä½¿ç”¨äº†æ–¹ç¨‹[71](ch012.xhtml#eq:dpo_gradient)ä¸­æ˜¾ç¤ºçš„DPOæ¢¯åº¦æ¥è§£é‡Šæ¨¡å‹å­¦ä¹ æ—¶çš„ç›´è§‰ã€‚ä¸ºäº†æ¨å¯¼è¿™ä¸ªæ¢¯åº¦ï¼Œæˆ‘ä»¬å¿…é¡»å¯¹æ–¹ç¨‹[93](ch012.xhtml#eq:dpo_loss_deriv3)å…³äºæ¨¡å‹å‚æ•°æ±‚å¯¼ã€‚
- en: <semantics><mrow><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><msub><mi>â„’</mi><mtext mathvariant="normal">DPO</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo>;</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><msub><mi>ğ”¼</mi><mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi mathvariant="normal">log</mi><mi>Ïƒ</mi><mrow><mo
    stretchy="true" form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo
    stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>94</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow><annotation
    encoding="application/x-tex">\nabla_{\theta}\mathcal{L}_{\text{DPO}}(\pi_{\theta};
    \pi_{\text{ref}}) = -\nabla_{\theta}\mathbb{E}_{(x,y_c,y_r)\sim\mathcal{D}}\left[
    \log \sigma\left(\beta \log \frac{\pi_{\theta}(y_c|x)}{\pi_{\text{ref}}(y_c|x)}
    - \beta \log \frac{\pi_{\theta}(y_r|x)}{\pi_{\text{ref}}(y_r|x)}\right)\right]
    \qquad{(94)}</annotation></semantics>
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: To start, this can be rewritten. We know that the derivative of a sigmoid function
    <semantics><mrow><mfrac><mi>d</mi><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="false" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><mi>Ïƒ</mi><mo stretchy="false"
    form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\frac{d}{dx}
    \sigma(x) = \sigma(x)(1-\sigma(x))</annotation></semantics>, the derivative of
    logarithm <semantics><mrow><mfrac><mi>d</mi><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>x</mi><mo>=</mo><mfrac><mn>1</mn><mi>x</mi></mfrac></mrow><annotation
    encoding="application/x-tex">\frac{d}{dx} \log x = \frac{1}{x}</annotation></semantics>,
    and properties of sigmoid <semantics><mrow><mi>Ïƒ</mi><mo stretchy="false" form="prefix">(</mo><mi>âˆ’</mi><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mn>1</mn><mo>âˆ’</mo><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">\sigma(-x)=1-\sigma(x)</annotation></semantics>,
    so we can reformat the above equation.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°ç¼–å†™ã€‚æˆ‘ä»¬çŸ¥é“sigmoidå‡½æ•°çš„å¯¼æ•° <semantics><mrow><mfrac><mi>d</mi><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="false" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><mi>Ïƒ</mi><mo stretchy="false"
    form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false"
    form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\frac{d}{dx}
    \sigma(x) = \sigma(x)(1-\sigma(x))</annotation></semantics>ï¼Œå¯¹æ•°å‡½æ•°çš„å¯¼æ•° <semantics><mrow><mfrac><mi>d</mi><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mi>x</mi><mo>=</mo><mfrac><mn>1</mn><mi>x</mi></mfrac></mrow><annotation
    encoding="application/x-tex">\frac{d}{dx} \log x = \frac{1}{x}</annotation></semantics>ï¼Œä»¥åŠsigmoidå‡½æ•°çš„æ€§è´¨
    <semantics><mrow><mi>Ïƒ</mi><mo stretchy="false" form="prefix">(</mo><mi>âˆ’</mi><mi>x</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mn>1</mn><mo>âˆ’</mo><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation
    encoding="application/x-tex">\sigma(-x)=1-\sigma(x)</annotation></semantics>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é‡æ–°æ ¼å¼åŒ–ä¸Šè¿°æ–¹ç¨‹ã€‚
- en: First, let <semantics><mrow><mi>u</mi><mo>=</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac></mrow><annotation
    encoding="application/x-tex">u=\beta \log \frac{\pi_{\theta}(y_c|x)}{\pi_{\text{ref}}(y_c|x)}
    - \beta \log \frac{\pi_{\theta}(y_r|x)}{\pi_{\text{ref}}(y_r|x)}</annotation></semantics>
    (the expression inside the sigmoid). Then, we have
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: é¦–å…ˆï¼Œè®¾ <semantics><mrow><mi>u</mi><mo>=</mo><mi>Î²</mi><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac></mrow><annotation
    encoding="application/x-tex">u=\beta \log \frac{\pi_{\theta}(y_c|x)}{\pi_{\text{ref}}(y_c|x)}
    - \beta \log \frac{\pi_{\theta}(y_r|x)}{\pi_{\text{ref}}(y_r|x)}</annotation></semantics>ï¼ˆsigmoidå‡½æ•°å†…çš„è¡¨è¾¾å¼ï¼‰ã€‚ç„¶åï¼Œæˆ‘ä»¬æœ‰
- en: <semantics><mrow><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><msub><mi>â„’</mi><mtext mathvariant="normal">DPO</mtext></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo>;</mo><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mo
    stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mfrac><mrow><msup><mi>Ïƒ</mi><mo>â€²</mo></msup><mo
    stretchy="false" form="prefix">(</mo><mi>u</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><mi>Ïƒ</mi><mo
    stretchy="false" form="prefix">(</mo><mi>u</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi>u</mi><mo
    stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="false" form="prefix">(</mo><mn>95</mn><mo
    stretchy="false" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\nabla_{\theta}\mathcal{L}_{\text{DPO}}(\pi_{\theta};\pi_{\text{ref}})
    = -\mathbb{E}_{(x, y_c, y_r)\sim \mathcal{D}}\left[\frac{\sigma'(u)}{\sigma(u)}\nabla_{\theta}u\right]
    \qquad{(95)}</annotation></semantics>
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: 'Expanding this and using the above expressions for sigmoid and logarithms results
    in the gradient introduced earlier:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: <semantics><mrow><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi>Î²</mi><mi>Ïƒ</mi><mrow><mo stretchy="true"
    form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi
    mathvariant="normal">log</mi><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi
    mathvariant="normal">log</mi><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>96</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">-\mathbb{E}_{(x,y_c,y_r)\sim\mathcal{D}}\left[\beta\sigma\left(\beta\log\frac{\pi_{\theta}(y_r|x)}{\pi_{\text{ref}}(y_r|x)}
    - \beta\log\frac{\pi_{\theta}(y_c|x)}{\pi_{\text{ref}}(y_c|x)}\right)\left[\nabla_{\theta}\log\pi(y_c|x)-\nabla_{\theta}\log\pi(y_r|x)\right]\right]
    \qquad{(96)}</annotation></semantics>
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: <semantics><mrow><mi>âˆ’</mi><msub><mi>ğ”¼</mi><mrow><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo>,</mo><msub><mi>y</mi><mi>c</mi></msub><mo>,</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="postfix">)</mo><mo>âˆ¼</mo><mi>ğ’Ÿ</mi></mrow></msub><mrow><mo
    stretchy="true" form="prefix">[</mo><mi>Î²</mi><mi>Ïƒ</mi><mrow><mo stretchy="true"
    form="prefix">(</mo><mi>Î²</mi><mi mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo>âˆ’</mo><mi>Î²</mi><mi
    mathvariant="normal">log</mi><mfrac><mrow><msub><mi>Ï€</mi><mi>Î¸</mi></msub><mo
    stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo stretchy="false"
    form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>Ï€</mi><mtext
    mathvariant="normal">ref</mtext></msub><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac><mo
    stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi
    mathvariant="normal">log</mi><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>c</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>âˆ’</mo><msub><mi>âˆ‡</mi><mi>Î¸</mi></msub><mi
    mathvariant="normal">log</mi><mi>Ï€</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>y</mi><mi>r</mi></msub><mo
    stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo
    stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo
    stretchy="false" form="prefix">(</mo><mn>96</mn><mo stretchy="false" form="postfix">)</mo></mrow></mrow>
    <annotation encoding="application/x-tex">-\mathbb{E}_{(x,y_c,y_r)\sim\mathcal{D}}\left[\beta\sigma\left(\beta\log\frac{\pi_{\theta}(y_r|x)}{\pi_{\text{ref}}(y_r|x)}
    - \beta\log\frac{\pi_{\theta}(y_c|x)}{\pi_{\text{ref}}(y_c|x)}\right)\left[\nabla_{\theta}\log\pi(y_c|x)-\nabla_{\theta}\log\pi(y_r|x)\right]\right]
    \qquad{(96)}</annotation></semantics>
- en: Numerical Concerns, Weaknesses, and Alternatives
  id: totrans-84
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æ•°å€¼é—®é¢˜ã€å¼±ç‚¹åŠæ›¿ä»£æ–¹æ¡ˆ
- en: Many variants of the DPO algorithm have been proposed to address weaknesses
    of DPO. For example, without rollouts where a reward model can rate generations,
    DPO treats every pair of preference data with equal weight. In reality, as seen
    in Chapter 6 on Preference Data, there are many ways of capturing preference data
    with a richer label than binary. Multiple algorithms have been proposed to re-balance
    the optimization away from treating each pair equally.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: å·²ç»æå‡ºäº†è®¸å¤šDPOç®—æ³•çš„å˜ä½“æ¥è§£å†³DPOçš„å¼±ç‚¹ã€‚ä¾‹å¦‚ï¼Œåœ¨æ²¡æœ‰å¥–åŠ±æ¨¡å‹å¯ä»¥è¯„ä¼°ç”Ÿæˆçš„rolloutsçš„æƒ…å†µä¸‹ï¼ŒDPOä»¥å¹³ç­‰æƒé‡å¤„ç†æ¯å¯¹åå¥½æ•°æ®ã€‚åœ¨ç°å®ä¸­ï¼Œæ­£å¦‚ç¬¬6ç« ä¸­å…³äºåå¥½æ•°æ®çš„è®¨è®ºæ‰€ç¤ºï¼Œæœ‰è®¸å¤šæ–¹æ³•å¯ä»¥æ•è·æ¯”äºŒå…ƒæ ‡ç­¾æ›´ä¸°å¯Œçš„åå¥½æ•°æ®ã€‚å·²ç»æå‡ºäº†å¤šä¸ªç®—æ³•æ¥é‡æ–°å¹³è¡¡ä¼˜åŒ–ï¼Œä½¿å…¶ä¸å†å¹³ç­‰å¯¹å¾…æ¯ä¸€å¯¹ã€‚
- en: '**REgression to RElative REward Based RL (REBEL)** adds signal from a reward
    model, as a margin between chosen and rejected responses, rather than solely the
    pairwise preference data to more accurately solve the RLHF problem [[166]](ch021.xhtml#ref-gao2024rebel).'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**å›å½’åˆ°ç›¸å¯¹å¥–åŠ±çš„å¼ºåŒ–å­¦ä¹ ï¼ˆREBELï¼‰** é€šè¿‡å°†å¥–åŠ±æ¨¡å‹çš„ä¿¡å·ä½œä¸ºæ‰€é€‰å’Œè¢«æ‹’ç»å“åº”ä¹‹é—´çš„è¾¹ç¼˜æ·»åŠ ï¼Œè€Œä¸æ˜¯ä»…ä½¿ç”¨æˆå¯¹åå¥½æ•°æ®ï¼Œä»¥æ›´ç²¾ç¡®åœ°è§£å†³RLHFé—®é¢˜
    [[166]](ch021.xhtml#ref-gao2024rebel)ã€‚'
- en: '**Conservative DPO (cDPO) and Identity Preference Optimization (IPO)** address
    the overfitting by assuming noise in the preference data. cDPO assumes N percent
    of the data is incorrectly labelled [[20]](ch021.xhtml#ref-rafailov2024direct)
    and IPO changes the optimization to soften probability of preference rather than
    optimize directly from a label [[211]](ch021.xhtml#ref-azar2024general). Practically,
    IPO changes the preference probability to a nonlinear function, moving away from
    the Bradley-Terry assumption, with <semantics><mrow><mi mathvariant="normal">Î¨</mi><mo
    stretchy="false" form="prefix">(</mo><mi>q</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi
    mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mi>q</mi><mrow><mn>1</mn><mo>âˆ’</mo><mi>q</mi></mrow></mfrac><mo
    stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\Psi(q)
    = \log\left(\frac{q}{1-q}\right)</annotation></semantics>.'
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**ä¿å®ˆDPOï¼ˆcDPOï¼‰å’Œèº«ä»½åå¥½ä¼˜åŒ–ï¼ˆIPOï¼‰** é€šè¿‡å‡è®¾åå¥½æ•°æ®ä¸­çš„å™ªå£°æ¥è§£å†³è¿‡æ‹Ÿåˆé—®é¢˜ã€‚cDPOå‡è®¾N%çš„æ•°æ®è¢«é”™è¯¯æ ‡è®° [[20]](ch021.xhtml#ref-rafailov2024direct)ï¼Œè€ŒIPOé€šè¿‡å°†åå¥½æ¦‚ç‡çš„ä¼˜åŒ–æ”¹ä¸ºè½¯åŒ–æ¦‚ç‡è€Œä¸æ˜¯ç›´æ¥ä»æ ‡ç­¾ä¼˜åŒ–ï¼Œæ¥æ”¹å˜ä¼˜åŒ–æ–¹å¼
    [[211]](ch021.xhtml#ref-azar2024general)ã€‚å®é™…ä¸Šï¼ŒIPOå°†åå¥½æ¦‚ç‡è½¬æ¢ä¸ºéçº¿æ€§å‡½æ•°ï¼Œè¿œç¦»Bradley-Terryå‡è®¾ï¼Œå…¶ä¸­
    <semantics><mrow><mi mathvariant="normal">Î¨</mi><mo stretchy="false" form="prefix">(</mo><mi>q</mi><mo
    stretchy="false" form="postfix">)</mo><mo>=</mo><mrow><mi mathvariant="normal">log</mi><mo>â¡</mo></mrow><mrow><mo
    stretchy="true" form="prefix">(</mo><mfrac><mi>q</mi><mrow><mn>1</mn><mo>âˆ’</mo><mi>q</mi></mrow></mfrac><mo
    stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\Psi(q)
    = \log\left(\frac{q}{1-q}\right)</annotation></semantics>ã€‚'
- en: '**DPO with an offset (ODPO)** â€œrequires the difference between the likelihood
    of the preferred and dispreferred response to be greater than an offset valueâ€
    [[212]](ch021.xhtml#ref-amini2024direct) â€“ do not treat every data pair equally,
    but this can come at the cost of a more difficult labeling environment.'
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**å¸¦åç§»çš„DPOï¼ˆODPOï¼‰** â€œè¦æ±‚é¦–é€‰å’Œæ¬¡é€‰å“åº”ä¹‹é—´çš„ä¼¼ç„¶å·®å¼‚å¤§äºåç§»å€¼â€ [[212]](ch021.xhtml#ref-amini2024direct)
    â€“ ä¸è¦å¹³ç­‰å¯¹å¾…æ¯ä¸ªæ•°æ®å¯¹ï¼Œä½†è¿™å¯èƒ½ä¼šä»¥æ›´å›°éš¾çš„æ ‡è®°ç¯å¢ƒä¸ºä»£ä»·ã€‚'
- en: Some variants to DPO attempt to either improve the learning signal by making
    small changes to the loss or make the application more efficient by reducing memory
    usage.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€äº›DPOçš„å˜ä½“è¯•å›¾é€šè¿‡å¾®å°åœ°æ”¹å˜æŸå¤±æˆ–é€šè¿‡å‡å°‘å†…å­˜ä½¿ç”¨æ¥æé«˜åº”ç”¨æ•ˆç‡ï¼Œä»¥æ”¹å–„å­¦ä¹ ä¿¡å·ã€‚
- en: '**Odds Ratio Policy Optimization (ORPO)** directly updates the policy model
    with a pull towards the chosen response, similar to the instruction finetuning
    loss, with a small penalty on the chosen response [[213]](ch021.xhtml#ref-hong2024reference).
    This change of loss function removes the need for a reference model, simplifying
    the setup. The best way to view ORPO is DPO inspired, rather than a DPO derivative.'
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**å¥‡å¶æ¯”ç­–ç•¥ä¼˜åŒ–ï¼ˆORPOï¼‰** ç›´æ¥é€šè¿‡å‘æ‰€é€‰å“åº”çš„æ‹‰åŠ›æ¥æ›´æ–°ç­–ç•¥æ¨¡å‹ï¼Œç±»ä¼¼äºæŒ‡ä»¤å¾®è°ƒæŸå¤±ï¼Œå¯¹æ‰€é€‰å“åº”æ–½åŠ å°æƒ©ç½š [[213]](ch021.xhtml#ref-hong2024reference)ã€‚è¿™ç§æŸå¤±å‡½æ•°çš„æ”¹å˜æ¶ˆé™¤äº†å¯¹å‚è€ƒæ¨¡å‹çš„éœ€æ±‚ï¼Œç®€åŒ–äº†è®¾ç½®ã€‚ORPOçš„æœ€ä½³çœ‹æ³•æ˜¯å—DPOå¯å‘ï¼Œè€Œä¸æ˜¯DPOçš„è¡ç”Ÿç‰©ã€‚'
- en: '**Simple Preference Optimization SimPO** makes a minor change to the DPO optimization,
    by averaging the log-probabilities rather than summing them (SimPO) or adding
    length normalization, to improve performance [[214]](ch021.xhtml#ref-meng2025simpo).'
  id: totrans-91
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**ç®€å•åå¥½ä¼˜åŒ–SimPO** å¯¹DPOä¼˜åŒ–è¿›è¡Œäº†å¾®å°è°ƒæ•´ï¼Œé€šè¿‡å¹³å‡å¯¹æ•°æ¦‚ç‡è€Œä¸æ˜¯æ±‚å’Œï¼ˆSimPOï¼‰æˆ–æ·»åŠ é•¿åº¦å½’ä¸€åŒ–ï¼Œä»¥æé«˜æ€§èƒ½ [[214]](ch021.xhtml#ref-meng2025simpo)ã€‚'
- en: '![Figure 19: Sketch of preference displacement in DPO.](../media/file17.png)'
  id: totrans-92
  prefs: []
  type: TYPE_IMG
  zh: '![å›¾19ï¼šDPOä¸­åå¥½ä½ç§»çš„è‰å›¾ã€‚](../media/file17.png)'
- en: 'Figure 19: Sketch of preference displacement in DPO.'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: å›¾19ï¼šDPOä¸­åå¥½ä½ç§»çš„è‰å›¾ã€‚
- en: One of the core issues *apparent* in DPO is that the optimization drives only
    to increase the margin between the probability of the chosen and rejected responses.
    Numerically, the model reduces the probability of both the chosen and rejected
    responses, but the *rejected response is reduced by a greater extent* as shown
    in fig.Â [19](#fig:dpo_issue). Intuitively, it is not clear how this generalizes,
    but work has posited that it increases the probability of unaddressed for behaviors
    â€“ i.e.Â tokens that language model could generate, but are not in the distribution
    of the post-training datasets [[215]](ch021.xhtml#ref-razin2024unintentional)
    [[216]](ch021.xhtml#ref-ren2024learning). Simple methodsâ€”such as Cal-DPO [[217]](ch021.xhtml#ref-xiao2024cal),
    which adjusts the optimization process, and AlphaPO [[218]](ch021.xhtml#ref-gupta2025alphapo),
    which modifies the reward shapeâ€”mitigate this **preference displacement**. In
    practice, the exact impact of this is not well known, but points to a potential
    reason why online methods can outperform vanilla DPO.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: DPOçš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜*æ˜æ˜¾*åœ¨äºï¼Œä¼˜åŒ–è¿‡ç¨‹ä»…é©±åŠ¨å¢åŠ æ‰€é€‰å’Œæ‹’ç»å“åº”ä¹‹é—´çš„æ¦‚ç‡å·®è·ã€‚ä»æ•°å€¼ä¸Šçœ‹ï¼Œæ¨¡å‹é™ä½äº†æ‰€é€‰å’Œæ‹’ç»å“åº”çš„æ¦‚ç‡ï¼Œä½†å¦‚å›¾[19](#fig:dpo_issue)æ‰€ç¤ºï¼Œ*æ‹’ç»å“åº”çš„é™ä½ç¨‹åº¦æ›´å¤§*ã€‚ç›´è§‚ä¸Šï¼Œä¸æ¸…æ¥šè¿™å¦‚ä½•æ³›åŒ–ï¼Œä½†å·²æœ‰ç ”ç©¶æå‡ºï¼Œè¿™å¢åŠ äº†æœªè§£å†³è¡Œä¸ºï¼ˆå³è¯­è¨€æ¨¡å‹å¯ä»¥ç”Ÿæˆä½†ä¸åœ¨è®­ç»ƒåæ•°æ®é›†åˆ†å¸ƒä¸­çš„æ ‡è®°ï¼‰çš„æ¦‚ç‡
    [[215]](ch021.xhtml#ref-razin2024unintentional) [[216]](ch021.xhtml#ref-ren2024learning)ã€‚ç®€å•çš„æ–¹æ³•â€”â€”å¦‚Cal-DPO
    [[217]](ch021.xhtml#ref-xiao2024cal)ï¼Œå®ƒè°ƒæ•´ä¼˜åŒ–è¿‡ç¨‹ï¼Œä»¥åŠAlphaPO [[218]](ch021.xhtml#ref-gupta2025alphapo)ï¼Œå®ƒä¿®æ”¹å¥–åŠ±å½¢çŠ¶â€”â€”å¯ä»¥å‡è½»è¿™ç§**åå¥½ä½ç§»**ã€‚åœ¨å®è·µä¸­ï¼Œè¿™ç§å½±å“çš„ç²¾ç¡®ç¨‹åº¦å°šä¸æ¸…æ¥šï¼Œä½†æŒ‡å‘äº†åœ¨çº¿æ–¹æ³•å¯èƒ½ä¼˜äºä¼ ç»ŸDPOçš„ä¸€ä¸ªæ½œåœ¨åŸå› ã€‚
- en: The largest other reason that is posited for DPO-like methods to have a lower
    ceiling on performance than online (RL based) RLHF methods is that the training
    signal comes from completions from previous or other models. Online variants of
    DPO alleviate these limitations by generating new completions and incorporating
    a preference signal at training time. **Online DPO** [[219]](ch021.xhtml#ref-guo2024direct)
    samples generations from the current model, while **Discriminator-Guided DPO**
    (D2PO) [[220]](ch021.xhtml#ref-singhal2024d2po) uses reward model relabelling
    to create new preference data on the fly, and many more variants exist.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€å¤§çš„å…¶ä»–åŸå› æ˜¯ï¼Œä¸åŸºäºåœ¨çº¿ï¼ˆåŸºäºå¼ºåŒ–å­¦ä¹ ï¼‰çš„RLHFæ–¹æ³•ç›¸æ¯”ï¼ŒDPO-likeæ–¹æ³•åœ¨æ€§èƒ½ä¸Šå­˜åœ¨è¾ƒä½çš„ä¸Šé™ï¼Œè¿™æ˜¯å› ä¸ºè®­ç»ƒä¿¡å·æ¥è‡ªå…ˆå‰æˆ–å…¶ä»–æ¨¡å‹çš„å®Œæˆã€‚DPOçš„åœ¨çº¿å˜ä½“é€šè¿‡ç”Ÿæˆæ–°çš„å®Œæˆå¹¶åœ¨è®­ç»ƒæ—¶å¼•å…¥åå¥½ä¿¡å·æ¥ç¼“è§£è¿™äº›é™åˆ¶ã€‚**åœ¨çº¿DPO**
    [[219]](ch021.xhtml#ref-guo2024direct) ä»å½“å‰æ¨¡å‹ä¸­é‡‡æ ·ç”Ÿæˆï¼Œè€Œ**åˆ¤åˆ«å™¨å¼•å¯¼çš„DPO** (D2PO) [[220]](ch021.xhtml#ref-singhal2024d2po)
    é€šè¿‡å¥–åŠ±æ¨¡å‹é‡æ ‡è®°å®æ—¶åˆ›å»ºæ–°çš„åå¥½æ•°æ®ï¼Œå¹¶ä¸”å­˜åœ¨è®¸å¤šå…¶ä»–å˜ä½“ã€‚
- en: There is a long list of other DAA variants, such as Direct Nash Optimization
    (DNO) [[221]](ch021.xhtml#ref-rosset2024direct) or Binary Classifier Optimization
    (BCO) [[222]](ch021.xhtml#ref-jung2024binary), but the choice of algorithm is
    far less important than the initial model and the data used [[6]](ch021.xhtml#ref-lambert2024t)
    [[223]](ch021.xhtml#ref-zhao2024rainbowpo) [[224]](ch021.xhtml#ref-gorbatovski2025differences).
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: è¿˜æœ‰å…¶ä»–è®¸å¤šDAAå˜ä½“ï¼Œå¦‚ç›´æ¥çº³ä»€ä¼˜åŒ–ï¼ˆDNOï¼‰ [[221]](ch021.xhtml#ref-rosset2024direct) æˆ–äºŒåˆ†ç±»å™¨ä¼˜åŒ–ï¼ˆBCOï¼‰
    [[222]](ch021.xhtml#ref-jung2024binary)ï¼Œä½†ç®—æ³•çš„é€‰æ‹©è¿œä¸å¦‚åˆå§‹æ¨¡å‹å’Œæ‰€ä½¿ç”¨çš„æ•°æ®é‡è¦ [[6]](ch021.xhtml#ref-lambert2024t)
    [[223]](ch021.xhtml#ref-zhao2024rainbowpo) [[224]](ch021.xhtml#ref-gorbatovski2025differences)ã€‚
- en: Implementation Considerations
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å®ç°è€ƒè™‘
- en: 'DAAs such as DPO are implemented very differently than policy gradient optimizers.
    The DPO loss, taken from the original implementation, largely can be summarized
    as follows [[20]](ch021.xhtml#ref-rafailov2024direct):'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ç­–ç•¥æ¢¯åº¦ä¼˜åŒ–å™¨ç›¸æ¯”ï¼ŒDAAï¼ˆå¦‚DPOï¼‰çš„å®ç°æ–¹å¼å¤§ç›¸å¾„åº­ã€‚DPOæŸå¤±ï¼Œä»åŸå§‹å®ç°ä¸­æå–ï¼Œå¤§è‡´å¯ä»¥æ€»ç»“å¦‚ä¸‹ [[20]](ch021.xhtml#ref-rafailov2024direct)ï¼š
- en: '[PRE0]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This can be used in standard language model training stacks as this information
    is already collated during the forward pass of a model (with the addition of a
    reference model).
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å¯ä»¥åœ¨æ ‡å‡†çš„è¯­è¨€æ¨¡å‹è®­ç»ƒå †æ ˆä¸­ä½¿ç”¨ï¼Œå› ä¸ºè¿™ç§ä¿¡æ¯å·²ç»åœ¨æ¨¡å‹çš„æ­£å‘ä¼ é€’è¿‡ç¨‹ä¸­æ”¶é›†ï¼ˆæ·»åŠ ä¸€ä¸ªå‚è€ƒæ¨¡å‹ï¼‰ã€‚
- en: In most ways, this is simpler and a quality of life improvement, but also they
    offer a different set of considerations.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å¤§å¤šæ•°æ–¹é¢ï¼Œè¿™æ›´ç®€å•ï¼Œä¹Ÿæ˜¯ç”Ÿæ´»è´¨é‡çš„æå‡ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€ç»„ä¸åŒçš„è€ƒè™‘å› ç´ ã€‚
- en: '**KL distance is static**: In DPO and other algorithms, the KL distance is
    set explicitly by the <semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>
    parameter that balances the distance penalty to the optimization. This is due
    to the fact that DPO takes gradient steps towards the *optimal* solution to the
    RLHF objective given the data â€“ it steps exactly to the solution set by the <semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics> term. On the other
    hand, RL based optimizers take steps based on the batch and recent data.'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**KLè·ç¦»æ˜¯é™æ€çš„**ï¼šåœ¨DPOå’Œå…¶ä»–ç®—æ³•ä¸­ï¼ŒKLè·ç¦»æ˜¯é€šè¿‡<semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics>å‚æ•°æ˜¾å¼è®¾ç½®çš„ï¼Œè¯¥å‚æ•°å¹³è¡¡äº†è·ç¦»æƒ©ç½šå¯¹ä¼˜åŒ–çš„å½±å“ã€‚è¿™æ˜¯å› ä¸ºDPOæ ¹æ®æ•°æ®å‘RLHFç›®æ ‡çš„æœ€ä¼˜è§£è¿›è¡Œæ¢¯åº¦æ­¥éª¤â€”â€”å®ƒç²¾ç¡®åœ°èµ°å‘ç”±<semantics><mi>Î²</mi><annotation
    encoding="application/x-tex">\beta</annotation></semantics>é¡¹è®¾å®šçš„è§£é›†ã€‚å¦ä¸€æ–¹é¢ï¼ŒåŸºäºRLçš„ä¼˜åŒ–å™¨æ ¹æ®æ‰¹é‡å’Œæœ€è¿‘çš„æ•°æ®è¿›è¡Œæ­¥éª¤ã€‚'
- en: '**Caching log-probabilities**: Simple implementations of DPO do the forward
    passes for the policy model and reference models at the same time for conveniences
    with respect to the loss function. Though, this doubles the memory used and results
    in increased GPU usage. To avoid this, one can compute the log-probabilities of
    the reference model over the training dataset first, then reference it when computing
    the loss and updating the parameters per batch, reducing the peak memory usage
    by 50%.'
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**ç¼“å­˜å¯¹æ•°æ¦‚ç‡**ï¼šDPOçš„ç®€å•å®ç°åŒæ—¶è¿›è¡Œç­–ç•¥æ¨¡å‹å’Œå‚è€ƒæ¨¡å‹çš„æ­£å‘ä¼ é€’ï¼Œä»¥æ–¹ä¾¿æŸå¤±å‡½æ•°ã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¿™åŠ å€äº†å†…å­˜çš„ä½¿ç”¨ï¼Œå¹¶å¯¼è‡´GPUä½¿ç”¨å¢åŠ ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥å…ˆè®¡ç®—å‚è€ƒæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®é›†ä¸Šçš„å¯¹æ•°æ¦‚ç‡ï¼Œç„¶ååœ¨è®¡ç®—æŸå¤±å’ŒæŒ‰æ‰¹æ›´æ–°å‚æ•°æ—¶å¼•ç”¨å®ƒï¼Œä»è€Œå°†å³°å€¼å†…å­˜ä½¿ç”¨é‡å‡å°‘50%ã€‚'
- en: 'DAAs vs.Â RL: Online vs.Â Offline Data'
  id: totrans-104
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: DAAsä¸RLï¼šåœ¨çº¿æ•°æ®ä¸ç¦»çº¿æ•°æ®
- en: 'Broadly, the argument boils down to one question: Do we need the inner workings
    of reinforcement learning, with value functions, policy gradients, and all, to
    align language models with RLHF? This, like most questions phrased this way, is
    overly simplistic. Of course, both methods are well-established, but it is important
    to illustrate where the fundamental differences and performance manifolds lie.'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: å¹¿ä¹‰ä¸Šï¼Œè¿™ä¸ªè®ºç‚¹å½’ç»“ä¸ºä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬éœ€è¦å¼ºåŒ–å­¦ä¹ çš„å†…éƒ¨å·¥ä½œåŸç†ï¼ŒåŒ…æ‹¬ä»·å€¼å‡½æ•°ã€ç­–ç•¥æ¢¯åº¦ç­‰ï¼Œæ¥ä½¿è¯­è¨€æ¨¡å‹ä¸RLHFå¯¹é½å—ï¼Ÿè¿™ä¸ªé—®é¢˜ï¼Œå°±åƒå¤§å¤šæ•°ä»¥è¿™ç§æ–¹å¼è¡¨è¿°çš„é—®é¢˜ä¸€æ ·ï¼Œè¿‡äºç®€å•åŒ–ã€‚å½“ç„¶ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯æˆç†Ÿçš„ï¼Œä½†é‡è¦çš„æ˜¯è¦è¯´æ˜å®ƒä»¬ä¹‹é—´çš„åŸºæœ¬å·®å¼‚å’Œæ€§èƒ½å·®å¼‚åœ¨å“ªé‡Œã€‚
- en: Multiple reports have concluded that policy-gradient based and RL methods outperform
    DPO and its variants. The arguments take different forms, from training models
    with different algorithms but controlled data[[190]](ch021.xhtml#ref-ivison2024unpacking)
    [[225]](ch021.xhtml#ref-xu2024dpo) or studying the role of on-policy data within
    the RL optimization loop [[226]](ch021.xhtml#ref-tajwar2024preference). In all
    of these cases, DPO algorithms are a hair behind.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: å¤šä»½æŠ¥å‘Šå¾—å‡ºç»“è®ºï¼ŒåŸºäºç­–ç•¥æ¢¯åº¦å’ŒRLçš„æ–¹æ³•ä¼˜äºDPOåŠå…¶å˜ä½“ã€‚è¿™äº›è®ºç‚¹é‡‡å–äº†ä¸åŒçš„å½¢å¼ï¼Œä»ä½¿ç”¨ä¸åŒç®—æ³•ä½†å—æ§çš„æ•°æ®è®­ç»ƒæ¨¡å‹[[190]](ch021.xhtml#ref-ivison2024unpacking)
    [[225]](ch021.xhtml#ref-xu2024dpo) æˆ–ç ”ç©¶RLä¼˜åŒ–å¾ªç¯ä¸­åœ¨çº¿ç­–ç•¥æ•°æ®çš„ä½œç”¨[[226]](ch021.xhtml#ref-tajwar2024preference)ã€‚åœ¨è¿™äº›æ‰€æœ‰æƒ…å†µä¸‹ï¼ŒDPOç®—æ³•éƒ½ç•¥é€Šä¸€ç­¹ã€‚
- en: Even with this performance delta, DAA are still used extensively in leading
    models due to its simplicity. DAAs provide a controlled environment where iterations
    on training data and other configurations can be made rapidly, and given that
    data is often far more important than algorithms, using DPO can be fine.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: å³ä½¿æœ‰è¿™ç§æ€§èƒ½å·®å¼‚ï¼ŒDAAä»ç„¶åœ¨é¢†å…ˆæ¨¡å‹ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œå› ä¸ºå…¶ç®€å•æ€§ã€‚DAAsæä¾›äº†ä¸€ä¸ªå—æ§çš„ç¯å¢ƒï¼Œå…¶ä¸­å¯ä»¥å¿«é€Ÿå¯¹è®­ç»ƒæ•°æ®å’Œå…¶ä»–é…ç½®è¿›è¡Œè¿­ä»£ï¼Œé‰´äºæ•°æ®é€šå¸¸æ¯”ç®—æ³•æ›´é‡è¦ï¼Œä½¿ç”¨DPOæ˜¯å¯ä»¥æ¥å—çš„ã€‚
- en: With the emergence of reasoning models that are primarily trained with RL, further
    investment will return to using RL for preference-tuning, which in the long-term
    will improve the robustness of RL infrastructure and cement this margin between
    DAAs and RL for optimizing from human feedback.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: éšç€ä»¥RLä¸ºä¸»è¦è®­ç»ƒç›®æ ‡çš„æ¨ç†æ¨¡å‹çš„å…´èµ·ï¼Œè¿›ä¸€æ­¥çš„æŠ•å…¥å°†å›å½’åˆ°ä½¿ç”¨RLè¿›è¡Œåå¥½è°ƒæ•´ï¼Œä»é•¿è¿œæ¥çœ‹ï¼Œè¿™å°†æé«˜RLåŸºç¡€è®¾æ–½çš„é²æ£’æ€§å¹¶å·©å›ºDAAså’ŒRLåœ¨ä»äººç±»åé¦ˆä¸­è¿›è¡Œä¼˜åŒ–ä¹‹é—´çš„å·®è·ã€‚
